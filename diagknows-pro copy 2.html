<!DOCTYPE html>
<html lang="english">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiagKnows - AI Health Assistant</title>
    <style>
        /* CSS Variables for consistent theming */
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            overflow-x: hidden;
            max-width: 100vw;
            position: relative;
        }

        .logo-container {
            position: absolute;
            top: 10px;
            left: 20px;
            z-index: 1000;
        }

        .app-logo {
            width: 60px;
            height: auto;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }

        .app-logo:hover {
            transform: scale(1.05);
        }

        @media (max-width: 600px) {
            .app-logo {
                width: 40px;
            }
        }

        /* Navigation */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            list-style: none;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .nav-links li {
            flex-shrink: 0;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--dark);
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: var(--primary);
        }

        /* Logout button styling to match login button */
        #navLogout {
            color: #dc3545;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        #navLogout:hover {
            color: #c82333;
            text-decoration: underline;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 1rem auto;
            padding: 0 2rem;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 0;
            box-shadow: var(--shadow);
            display: none;
            overflow-x: hidden;
            box-sizing: border-box;
            max-width: 100%;
        }

        .card.active {
            display: block;
            margin-bottom: 1rem;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            max-width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            max-width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            white-space: normal;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-family: inherit;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            background: var(--secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background: #6b7280;
            color: white;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: var(--warning);
            color: #92400e;
        }

        .btn-warning:hover {
            background: #d97706;
            color: white;
        }

        .btn-danger {
            background: #dc2626;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-large {
            padding: 1rem 2rem;
            font-size: 1.125rem;
        }

        .btn-full {
            width: 100%;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-group-stacked {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .btn-group-center {
            justify-content: center;
        }

        .btn-group-right {
            justify-content: flex-end;
        }



        /* Enhanced Chatbot */
        .chat-container {
            height: 500px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            border-radius: var(--radius) var(--radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1rem;
            background: var(--light);
            max-width: 100%;
            box-sizing: border-box;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            animation: fadeInUp 0.3s ease-out;
        }

        .message.bot {
            align-items: flex-start;
        }

        .message.user {
            align-items: flex-end;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .bot-label {
            font-weight: 600;
            color: var(--primary);
        }

        .user-label {
            font-weight: 600;
            color: var(--secondary);
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.6;
        }

        .message-content {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            font-size: 0.95rem;
            word-wrap: break-word;
            line-height: 1.4;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message.bot .message-content {
            background: white;
            border: 1px solid var(--border);
            border-bottom-left-radius: 0.5rem;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary) 0%, #2563eb 100%);
            color: white;
            border-bottom-right-radius: 0.5rem;
        }

        .quick-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
            animation: fadeIn 0.5s ease-out;
        }

        .quick-option-btn {
            background: var(--light);
            border: 1px solid var(--border);
            color: var(--dark);
            padding: 0.5rem 1rem;
            border-radius: 1.5rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .quick-option-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .typing-indicator {
            opacity: 0.7;
        }

        .typing-dots {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: var(--secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Medical Upload Styles */
        .medical-upload-section {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            background: var(--light);
        }

        .upload-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .upload-options .btn {
            flex: 1;
            padding: 0.75rem;
            font-size: 0.9rem;
        }

        .upload-preview {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: white;
            overflow: hidden;
        }

        .preview-header {
            background: var(--primary);
            color: white;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-remove {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem;
        }

        .preview-content {
            padding: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .preview-content img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }

        #cameraVideo {
            width: 100%;
            max-width: 400px;
            border-radius: var(--radius);
            margin: 1rem 0;
        }

        #cameraCanvas {
            display: none;
        }

        /* Dark Mode Medical Upload */
        body.dark-mode .medical-upload-section {
            background: #334155;
            border-color: #64748b;
        }

        body.dark-mode .upload-preview {
            background: #475569;
            border-color: #64748b;
        }

        body.dark-mode .preview-content {
            color: #f1f5f9;
        }

        /* Recommended Items Highlighting */
        .medicine-card.recommended {
            border: 2px solid var(--primary) !important;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3) !important;
            position: relative;
        }

        .medicine-card.recommended::before {
            content: "ðŸ’¡ Recommended";
            position: absolute;
            top: -10px;
            right: 10px;
            background: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 10;
        }

        .recommendations-actions {
            margin-top: 1rem;
            text-align: center;
        }

        .recommendations-actions .btn {
            background: linear-gradient(135deg, var(--primary) 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .recommendations-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        /* Terms & Conditions Styling */
        .terms-content {
            line-height: 1.6;
            color: var(--dark);
        }

        .terms-content h3 {
            color: var(--primary);
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .terms-content h3:first-of-type {
            margin-top: 1rem;
        }

        .terms-content p {
            margin-bottom: 1rem;
        }

        .terms-content ul {
            margin-bottom: 1.5rem;
            padding-left: 1.5rem;
        }

        .terms-content li {
            margin-bottom: 0.5rem;
        }

        .terms-content a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .terms-content a:hover {
            text-decoration: underline;
        }

        /* Dark Mode Terms */
        body.dark-mode .terms-content {
            color: #f1f5f9;
        }

        body.dark-mode .terms-content h3 {
            color: #60a5fa;
        }

        /* Mobile Responsive Terms */
        @media (max-width: 768px) {
            .terms-content {
                font-size: 0.95rem;
            }
            
            .terms-content h3 {
                font-size: 1.1rem;
            }
            
            .terms-content ul {
                padding-left: 1rem;
            }
        }

        /* Feedback System Styling */
        .feedback-prompt {
            background: white;
            border: 1px solid var(--border);
            border-radius: 1.25rem;
            padding: 1rem;
            margin: 1rem 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.3s ease-out;
        }

        .feedback-content h4 {
            margin: 0 0 1rem 0;
            color: var(--dark);
            font-size: 1.1rem;
            text-align: center;
        }

        .feedback-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .feedback-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .feedback-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .feedback-positive:hover {
            border-color: #10b981;
            background: #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .feedback-negative:hover {
            border-color: #ef4444;
            background: #ef4444;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .feedback-comment {
            background: white;
            border: 1px solid var(--border);
            border-radius: 1.25rem;
            padding: 1rem;
            margin: 1rem 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.3s ease-out;
        }

        .comment-content p {
            margin: 0 0 1rem 0;
            color: var(--dark);
            font-size: 0.95rem;
            text-align: center;
        }

        .comment-textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }

        .comment-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .comment-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        /* Dark Mode Feedback */
        body.dark-mode .feedback-prompt,
        body.dark-mode .feedback-comment {
            background: #475569;
            border-color: #64748b;
            color: #f1f5f9;
        }

        body.dark-mode .feedback-content h4,
        body.dark-mode .comment-content p {
            color: #f1f5f9;
        }

        body.dark-mode .comment-textarea {
            background: #334155;
            border-color: #64748b;
            color: #f1f5f9;
        }

        body.dark-mode .comment-textarea:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }

        /* Mobile Responsive Feedback */
        @media (max-width: 768px) {
            .feedback-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .feedback-btn {
                width: 100%;
                max-width: 200px;
            }
            
            .comment-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .comment-buttons .btn {
                width: 100%;
                max-width: 150px;
            }
        }

        /* Mission Section Styling */
        .mission-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 2.5rem 2rem;
            margin: 2rem 0;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .mission-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, #10b981 50%, #f59e0b 100%);
        }

        .mission-section h2 {
            color: var(--dark);
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .mission-section h2::after {
            content: '';
            position: absolute;
            bottom: -0.5rem;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: var(--primary);
            border-radius: 2px;
        }

        .mission-text {
            max-width: 800px;
            margin: 0 auto;
            font-size: 1.1rem;
            line-height: 1.7;
            color: var(--secondary);
            font-weight: 400;
        }

        /* Dark Mode Mission Section */
        body.dark-mode .mission-section {
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
            border-color: #64748b;
        }

        body.dark-mode .mission-section h2 {
            color: #f1f5f9;
        }

        body.dark-mode .mission-text {
            color: #cbd5e1;
        }

        /* Mobile Responsive Mission */
        @media (max-width: 768px) {
            .mission-section {
                padding: 2rem 1.5rem;
                margin: 1.5rem 0;
            }
            
            .mission-section h2 {
                font-size: 1.5rem;
            }
            
            .mission-text {
                font-size: 1rem;
                line-height: 1.6;
            }
        }

        @media (max-width: 480px) {
            .mission-section {
                padding: 1.5rem 1rem;
                margin: 1rem 0;
            }
            
            .mission-section h2 {
                font-size: 1.3rem;
            }
            
            .mission-text {
                font-size: 0.95rem;
            }
        }

        /* Vital Signs Form Styling */
        .vital-signs-form {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 100%;
            overflow: hidden;
        }

        .vital-signs-form .form-header {
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .vital-signs-form .form-header h4 {
            color: var(--dark);
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
        }

        .vital-signs-form .form-header p {
            color: var(--secondary);
            margin: 0;
            font-size: 0.9rem;
        }

        .vital-inputs {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .vital-inputs .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .vital-inputs label {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .vital-inputs input {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.9rem;
            background: white;
            transition: border-color 0.3s;
            width: 100%;
            box-sizing: border-box;
        }

        .vital-inputs input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .vital-inputs input::placeholder {
            color: var(--secondary);
        }

        .vital-inputs .input-hint {
            font-size: 0.8rem;
            color: var(--secondary);
            margin-top: 0.25rem;
            transition: color 0.3s;
        }

        .bp-inputs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
        }

        .bp-inputs input {
            flex: 1;
            min-width: 0;
        }

        .bp-separator {
            font-weight: 600;
            color: var(--dark);
            font-size: 1.1rem;
        }

        .form-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
        }

        .form-actions .btn {
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .form-actions .btn-primary {
            background: var(--primary);
            color: white;
        }

        .form-actions .btn-primary:hover {
            background: #1d4ed8;
        }

        .form-actions .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 1px solid var(--border);
        }

        .form-actions .btn-secondary:hover {
            background: #e5e7eb;
        }

        /* Dark Mode Vital Signs Form */
        body.dark-mode .vital-signs-form {
            background: var(--dark-bg);
            border-color: #374151;
        }

        body.dark-mode .vital-signs-form .form-header h4 {
            color: #f9fafb;
        }

        body.dark-mode .vital-signs-form .form-header p {
            color: #d1d5db;
        }

        body.dark-mode .vital-inputs label {
            color: #f9fafb;
        }

        body.dark-mode .vital-inputs input {
            background: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }

        body.dark-mode .vital-inputs input:focus {
            border-color: var(--primary);
        }

        body.dark-mode .vital-inputs .input-hint {
            color: #d1d5db;
        }

        body.dark-mode .bp-separator {
            color: #f9fafb;
        }

        body.dark-mode .form-actions .btn-secondary {
            background: #374151;
            color: #f9fafb;
            border-color: #4b5563;
        }

        body.dark-mode .form-actions .btn-secondary:hover {
            background: #4b5563;
        }

        /* Mobile Responsive Vital Signs Form */
        @media (max-width: 768px) {
            .vital-signs-form {
                padding: 1rem;
                margin: 0.75rem 0;
            }

            .vital-inputs {
                gap: 0.75rem;
            }

            .vital-inputs input {
                padding: 0.625rem;
                font-size: 0.875rem;
            }

            .form-actions {
                flex-direction: column;
                gap: 0.5rem;
            }

            .form-actions .btn {
                width: 100%;
                padding: 0.875rem;
            }

            .bp-inputs {
                gap: 0.375rem;
            }
        }

        @media (max-width: 480px) {
            .vital-signs-form {
                padding: 0.875rem;
            }

            .vital-signs-form .form-header h4 {
                font-size: 1rem;
            }

            .vital-signs-form .form-header p {
                font-size: 0.8rem;
            }

            .vital-inputs label {
                font-size: 0.8rem;
            }

            .vital-inputs input {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
        }

        .chat-input {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
        }

        .chat-input input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 1rem;
        }

        .chat-input button {
            padding: 0.75rem 1rem;
            border-radius: 20px;
        }

        /* Premium Banner */
        .premium-banner {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 1rem;
            border-radius: var(--radius);
            text-align: center;
            margin-bottom: 1rem;
        }

        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-danger {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: var(--danger);
        }

        .alert-success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: var(--success);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 2rem;
            max-width: 500px;
            margin: 10% auto;
            position: relative;
        }

        .close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .floating-language-selector {
                bottom: 1rem;
                right: 1rem;
                padding: 0.5rem;
            }

            .floating-language-selector select {
                font-size: 0.85rem;
                padding: 0.4rem;
            }
            
            .container {
                padding: 1rem;
                max-width: 100%;
                overflow-x: hidden;
            }
            
            .nav-links {
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
                display: flex !important;
                max-height: 60vh;
                overflow-y: auto;
            }

            .nav-links li {
                width: 100%;
                text-align: center;
            }
            
            .nav-links li {
                width: 100%;
            }
            
            .nav-links a {
                display: block;
                width: 100%;
                text-align: center;
                padding: 0.75rem;
            }

            #navLogout {
                color: #dc3545;
                font-weight: 500;
            }

            #navLogout:hover {
                color: #c82333;
                background-color: rgba(220, 53, 69, 0.1);
            }
            
            .hero-content h1 {
                font-size: 1.8rem;
                line-height: 1.2;
            }
            
            .hero-content p {
                font-size: 0.9rem;
                line-height: 1.4;
            }
            
            .feature-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .chat-container {
                height: 60vh;
                max-height: 400px;
                min-height: 300px;
            }
            
            .chat-messages {
                height: calc(100% - 120px);
                overflow-y: auto;
                padding: 0.5rem;
            }
            
            .chat-input-container {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.5rem;
            }
            
            .chat-input {
                width: 100%;
                max-width: 100%;
                font-size: 0.9rem;
            }
            
            .send-btn,
            .voice-btn {
                width: 100%;
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            
            .symptom-options {
                grid-template-columns: 1fr;
                gap: 0.5rem;
                max-height: 200px;
                overflow-y: auto;
            }
            
            .symptom-option {
                padding: 0.75rem;
                font-size: 0.85rem;
                white-space: normal;
                word-wrap: break-word;
            }
            
            .shop-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .medicine-card {
                flex-direction: column;
                text-align: center;
                padding: 1rem;
            }
            
            .medicine-image {
                margin-bottom: 1rem;
                font-size: 2rem;
            }
            
            .medicine-name {
                font-size: 1rem;
            }
            
            .medicine-description {
                font-size: 0.85rem;
            }
            
            .cart-section {
                margin-top: 2rem;
            }
            
            .family-plan-header {
                text-align: center;
            }
            
            .family-members-form {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .family-member-input {
                width: 100%;
                max-width: 100%;
            }
            
            .planning-tabs {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .planning-tab {
                width: 100%;
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            
            .appointment-form,
            .medication-form {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .appointment-form input,
            .medication-form input,
            .appointment-form textarea,
            .medication-form textarea {
                width: 100%;
                max-width: 100%;
                font-size: 0.9rem;
            }
            
            .delivery-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .map-container {
                height: 250px;
                min-height: 200px;
            }
            
            .map-frame {
                height: 100%;
                width: 100%;
            }
            
            .shipping-info {
                padding: 1rem;
            }
            
            .shipping-address {
                font-size: 0.9rem;
                word-wrap: break-word;
            }
            
            .recommendations-section {
                margin: 1rem 0;
                padding: 1rem;
            }

            .recommended-section {
                background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                border-radius: 15px;
                padding: 20px;
                margin: 20px 0;
                color: white;
                box-shadow: 0 8px 32px rgba(76, 175, 80, 0.3);
            }

            .recommended-section h3 {
                color: white;
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .recommended-section p {
                color: rgba(255, 255, 255, 0.9);
                margin-bottom: 15px;
            }

            .recommended-product-card {
                background: white;
                border-radius: 10px;
                padding: 15px;
                margin: 10px 0;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                position: relative;
                transition: transform 0.2s ease;
            }

            .recommended-product-card:hover {
                transform: translateY(-2px);
            }

            .recommended-badge {
                position: absolute;
                top: 10px;
                right: 10px;
                background: #4CAF50;
                color: white;
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: bold;
            }

            .recommended-product-info {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 10px;
            }

            .recommended-product-price {
                font-weight: bold;
                color: #4CAF50;
            }

            .recommended-product-price.discounted {
                color: #ff6b6b;
            }

            .recommended-product-price .original-price {
                text-decoration: line-through;
                color: #999;
                margin-right: 8px;
            }
            
            .recommendations-list {
                max-height: 300px;
                overflow-y: auto;
            }
            
            .allergy-warning-badge {
                font-size: 0.75rem;
                padding: 0.5rem;
            }
            
            .btn-add-cart {
                padding: 0.75rem;
                font-size: 0.85rem;
                white-space: normal;
                word-wrap: break-word;
            }
            
            .premium-badge {
                font-size: 0.7rem;
                padding: 0.25rem 0.5rem;
            }
            
            .cart-item {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.75rem;
            }
            
            .cart-item-info {
                text-align: center;
            }
            
            .quantity-btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.8rem;
            }
            
            .profile-item {
                padding: 0.75rem;
                font-size: 0.9rem;
                word-wrap: break-word;
            }
            
            .family-member-card {
                padding: 0.75rem;
                margin: 0.5rem 0;
            }
            
            .appointment-card,
            .medication-card {
                padding: 0.75rem;
                margin: 0.5rem 0;
            }
            
            .vaccination-upload {
                padding: 0.75rem;
            }
            
            .vaccination-preview {
                max-width: 100%;
                height: auto;
            }
            
            .timeline-item {
                padding: 0.75rem;
                margin: 0.5rem 0;
            }
            
            .history-item {
                padding: 0.75rem;
                margin: 0.5rem 0;
            }
            
            .location-update-form {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .location-update-form input {
                width: 100%;
                max-width: 100%;
                font-size: 0.9rem;
            }
            
            .btn-confirm-shipping {
                width: 100%;
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            
            .shop-filters {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .filter-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
                white-space: nowrap;
            }
            
            .shop-header {
                text-align: center;
                padding: 1rem;
            }
            
            .shop-banner {
                padding: 1rem;
                font-size: 0.9rem;
            }
            
            .family-plan-pricing {
                text-align: center;
                padding: 1rem;
            }
            
            .family-benefits {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .family-benefit-item {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            
            .btn-upgrade-family {
                width: 100%;
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            
            .family-plan-status {
                padding: 1rem;
                font-size: 0.9rem;
            }
            
            .family-plan-limit {
                font-size: 0.8rem;
                padding: 0.5rem;
            }
            
            .btn-remove-member {
                padding: 0.25rem 0.5rem;
                font-size: 0.7rem;
            }
            
            .planning-content {
                padding: 1rem;
            }
            
            .planning-content h3 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }
            
            .vaccination-timeline {
                max-height: 300px;
                overflow-y: auto;
            }
            
            .form-group {
                margin-bottom: 0.75rem;
            }
            
            .form-group label {
                font-size: 0.9rem;
                margin-bottom: 0.25rem;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 0.9rem;
                padding: 0.5rem;
            }
            
            .btn-primary,
            .btn-secondary {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                width: 100%;
                margin: 0.25rem 0;
            }
            
            .auth-container {
                padding: 1rem;
                max-width: 100%;
            }
            
            .auth-form {
                padding: 1rem;
            }
            
            .auth-form input {
                font-size: 0.9rem;
                padding: 0.75rem;
            }
            
            .auth-form button {
                padding: 0.75rem;
                font-size: 0.9rem;
                width: 100%;
            }
            
            .section {
                padding: 1rem;
                min-height: auto;
            }
            
            .section h2 {
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .section p {
                font-size: 0.9rem;
                line-height: 1.4;
            }
            
            .card {
                padding: 1rem;
                margin: 0.5rem 0;
            }
            
            .grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .tabs {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .tab {
                width: 100%;
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            
            .check-in-history {
                max-height: 250px;
            }
            
            .symptom-checklist {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .symptom-item {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            
            .mood-slider {
                margin: 0.75rem 0;
            }
            
            .logout-btn {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.85rem !important;
                margin: 0.25rem 0 !important;
                width: 100% !important;
                text-align: center !important;
            }
            
            .btn-group {
                gap: 0.5rem;
            }
            
            .btn-group .btn {
                min-width: 120px;
            }
        }

        /* Extra Small Screens */
        @media (max-width: 480px) {
            .floating-language-selector {
                bottom: 0.75rem;
                right: 0.75rem;
                padding: 0.4rem;
            }

            .floating-language-selector select {
                font-size: 0.8rem;
                padding: 0.3rem;
            }

            .container {
                padding: 0.5rem;
            }
            
            .hero-content h1 {
                font-size: 1.5rem;
            }
            
            .hero-content p {
                font-size: 0.8rem;
            }
            
            .chat-container {
                height: 50vh;
                min-height: 250px;
            }
            
            .chat-messages {
                height: calc(100% - 100px);
                padding: 0.25rem;
            }
            
            .message-content {
                max-width: 85%;
                font-size: 0.85rem;
                padding: 0.5rem 0.75rem;
            }
            
            .symptom-options {
                max-height: 150px;
            }
            
            .symptom-option {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            
            .medicine-card {
                padding: 0.75rem;
            }
            
            .medicine-name {
                font-size: 0.9rem;
            }
            
            .medicine-description {
                font-size: 0.75rem;
            }
            
            .btn-add-cart {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            
            .allergy-warning-badge {
                font-size: 0.7rem;
                padding: 0.25rem;
            }
            
            .cart-item {
                padding: 0.5rem;
            }
            
            .cart-item-name {
                font-size: 0.85rem;
            }
            
            .cart-item-price {
                font-size: 0.8rem;
            }
            
            .profile-item {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            .family-member-card {
                padding: 0.5rem;
            }
            
            .appointment-card,
            .medication-card {
                padding: 0.5rem;
            }
            
            .timeline-item {
                padding: 0.5rem;
            }
            
            .history-item {
                padding: 0.5rem;
            }
            
            .shop-filters {
                gap: 0.25rem;
            }
            
            .filter-btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
            
            .shop-header {
                padding: 0.75rem;
            }
            
            .shop-banner {
                padding: 0.75rem;
                font-size: 0.8rem;
            }
            
            .family-plan-pricing {
                padding: 0.75rem;
            }
            
            .family-benefit-item {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            .btn-upgrade-family {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            .family-plan-status {
                padding: 0.75rem;
                font-size: 0.85rem;
            }
            
            .planning-tab {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            .planning-content h3 {
                font-size: 1.1rem;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 0.85rem;
                padding: 0.5rem;
            }
            
            .btn-primary,
            .btn-secondary {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
            }
            
            .auth-form {
                padding: 0.75rem;
            }
            
            .auth-form input {
                font-size: 0.85rem;
                padding: 0.5rem;
            }
            
            .auth-form button {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            .section {
                padding: 0.75rem;
            }
            
            .section h2 {
                font-size: 1.3rem;
            }
            
            .section p {
                font-size: 0.85rem;
            }
            
            .card {
                padding: 0.75rem;
            }
            
            .tab {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            .symptom-item {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            .map-container {
                height: 200px;
                min-height: 150px;
            }
            
            .shipping-info {
                padding: 0.75rem;
            }
            
            .shipping-address {
                font-size: 0.8rem;
            }
            
            .recommendations-section {
                margin: 0.75rem 0;
                padding: 0.75rem;
            }
            
            .recommendations-list {
                max-height: 250px;
            }
            
            .premium-badge {
                font-size: 0.65rem;
                padding: 0.2rem 0.4rem;
            }
            
            .quantity-btn {
                padding: 0.2rem 0.4rem;
                font-size: 0.75rem;
            }
            
            .btn-remove-member {
                padding: 0.2rem 0.4rem;
                font-size: 0.65rem;
            }
            
            .family-plan-limit {
                font-size: 0.75rem;
                padding: 0.4rem;
            }
            
            .vaccination-timeline {
                max-height: 250px;
            }
            
            .vaccination-upload {
                padding: 0.5rem;
            }
            
            .location-update-form input {
                font-size: 0.85rem;
                padding: 0.5rem;
            }
            
            .btn-confirm-shipping {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            .logout-btn {
                padding: 0.4rem 0.6rem !important;
                font-size: 0.8rem !important;
            }
            
            .btn-group {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .btn-group .btn {
                width: 100%;
                margin: 0;
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .d-none { display: none; }
        .d-block { display: block; }

        /* Responsive Utilities */
        * {
            box-sizing: border-box;
        }

        img, video, iframe {
            max-width: 100%;
            height: auto;
        }

        input, select, textarea, button {
            max-width: 100%;
            box-sizing: border-box;
        }

        .grid, .flex {
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Dark Mode */
        body.dark-mode {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: #f1f5f9;
        }

        body.dark-mode .card {
            background: #334155;
            color: #f1f5f9;
        }

        body.dark-mode .form-control {
            background: #475569;
            border-color: #64748b;
            color: #f1f5f9;
        }

        body.dark-mode .chat-messages {
            background: #475569;
        }

        body.dark-mode .message.bot .message-content {
            background: #64748b;
            border-color: #94a3b8;
            color: #f1f5f9;
        }

        body.dark-mode .floating-language-selector {
            background: #334155;
            border-color: #64748b;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        body.dark-mode .floating-language-selector select {
            color: #f1f5f9;
        }

        body.dark-mode .floating-language-selector select:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .floating-language-selector select:focus {
            background-color: rgba(255, 255, 255, 0.15);
        }

        body.dark-mode #navLogout {
            color: #ff6b6b;
        }

        body.dark-mode #navLogout:hover {
            color: #ff5252;
        }

        /* Check-in Styles */
        .mood-slider {
            width: 100%;
            margin: 1rem 0;
        }

        .symptom-checklist {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .symptom-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .check-in-history {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
        }

        .check-in-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .check-in-item:last-child {
            border-bottom: none;
        }

        /* Dashboard Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 2rem;
        }

        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Voice Input */
        .voice-btn {
            background: var(--success);
            border: none;
            padding: 0.75rem;
            border-radius: 50%;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .voice-btn.recording {
            background: var(--danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1002;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Doctor Referral */
        .emergency-banner {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            text-align: center;
        }

        .doctor-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .doctor-card {
            background: var(--light);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        /* Video Section */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .video-item {
            background: var(--light);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .video-item iframe {
            width: 100%;
            height: 200px;
        }

        .video-info {
            padding: 1rem;
        }

        /* Profile */
        .profile-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .profile-item {
            background: var(--light);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        /* Floating Language Selector */
        .floating-language-selector {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
            background: var(--light);
            padding: 0.75rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .floating-language-selector:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
        }

        .floating-language-selector select {
            background: transparent;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--dark);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }

        .floating-language-selector select:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .floating-language-selector select:focus {
            outline: none;
            background-color: rgba(0, 0, 0, 0.1);
        }

        /* Language Selector (legacy - keeping for compatibility) */
        .language-selector {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }

        /* Premium Section Styles */
        .premium-benefits {
            margin-bottom: 3rem;
        }

        .benefits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .benefit-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .benefit-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .benefit-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .benefit-content h4 {
            margin-bottom: 0.5rem;
            color: var(--dark);
            font-size: 1.1rem;
        }

        .benefit-content p {
            color: var(--secondary);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Subscription Section */
        .subscription-section {
            margin: 3rem 0;
            text-align: center;
        }

        .subscription-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 2rem;
            border-radius: var(--radius);
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .pricing-info {
            margin: 2rem 0;
        }

        .price {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .currency {
            font-size: 1.5rem;
            vertical-align: top;
        }

        .period {
            font-size: 1.2rem;
            opacity: 0.8;
        }

        .trial-offer {
            margin-bottom: 2rem;
        }

        .trial-badge {
            background: #fbbf24;
            color: #92400e;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: inline-block;
        }

        .subscription-note {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 1rem;
        }

        .btn-premium {
            background: #fbbf24;
            color: #92400e;
            font-size: 1.1rem;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-premium:hover {
            background: #f59e0b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(251, 191, 36, 0.4);
        }

        /* Video Gallery */
        .video-gallery {
            margin: 3rem 0;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .video-card {
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .video-card:hover {
            transform: translateY(-5px);
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .video-info {
            padding: 1.5rem;
        }

        .video-info h4 {
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .video-info p {
            color: var(--secondary);
            line-height: 1.5;
        }

        /* Testimonials */
        .testimonials-section {
            margin: 3rem 0;
        }

        .testimonials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .testimonial-card {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
            transition: transform 0.3s ease;
        }

        .testimonial-card:hover {
            transform: translateY(-3px);
        }

        .testimonial-content {
            margin-bottom: 1.5rem;
        }

        .testimonial-content p {
            font-style: italic;
            color: var(--dark);
            line-height: 1.6;
            font-size: 1rem;
        }

        .testimonial-author {
            border-top: 1px solid var(--border);
            padding-top: 1rem;
        }

        .testimonial-author strong {
            display: block;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .testimonial-author span {
            color: var(--secondary);
            font-size: 0.9rem;
        }

        /* Dark Mode Premium Styles */
        body.dark-mode .benefit-item {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            border-color: #64748b;
        }

        body.dark-mode .benefit-content h4 {
            color: #f1f5f9;
        }

        body.dark-mode .benefit-content p {
            color: #cbd5e1;
        }

        body.dark-mode .video-card {
            background: #334155;
            color: #f1f5f9;
        }

        body.dark-mode .video-info h4 {
            color: #f1f5f9;
        }

        body.dark-mode .video-info p {
            color: #cbd5e1;
        }

        body.dark-mode .testimonial-card {
            background: #334155;
            color: #f1f5f9;
        }

        body.dark-mode .testimonial-content p {
            color: #f1f5f9;
        }

        body.dark-mode .testimonial-author strong {
            color: #f1f5f9;
        }

        body.dark-mode .testimonial-author span {
            color: #cbd5e1;
        }

        /* Family Plan Styles */
        .family-plan-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .family-plan-pricing {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: var(--radius);
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .family-price {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .family-trial {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 1rem;
        }

        .family-benefits {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .family-benefit-item {
            background: var(--light);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            text-align: center;
        }

        .family-benefit-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .family-benefit-item h4 {
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .family-benefit-item p {
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .family-members-form {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .family-member-input {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--light);
        }

        .family-member-card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
        }

        .family-member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .family-member-name {
            font-weight: 600;
            color: var(--dark);
            font-size: 1.1rem;
        }

        .family-member-relationship {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .family-member-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--secondary);
        }

        .family-member-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .btn-remove-member {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .btn-remove-member:hover {
            background: #dc2626;
        }

        .family-plan-status {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            padding: 1.5rem;
            border-radius: var(--radius);
            text-align: center;
            margin-bottom: 2rem;
        }

        .family-plan-limit {
            background: var(--warning);
            color: #92400e;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 500;
        }

        /* Dark Mode Family Plan Styles */
        body.dark-mode .family-benefit-item {
            background: #475569;
            border-color: #64748b;
        }

        body.dark-mode .family-benefit-item h4 {
            color: #f1f5f9;
        }

        body.dark-mode .family-benefit-item p {
            color: #cbd5e1;
        }

        body.dark-mode .family-members-form {
            background: #334155;
            border-color: #64748b;
            color: #f1f5f9;
        }

        body.dark-mode .family-member-input {
            background: #475569;
            border-color: #64748b;
        }

        body.dark-mode .family-member-card {
            background: #334155;
            border-color: #64748b;
            color: #f1f5f9;
        }

        body.dark-mode .family-member-name {
            color: #f1f5f9;
        }

        body.dark-mode .family-member-details {
            color: #cbd5e1;
        }

        /* Planning & Reminders Styles */
        .planning-tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 2rem;
            overflow-x: auto;
        }

        .planning-tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .planning-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .planning-content {
            display: none;
        }

        .planning-content.active {
            display: block;
        }

        /* Appointment Styles */
        .appointment-form {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .appointment-card {
            background: var(--light);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 1rem;
            position: relative;
        }

        .appointment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .appointment-doctor {
            font-weight: 600;
            color: var(--dark);
            font-size: 1.1rem;
        }

        .appointment-date {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .appointment-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--secondary);
        }

        .appointment-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .btn-remove-appointment {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .btn-remove-appointment:hover {
            background: #dc2626;
        }

        /* Medication Styles */
        .medication-form {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .medication-card {
            background: var(--light);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 1rem;
            position: relative;
        }

        .medication-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .medication-name {
            font-weight: 600;
            color: var(--dark);
            font-size: 1.1rem;
        }

        .medication-time {
            background: var(--success);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .medication-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--secondary);
        }

        .medication-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .btn-remove-medication {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .btn-remove-medication:hover {
            background: #dc2626;
        }

        /* Vaccination Styles */
        .vaccination-upload {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 2rem;
            text-align: center;
        }

        .vaccination-preview {
            margin: 1rem 0;
            text-align: center;
        }

        .vaccination-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            border: 2px solid var(--border);
        }

        .vaccination-timeline {
            margin: 2rem 0;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            position: relative;
        }

        .timeline-item.completed {
            background: #f0fdf4;
            border-color: var(--success);
        }

        .timeline-item.upcoming {
            background: #fef3c7;
            border-color: var(--warning);
        }

        .timeline-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-vaccine {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .timeline-date {
            font-size: 0.9rem;
            color: var(--secondary);
        }

        .timeline-status {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 1rem;
        }

        .timeline-status.completed {
            background: var(--success);
            color: white;
        }

        .timeline-status.upcoming {
            background: var(--warning);
            color: #92400e;
        }

        /* Dark Mode Planning Styles */
        body.dark-mode .appointment-form,
        body.dark-mode .medication-form,
        body.dark-mode .vaccination-upload {
            background: #334155;
            border-color: #64748b;
            color: #f1f5f9;
        }

        body.dark-mode .appointment-card,
        body.dark-mode .medication-card {
            background: #475569;
            border-color: #64748b;
        }

        body.dark-mode .appointment-doctor,
        body.dark-mode .medication-name {
            color: #f1f5f9;
        }

        body.dark-mode .appointment-details,
        body.dark-mode .medication-details {
            color: #cbd5e1;
        }

        body.dark-mode .timeline-item.completed {
            background: #064e3b;
            border-color: var(--success);
        }

        body.dark-mode .timeline-item.upcoming {
            background: #78350f;
            border-color: var(--warning);
        }

        body.dark-mode .timeline-vaccine {
            color: #f1f5f9;
        }

        body.dark-mode .timeline-date {
            color: #cbd5e1;
        }

        /* Shop Styles */
        .shop-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        /* Delivery Details Section within Shop */
        .delivery-details-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--border);
        }

        .delivery-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .delivery-header h3 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .delivery-header p {
            color: var(--secondary);
            font-size: 0.95rem;
        }

        .shop-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: var(--radius);
            text-align: center;
            margin-bottom: 2rem;
        }

        .shop-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .medicine-card {
            background: white;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }

        .medicine-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .medicine-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }

        .medicine-info {
            padding: 1.5rem;
        }

        .medicine-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .medicine-description {
            color: var(--secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .medicine-price {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .price-regular {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
        }

        .price-discounted {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--success);
        }

        .price-original {
            font-size: 0.9rem;
            color: var(--secondary);
            text-decoration: line-through;
        }

        .premium-badge {
            background: var(--warning);
            color: #92400e;
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .btn-add-cart {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .btn-add-cart:hover {
            background: var(--primary-dark);
        }

        .btn-add-cart:disabled {
            background: var(--secondary);
            cursor: not-allowed;
        }

        .btn-warning {
            background: var(--warning) !important;
            color: #92400e !important;
        }

        .btn-warning:hover {
            background: #f59e0b !important;
        }

        .allergy-warning {
            border: 2px solid var(--warning) !important;
        }

        .allergy-warning-badge {
            background: #fef3c7;
            color: #92400e;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 1rem;
            border: 1px solid #fbbf24;
        }

        /* Cart Styles */
        .cart-section {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .cart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark);
        }

        .cart-count {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .cart-item-price {
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-btn {
            background: var(--light);
            border: 1px solid var(--border);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .quantity-btn:hover {
            background: var(--border);
        }

        .cart-total {
            border-top: 2px solid var(--border);
            padding-top: 1rem;
            margin-top: 1rem;
            text-align: right;
        }

        .total-amount {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark);
        }

        .btn-checkout {
            background: var(--success);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 1rem;
        }

        .btn-checkout:hover {
            background: #059669;
        }

        .recommendations-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            padding: 2rem;
            border-radius: var(--radius);
            border: 1px solid #bbf7d0;
            margin-bottom: 2rem;
        }

        .recommendations-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .recommendations-icon {
            font-size: 1.5rem;
        }

        /* Dark Mode Shop Styles */
        body.dark-mode .medicine-card {
            background: #334155;
            border-color: #64748b;
        }

        body.dark-mode .medicine-name {
            color: #f1f5f9;
        }

        body.dark-mode .medicine-description {
            color: #cbd5e1;
        }

        body.dark-mode .price-regular,
        body.dark-mode .price-discounted {
            color: #f1f5f9;
        }

        body.dark-mode .price-original {
            color: #94a3b8;
        }

        body.dark-mode .cart-section {
            background: #334155;
            border-color: #64748b;
            color: #f1f5f9;
        }

        body.dark-mode .cart-title {
            color: #f1f5f9;
        }

        body.dark-mode .cart-item-name {
            color: #f1f5f9;
        }

        body.dark-mode .cart-item-price {
            color: #cbd5e1;
        }

        body.dark-mode .quantity-btn {
            background: #475569;
            border-color: #64748b;
            color: #f1f5f9;
        }

        body.dark-mode .total-amount {
            color: #f1f5f9;
        }

        body.dark-mode .recommendations-section {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
            border-color: #10b981;
        }

        body.dark-mode .allergy-warning-badge {
            background: #78350f;
            color: #fbbf24;
            border-color: #f59e0b;
        }

        .typing-dots {
            display: inline-block;
            animation: typing 1.4s infinite;
        }

        @keyframes typing {
            0%, 20% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        .quick-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .quick-option-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .quick-option-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .emergency-warning {
            background: #fee2e2;
            border: 2px solid #ef4444;
            color: #991b1b;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-weight: bold;
        }

        body.dark-mode .emergency-warning {
            background: #7f1d1d;
            border-color: #dc2626;
            color: #fecaca;
        }

        /* Family History Options Styles */
        .family-history-options {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .family-history-options h4 {
            margin-bottom: 1rem;
            color: var(--dark);
            font-weight: 600;
        }

        .history-checkbox {
            display: flex;
            align-items: center;
            margin: 0.5rem 0;
            gap: 0.5rem;
            padding: 0.25rem 0;
        }

        .history-checkbox input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .history-checkbox label {
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--dark);
        }

        body.dark-mode .family-history-options {
            background: var(--dark);
            border-color: var(--border-dark);
        }

        body.dark-mode .family-history-options h4 {
            color: var(--light);
        }

        body.dark-mode .history-checkbox label {
            color: var(--light);
        }

        /* Logout Button Styles */
        .logout-btn {
            background: #dc2626 !important;
            color: white !important;
            padding: 0.5rem 1rem !important;
            border-radius: 6px !important;
            font-weight: 600 !important;
            transition: all 0.3s ease !important;
            border: 2px solid #dc2626 !important;
        }

        .logout-btn:hover {
            background: #b91c1c !important;
            border-color: #b91c1c !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3) !important;
        }

        body.dark-mode .logout-btn {
            background: #ef4444 !important;
            border-color: #ef4444 !important;
        }

        body.dark-mode .logout-btn:hover {
            background: #dc2626 !important;
            border-color: #dc2626 !important;
        }

        /* Delivery Styles */
        .delivery-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .map-container {
            background: white;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .map-frame {
            width: 100%;
            height: 400px;
            border: none;
        }

        .map-placeholder {
            height: 400px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: var(--secondary);
        }

        .map-placeholder-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .shipping-info {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .shipping-address {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--light);
            border-radius: 8px;
        }

        .address-icon {
            font-size: 1.5rem;
        }

        .address-details {
            flex: 1;
        }

        .address-label {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .address-text {
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .delivery-estimate {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #bbf7d0;
            margin-bottom: 1.5rem;
        }

        .estimate-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .estimate-icon {
            font-size: 1.2rem;
        }

        .estimate-title {
            font-weight: 600;
            color: var(--dark);
        }

        .estimate-details {
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .btn-confirm-shipping {
            background: var(--success);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-confirm-shipping:hover {
            background: #059669;
        }

        .shipping-history {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-info {
            flex: 1;
        }

        .history-order {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .history-date {
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .history-status {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-delivered {
            background: var(--success);
            color: white;
        }

        .status-shipping {
            background: var(--warning);
            color: #92400e;
        }

        .location-update-form {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .premium-location-fields {
            display: none;
        }

        .premium-location-fields.show {
            display: block;
        }

        /* Dark Mode Delivery Styles */
        body.dark-mode .map-container,
        body.dark-mode .shipping-info,
        body.dark-mode .shipping-history,
        body.dark-mode .location-update-form {
            background: #334155;
            border-color: #64748b;
            color: #f1f5f9;
        }

        body.dark-mode .shipping-address {
            background: #475569;
        }

        body.dark-mode .address-label {
            color: #f1f5f9;
        }

        body.dark-mode .address-text {
            color: #cbd5e1;
        }

        body.dark-mode .delivery-estimate {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
            border-color: #10b981;
        }

        body.dark-mode .estimate-title {
            color: #f1f5f9;
        }

        body.dark-mode .estimate-details {
            color: #cbd5e1;
        }

        body.dark-mode .history-order {
            color: #f1f5f9;
        }

        body.dark-mode .history-date {
            color: #cbd5e1;
        }
    </style>
</head>
<body>
    <!-- Logo -->
    <div class="logo-container">
        <img src="images/logo.png" alt="DiagKnows Logo" class="app-logo" />
    </div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">DiagKnows</div>
            <ul class="nav-links">
                <li><a href="#" onclick="showSection('home')">Home</a></li>
                <li><a href="#" onclick="showSection('login')" id="navLogin">Login</a></li>
                <li><a href="#" onclick="showSection('signup')" id="navSignup">Signup</a></li>
                <li><a href="#" onclick="checkAuthAndShow('chatbot')" id="navChatbot">Chatbot</a></li>
                <li><a href="#" onclick="checkAuthAndShow('checkin')" id="navCheckin">Check-in</a></li>
                <li><a href="#" onclick="checkAuthAndShow('dashboard')" id="navDashboard">Dashboard</a></li>
                <li><a href="#" onclick="checkAuthAndShow('profile')" id="navProfile">Profile</a></li>
                <li><a href="#" onclick="checkAuthAndShow('premium')" id="navPremium">Premium</a></li>
                <li><a href="#" onclick="checkAuthAndShow('family')" id="navFamily">Family Plan</a></li>
                <li><a href="#" onclick="checkAuthAndShow('planning')" id="navPlanning">Planning</a></li>
                <li><a href="#" onclick="checkAuthAndShow('shop')" id="navShop">Shop</a></li>
                <li><a href="#" onclick="checkAuthAndShow('settings')" id="navSettings">Settings</a></li>
                <li><a href="#" onclick="showSection('terms')">Terms</a></li>
                <li><a href="#" onclick="logout()" id="navLogout" style="display: none;">Logout</a></li>
            </ul>
            <div class="nav-right">
            <button class="btn btn-secondary" onclick="toggleDarkMode()" style="margin-left: 1rem;">ðŸŒ™</button>
            </div>
        </div>
    </nav>

    <!-- Premium Trial Banner -->
    <div class="premium-banner" id="premiumBanner">
        ðŸŽ‰ Start your 7-day FREE Premium Trial today! Unlock advanced features.
        <button class="btn" onclick="startPremiumTrial()">Start Trial</button>
    </div>

    <!-- Floating Language Selector -->
    <div class="floating-language-selector">
        <select class="form-control" id="languageSelector" onchange="changeLanguage(this.value)">
            <option value="en">ðŸ‡ºðŸ‡¸ EN</option>
            <option value="es">ðŸ‡ªðŸ‡¸ ES</option>
            <option value="fr">ðŸ‡«ðŸ‡· FR</option>
        </select>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Home Section -->
        <div class="card active" id="home">
            <h1>Welcome to DiagKnows</h1>
            <p class="mb-3">Your AI-powered health assistant designed to provide personalized health insights and guidance.</p>
            
            <!-- Mission Statement Section -->
            <section id="mission" class="mission-section">
                <h2>Our Mission</h2>
                <p class="mission-text">
                    At DiagKnows, our mission is to make healthcare easier, faster, and more affordable for everyone. We harness the power of AI to help people understand their symptoms, manage daily care, and make informed health decisions without the barriers of high costs or long wait times. By combining intelligent tools, personalized guidance, and accessible features, we aim to empower individuals to take control of their health and stay well â€” anytime, anywhere.
                </p>
            </section>
            
            <div class="grid">
                <div class="card">
                    <h3>ðŸ¤– AI Chatbot</h3>
                    <p>Get instant health advice and symptom analysis</p>
                    <button class="btn" onclick="checkAuthAndShow('chatbot')">Start Chatbot</button>
                </div>
                <div class="card">
                    <h3>ðŸ“· Scan Records</h3>
                    <p>Upload medical documents for AI analysis</p>
                    <button class="btn" onclick="checkAuthAndShow('chatbot')">Start Analysis</button>
                </div>
                <div class="card">
                    <h3>ðŸ“Š Daily Check-ins</h3>
                    <p>Track your health and symptoms daily</p>
                    <button class="btn" onclick="checkAuthAndShow('checkin')">Start Tracking</button>
                </div>
            </div>
        </div>

        <!-- Login Section -->
        <div class="card" id="login">
            <h2>Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" class="form-control" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                </div>
                <div class="btn-group btn-group-stacked">
                    <button type="submit" class="btn btn-primary btn-full">Login</button>
                    <button type="button" class="btn btn-secondary btn-full" onclick="showSection('signup')">Create Account</button>
                </div>
            </form>
        </div>

        <!-- Signup Section -->
        <div class="card" id="signup">
            <h2>Create Account</h2>
            <form id="signupForm">
                <div class="grid">
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" class="form-control" id="signupUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Password *</label>
                        <input type="password" class="form-control" id="signupPassword" required>
                    </div>
                </div>
                <div class="grid">
                    <div class="form-group">
                        <label>Confirm Password *</label>
                        <input type="password" class="form-control" id="signupConfirmPassword" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" class="form-control" id="signupEmail" required>
                    </div>
                </div>
                <div class="grid">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" class="form-control" id="signupName" required>
                    </div>
                    <div class="form-group">
                        <label>Age *</label>
                        <input type="number" class="form-control" id="signupAge" min="1" max="120" required>
                    </div>
                </div>
                <div class="grid">
                    <div class="form-group">
                        <label>Height (inches) *</label>
                        <input type="number" class="form-control" id="signupHeight" min="20" max="100" required>
                    </div>
                    <div class="form-group">
                        <label>Weight (lbs) *</label>
                        <input type="number" class="form-control" id="signupWeight" min="40" max="600" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" class="form-control" id="signupLocation" required>
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" class="form-control" id="signupPhone" required>
                </div>
                <div class="form-group">
                    <label>Medical History (Optional)</label>
                    <textarea class="form-control" id="signupMedical" rows="3" placeholder="Enter any known medical conditions, allergies, or medications..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Medical Records Upload (Optional)</label>
                    <div class="medical-upload-section">
                        <div class="upload-options">
                            <button type="button" class="btn btn-secondary" onclick="openCamera()">ðŸ“· Take Photo</button>
                            <button type="button" class="btn btn-secondary" onclick="openFileUpload()">ðŸ“ Upload File</button>
                        </div>
                        <div class="upload-preview" id="uploadPreview" style="display: none;">
                            <div class="preview-header">
                                <span>ðŸ“„ Medical Records Preview</span>
                                <button type="button" class="btn-remove" onclick="removeUpload()">âœ•</button>
                            </div>
                            <div class="preview-content" id="previewContent"></div>
                        </div>
                        <input type="file" id="medicalFileUpload" accept="image/*,.pdf" style="display: none;" onchange="handleFileUpload(event)">
                        <video id="cameraVideo" style="display: none;" autoplay></video>
                        <canvas id="cameraCanvas" style="display: none;"></canvas>
                    </div>
                </div>
                <div class="form-group">
                    <label>Preferred Language</label>
                    <select class="form-control" id="signupLanguage">
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="signupTerms" required>
                        I agree to the Terms & Conditions
                    </label>
                </div>
                <div class="btn-group btn-group-stacked">
                    <button type="submit" class="btn btn-primary btn-full">Create Account</button>
                    <button type="button" class="btn btn-secondary btn-full" onclick="showSection('login')">Back to Login</button>
                </div>
            </form>
        </div>

        <!-- Chatbot Section -->
        <div class="card" id="chatbot">
            <div class="chat-container">
                <div class="chat-header">
                    <span>ðŸ¤– DiagKnows AI Assistant</span>
                    <div class="btn-group">
                        <button class="btn btn-secondary btn-small" onclick="toggleVoice()">ðŸŽ¤ Voice</button>
                        <button class="btn btn-secondary btn-small" onclick="translateInput()">ðŸŒ Translate</button>
                    </div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="message bot">
                        <div class="message-content">
                            Hello! I'm your AI health assistant. What symptoms are you experiencing today?
                        </div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Type your symptoms...">
                    <div class="btn-group">
                        <button class="btn btn-primary btn-small" onclick="sendMessage()">Send</button>
                        <button class="btn btn-secondary btn-small" id="voiceBtn" onclick="toggleVoiceInput()">ðŸŽ™ï¸</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Premium Section -->
        <div class="card" id="premium">
            <h2>ðŸŒŸ Premium Features</h2>
            
            <!-- Why Go Premium Section -->
            <div class="premium-benefits">
                <h3>ðŸ”¹ Why Go Premium?</h3>
                <div class="benefits-grid">
                    <div class="benefit-item">
                        <div class="benefit-icon">ðŸ§ </div>
                        <div class="benefit-content">
                            <h4>Personalized Health Insights</h4>
                            <p>Get tailored health recommendations based on your medical history and symptoms</p>
                        </div>
                    </div>
                    <div class="benefit-item">
                        <div class="benefit-icon">ðŸŽ¥</div>
                        <div class="benefit-content">
                            <h4>Professional Health Videos</h4>
                            <p>Access exclusive educational content from healthcare professionals</p>
                        </div>
                    </div>
                    <div class="benefit-item">
                        <div class="benefit-icon">ðŸ“Š</div>
                        <div class="benefit-content">
                            <h4>Advanced AI Symptom Tracking</h4>
                            <p>Track your symptoms over time with intelligent pattern recognition</p>
                        </div>
                    </div>
                    <div class="benefit-item">
                        <div class="benefit-icon">ðŸ””</div>
                        <div class="benefit-content">
                            <h4>Priority Alerts & Notifications</h4>
                            <p>Get instant notifications for important health updates and reminders</p>
                        </div>
                    </div>
                    <div class="benefit-item">
                        <div class="benefit-icon">âš¡</div>
                        <div class="benefit-content">
                            <h4>Faster Analysis & Support</h4>
                            <p>Priority processing for all AI health assessments and faster response times</p>
                        </div>
                    </div>
                    <div class="benefit-item">
                        <div class="benefit-icon">ðŸ‘¨â€âš•ï¸</div>
                        <div class="benefit-content">
                            <h4>Connect with Healthcare Providers</h4>
                            <p>Access to network of doctors and therapists for professional consultation</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subscription Section -->
            <div class="subscription-section">
                <div class="subscription-card">
                    <h3>ðŸš€ Start Your Premium Journey</h3>
                    <div class="pricing-info">
                        <div class="price">
                            <span class="currency">$</span>
                            <span class="amount">9.99</span>
                            <span class="period">/month</span>
                        </div>
                        <div class="trial-offer">
                            <span class="trial-badge">FREE TRIAL</span>
                            <p>Start with 7 days free, then $9.99/month</p>
                        </div>
                    </div>
                    <button class="btn btn-premium" onclick="startPremiumTrial()">
                        ðŸŽ‰ Start 7-Day Free Trial
                    </button>
                    <p class="subscription-note">Cancel anytime. No commitment required.</p>
                </div>
            </div>

            <!-- Premium Features Grid -->
            <div class="premium-features-grid" id="premiumFeatures" style="display: none;">
                <h3>ðŸ“± Premium Tools</h3>
                <div class="grid">
                    <div class="card">
                        <h3>ðŸŽ¥ Video Guides</h3>
                        <p>Access exclusive health and wellness video content</p>
                        <button class="btn btn-secondary" onclick="showSection('videos')">Watch Videos</button>
                    </div>
                    <div class="card">
                        <h3>âš¡ Faster Analysis</h3>
                        <p>Priority processing for all AI health assessments</p>
                        <button class="btn btn-secondary">Learn More</button>
                    </div>
                    <div class="card">
                        <h3>ðŸ“Š Advanced Analytics</h3>
                        <p>Detailed health insights and trend analysis</p>
                        <button class="btn btn-secondary">View Analytics</button>
                </div>
                    <div class="card">
                        <h3>ðŸŽ¯ Personalized Recommendations</h3>
                        <p>AI-powered health recommendations tailored to you</p>
                        <button class="btn btn-secondary">Get Recommendations</button>
                    </div>
                </div>
                

            </div>

            <!-- Health Video Gallery -->
            <div class="video-gallery" id="videoGallery" style="display: none;">
                <h3>ðŸŽ¥ Health Education Videos</h3>
                <div class="video-grid">
                    <div class="video-card">
                        <div class="video-container">
                            <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" 
                                    title="Understanding Blood Test Results" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                            </iframe>
                        </div>
                        <div class="video-info">
                            <h4>Understanding Blood Test Results</h4>
                            <p>Learn how to read and interpret your blood test results with expert guidance.</p>
                        </div>
                    </div>
                    <div class="video-card">
                        <div class="video-container">
                            <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" 
                                    title="Nutrition Tips for Better Health" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                            </iframe>
                        </div>
                        <div class="video-info">
                            <h4>Nutrition Tips for Better Health</h4>
                            <p>Discover essential nutrition tips and dietary guidelines for optimal health.</p>
                        </div>
                    </div>
                    <div class="video-card">
                        <div class="video-container">
                            <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" 
                                    title="Mental Health and Wellness" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                            </iframe>
                        </div>
                        <div class="video-info">
                            <h4>Mental Health and Wellness</h4>
                            <p>Essential strategies for maintaining mental health and emotional well-being.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Testimonials Section -->
            <div class="testimonials-section">
                <h3>ðŸ’¬ What Our Premium Users Say</h3>
                <div class="testimonials-grid">
                    <div class="testimonial-card">
                        <div class="testimonial-content">
                            <p>"DiagKnows Premium has been a game-changer for my health tracking. The AI analysis is incredibly accurate and the video content is so educational!"</p>
                        </div>
                        <div class="testimonial-author">
                            <strong>Sarah M.</strong>
                            <span>Premium Member for 6 months</span>
                        </div>
                    </div>
                    <div class="testimonial-card">
                        <div class="testimonial-content">
                            <p>"The personalized health insights and advanced analytics are incredible! I can track my symptoms over time and get tailored recommendations. Highly recommend the premium features."</p>
                        </div>
                        <div class="testimonial-author">
                            <strong>Dr. Michael R.</strong>
                            <span>Healthcare Professional</span>
                        </div>
                    </div>
                    <div class="testimonial-card">
                        <div class="testimonial-content">
                            <p>"As someone managing chronic conditions, the personalized insights and priority alerts have made a huge difference in my health management."</p>
                        </div>
                        <div class="testimonial-author">
                            <strong>Jennifer L.</strong>
                            <span>Premium Member for 1 year</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Check-in Section -->
        <div class="card" id="checkin">
            <h2>Daily Health Check-in</h2>
            <form id="checkinForm">
                <div class="form-group">
                    <label>How are you feeling today? (0-10)</label>
                    <input type="range" class="mood-slider" id="moodSlider" min="0" max="10" value="5">
                    <div class="text-center" id="moodValue">5 - Neutral</div>
                </div>
                
                <div class="form-group">
                    <label>Symptoms Checklist</label>
                    <div class="symptom-checklist">
                        <div class="symptom-item">
                            <input type="checkbox" id="fever"> <label for="fever">Fever</label>
                        </div>
                        <div class="symptom-item">
                            <input type="checkbox" id="cough"> <label for="cough">Cough</label>
                        </div>
                        <div class="symptom-item">
                            <input type="checkbox" id="fatigue"> <label for="fatigue">Fatigue</label>
                        </div>
                        <div class="symptom-item">
                            <input type="checkbox" id="headache"> <label for="headache">Headache</label>
                        </div>
                        <div class="symptom-item">
                            <input type="checkbox" id="nausea"> <label for="nausea">Nausea</label>
                        </div>
                        <div class="symptom-item">
                            <input type="checkbox" id="pain"> <label for="pain">Pain</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Additional Notes</label>
                    <textarea class="form-control" id="checkinNotes" rows="3" placeholder="Any other symptoms or concerns..."></textarea>
                </div>
                
                <div class="btn-group btn-group-center">
                    <button type="submit" class="btn btn-primary btn-full">Save Check-in</button>
                </div>
            </form>
            
            <h3 class="mb-3">Previous Check-ins</h3>
            <div class="check-in-history" id="checkinHistory">
                <!-- Check-in history will be populated here -->
            </div>
        </div>

        <!-- Dashboard Section -->
        <div class="card" id="dashboard">
            <h2>Health Dashboard</h2>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('chatHistory')">Chat History</div>
                <div class="tab" onclick="switchTab('checkinLogs')">Check-in Logs</div>
            </div>
            
            <div class="tab-content active" id="chatHistory">
                <h3>Recent Chatbot Sessions</h3>
                <div id="chatHistoryList">
                    <!-- Chat history will be populated here -->
                </div>
            </div>
            
            <div class="tab-content" id="checkinLogs">
                <h3>Health Check-in History</h3>
                <div id="checkinLogsList">
                    <!-- Check-in logs will be populated here -->
                </div>
            </div>
        </div>

        <!-- Profile Section -->
        <div class="card" id="profile">
            <h2>User Profile</h2>
            <div class="profile-info" id="profileInfo">
                <!-- Profile info will be populated here -->
            </div>
                
                <!-- Location Update Form -->
                <div class="location-update-form">
                    <h3>ðŸ“ Update Shipping Location</h3>
                    <form id="locationUpdateForm">
                        <div class="form-group">
                            <label>City/State *</label>
                            <input type="text" class="form-control" id="updateLocation" placeholder="e.g., New York, NY" required>
                        </div>
                        
                        <div class="premium-location-fields" id="premiumLocationFields">
                            <div class="form-group">
                                <label>Street Address</label>
                                <input type="text" class="form-control" id="updateStreetAddress" placeholder="123 Main St">
                            </div>
                            <div class="form-group">
                                <label>ZIP Code</label>
                                <input type="text" class="form-control" id="updateZipCode" placeholder="10001">
                            </div>
                        </div>
                        
                        <div class="btn-group btn-group-center">
                            <button type="submit" class="btn btn-primary btn-full">Update Location</button>
                        </div>
                    </form>
                </div>
                
                <div class="btn-group btn-group-center">
                    <button class="btn btn-secondary btn-full" onclick="editProfile()">Edit Profile</button>
                </div>
        </div>

        <!-- Doctor Referral Section -->
        <div class="card" id="doctorReferral">
            <div class="emergency-banner">
                âš ï¸ EMERGENCY: If you're experiencing severe symptoms, please seek immediate medical attention!
            </div>
            <h2>Find a Doctor Near You</h2>
            <div class="doctor-links">
                <div class="doctor-card">
                    <h4>ðŸ¥ Emergency Services</h4>
                    <p>Call 911 for immediate medical assistance</p>
                    <div class="btn-group btn-group-center">
                        <button class="btn btn-danger btn-full">Call Emergency</button>
                    </div>
                </div>
                <div class="doctor-card">
                    <h4>ðŸ‘¨â€âš•ï¸ Primary Care</h4>
                    <p>Find a general practitioner in your area</p>
                    <div class="btn-group btn-group-center">
                        <button class="btn btn-primary btn-full">Find Doctor</button>
                    </div>
                </div>
                <div class="doctor-card">
                    <h4>ðŸ¥ Urgent Care</h4>
                    <p>Locate nearby urgent care facilities</p>
                    <div class="btn-group btn-group-center">
                        <button class="btn btn-primary btn-full">Find Urgent Care</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Premium Videos Section -->
        <div class="card" id="videos">
            <h2>Premium Health Videos</h2>
            <div id="videosContent">
                <!-- Content will be populated based on premium status -->
            </div>
        </div>

        <!-- Family Plan Section -->
        <div class="card" id="family">
            <div class="family-plan-header">
                <h2>ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Family Plan â€“ Up to 4 Members</h2>
                <p>Share the power of AI health assistance with your entire family</p>
            </div>

            <!-- Family Plan Pricing -->
            <div class="family-plan-pricing">
                <div class="family-price">$24.99<span style="font-size: 1.2rem;">/month</span></div>
                <div class="family-trial">ðŸŽ‰ 7-day free trial</div>
                <p>Perfect for families of up to 4 members</p>
            </div>

            <!-- Family Plan Benefits -->
            <div class="family-benefits">
                <div class="family-benefit-item">
                    <div class="family-benefit-icon">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦</div>
                    <h4>Up to 4 Family Members</h4>
                    <p>Add parents, children, spouse, or other family members</p>
                </div>
                <div class="family-benefit-item">
                    <div class="family-benefit-icon">ðŸ¤–</div>
                    <h4>Individual AI Profiles</h4>
                    <p>Each member gets their own personalized health assistant</p>
                </div>
                <div class="family-benefit-item">
                    <div class="family-benefit-icon">ðŸ“Š</div>
                    <h4>Family Health Dashboard</h4>
                    <p>Track everyone's health in one convenient place</p>
                </div>
                <div class="family-benefit-item">
                    <div class="family-benefit-icon">ðŸ””</div>
                    <h4>Family Notifications</h4>
                    <p>Get alerts for family members' health check-ins</p>
                </div>
            </div>

            <!-- Family Plan Status -->
            <div id="familyPlanStatus" style="display: none;">
                <div class="family-plan-status">
                    <h3>ðŸŽ‰ You're on the Family Plan!</h3>
                    <p>You can manage up to 4 users. Add family members below.</p>
                </div>
            </div>

            <!-- Upgrade to Family Plan -->
            <div id="familyPlanUpgrade" style="display: block;">
                <div class="text-center" style="margin-bottom: 2rem;">
                    <h3>Upgrade to Family Plan</h3>
                    <p>Get all Premium features for your entire family</p>
                    <div class="btn-group btn-group-center">
                        <button class="btn btn-primary btn-large" onclick="upgradeToFamilyPlan()">
                            ðŸš€ Start 7-Day Free Trial
                        </button>
                    </div>
                </div>
            </div>

            <!-- Add Family Members Form -->
            <div class="family-members-form" id="familyMembersForm" style="display: none;">
                <h3>ðŸ‘¥ Add Family Members</h3>
                <p>You can add up to 3 additional members (4 total including you)</p>
                
                <div id="familyMembersList">
                    <!-- Family members will be displayed here -->
                </div>

                <div id="addMemberForm" style="display: none;">
                    <h4>Add New Member</h4>
                    <div class="family-member-input">
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" class="form-control" id="memberName" required>
                        </div>
                        <div class="form-group">
                            <label>Age *</label>
                            <input type="number" class="form-control" id="memberAge" min="1" max="120" required>
                        </div>
                        <div class="form-group">
                            <label>Email (Optional)</label>
                            <input type="email" class="form-control" id="memberEmail">
                        </div>
                        <div class="form-group">
                            <label>Relationship *</label>
                            <select class="form-control" id="memberRelationship" required>
                                <option value="">Select Relationship</option>
                                <option value="Parent">Parent</option>
                                <option value="Child">Child</option>
                                <option value="Spouse">Spouse</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="addFamilyMember()">Add Member</button>
                        <button class="btn btn-secondary" onclick="cancelAddMember()">Cancel</button>
                    </div>
                </div>

                <div class="btn-group btn-group-center">
                    <button class="btn btn-success btn-full" id="showAddMemberBtn" onclick="showAddMemberForm()">
                        âž• Add Family Member
                    </button>
                </div>
            </div>
        </div>

        <!-- Planning & Reminders Section -->
        <div class="card" id="planning">
            <h2>ðŸ“… Planning & Reminders</h2>
            <p>Manage your appointments, medications, and vaccination records</p>

            <!-- Planning Tabs -->
            <div class="planning-tabs">
                <div class="planning-tab active" onclick="switchPlanningTab('appointments')">ðŸ¥ Appointments</div>
                <div class="planning-tab" onclick="switchPlanningTab('medications')">ðŸ’Š Medications</div>
                <div class="planning-tab" onclick="switchPlanningTab('vaccinations')">ðŸ’‰ Vaccinations</div>
            </div>

            <!-- Appointments Tab -->
            <div class="planning-content active" id="appointments">
                <div class="appointment-form">
                    <h3>ðŸ“… Add New Appointment</h3>
                    <form id="appointmentForm">
                        <div class="grid">
                            <div class="form-group">
                                <label>Doctor's Name *</label>
                                <input type="text" class="form-control" id="appointmentDoctor" required>
                            </div>
                            <div class="form-group">
                                <label>Date *</label>
                                <input type="date" class="form-control" id="appointmentDate" required>
                            </div>
                        </div>
                        <div class="grid">
                            <div class="form-group">
                                <label>Time *</label>
                                <input type="time" class="form-control" id="appointmentTime" required>
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea class="form-control" id="appointmentNotes" rows="3" placeholder="Any additional notes..."></textarea>
                            </div>
                        </div>
                        <div class="btn-group btn-group-center">
                            <button type="submit" class="btn btn-primary btn-full">Add Appointment</button>
                        </div>
                    </form>
                </div>

                <h3>ðŸ“‹ Upcoming Appointments</h3>
                <div id="appointmentsList">
                    <!-- Appointments will be displayed here -->
                </div>
            </div>

            <!-- Medications Tab -->
            <div class="planning-content" id="medications">
                <div class="medication-form">
                    <h3>ðŸ’Š Add Medication Reminder</h3>
                    <form id="medicationForm">
                        <div class="grid">
                            <div class="form-group">
                                <label>Medication Name *</label>
                                <input type="text" class="form-control" id="medicationName" required>
                            </div>
                            <div class="form-group">
                                <label>Dosage *</label>
                                <input type="text" class="form-control" id="medicationDosage" placeholder="e.g., 1 tablet, 10mg" required>
                            </div>
                        </div>
                        <div class="grid">
                            <div class="form-group">
                                <label>Time of Day *</label>
                                <input type="time" class="form-control" id="medicationTime" required>
                            </div>
                            <div class="form-group">
                                <label>Frequency</label>
                                <select class="form-control" id="medicationFrequency">
                                    <option value="daily">Daily</option>
                                    <option value="twice-daily">Twice Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="as-needed">As Needed</option>
                                </select>
                            </div>
                        </div>
                        <div class="btn-group btn-group-center">
                            <button type="submit" class="btn btn-primary btn-full">Add Medication</button>
                        </div>
                    </form>
                </div>

                <h3>ðŸ’Š Active Medication Reminders</h3>
                <div id="medicationsList">
                    <!-- Medications will be displayed here -->
                </div>
            </div>

            <!-- Vaccinations Tab -->
            <div class="planning-content" id="vaccinations">
                <div class="vaccination-upload">
                    <h3>ðŸ’‰ Upload Vaccination Card</h3>
                    <p>Upload a photo of your vaccination card for digital backup</p>
                    <input type="file" id="vaccinationCard" accept="image/*" style="display: none;">
                    <div class="btn-group btn-group-center">
                        <button class="btn btn-secondary btn-full" onclick="document.getElementById('vaccinationCard').click()">ðŸ“· Upload Photo</button>
                    </div>
                    
                    <div class="vaccination-preview" id="vaccinationPreview" style="display: none;">
                        <h4>Preview:</h4>
                        <img id="vaccinationPreviewImg" alt="Vaccination card preview">
                    </div>
                </div>

                <div class="vaccination-form">
                    <h3>ðŸ’‰ Add Vaccination Record</h3>
                    <form id="vaccinationForm">
                        <div class="grid">
                            <div class="form-group">
                                <label>Vaccine Name *</label>
                                <input type="text" class="form-control" id="vaccineName" required>
                            </div>
                            <div class="form-group">
                                <label>Date *</label>
                                <input type="date" class="form-control" id="vaccineDate" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select class="form-control" id="vaccineType">
                                <option value="completed">Completed</option>
                                <option value="upcoming">Upcoming</option>
                            </select>
                        </div>
                        <div class="btn-group btn-group-center">
                            <button type="submit" class="btn btn-primary btn-full">Add Vaccination</button>
                        </div>
                    </form>
                </div>

                <h3>ðŸ“… Vaccination Timeline</h3>
                <div class="vaccination-timeline" id="vaccinationTimeline">
                    <!-- Vaccination timeline will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Shop Section -->
        <div class="card" id="shop">
            <div class="shop-header">
                <h2>ðŸ›ï¸ DiagKnows Pharmacy</h2>
                <p>Your trusted source for health and wellness products</p>
            </div>

            <!-- Shop Banner -->
            <div class="shop-banner">
                <h3>ðŸŒŸ Premium Members Save 15%!</h3>
                <p>Upgrade to Premium for exclusive discounts on all products</p>
            </div>

            <!-- AI Recommended Section -->
            <div class="recommended-section" id="recommendedSection" style="display: none;">
                <h3>ðŸ©º Recommended for You</h3>
                <p>Based on your recent AI diagnosis</p>
                <div id="recommendedProducts" class="products-grid">
                    <!-- Recommended products will be dynamically added here -->
                </div>
            </div>

            <!-- Recommendations Section -->
            <div class="recommendations-section" id="recommendationsSection" style="display: none;">
                <div class="recommendations-header">
                    <div class="recommendations-icon">ðŸ’¡</div>
                    <h3>Recommended for You</h3>
                </div>
                <p>Based on your symptoms, we suggest the following items:</p>
                <div id="recommendationsList" class="shop-grid">
                    <!-- Recommendations will be displayed here -->
                </div>
                <div class="recommendations-actions">
                    <button class="btn btn-primary" onclick="scrollToRecommendedItems()">ðŸ›’ Buy Suggested Items</button>
                </div>
            </div>

            <!-- Shop Filters -->
            <div class="shop-filters">
                <div class="filter-btn active" onclick="filterProducts('all')">All Products</div>
                <div class="filter-btn" onclick="filterProducts('monitoring')">Monitoring</div>
                <div class="filter-btn" onclick="filterProducts('emergency')">Emergency</div>
                <div class="filter-btn" onclick="filterProducts('pain')">Pain Relief</div>
                <div class="filter-btn" onclick="filterProducts('cold')">Cold & Flu</div>
                <div class="filter-btn" onclick="filterProducts('allergy')">Allergies</div>
                <div class="filter-btn" onclick="filterProducts('vitamins')">Vitamins</div>
                <div class="filter-btn" onclick="filterProducts('first-aid')">First Aid</div>
            </div>

            <!-- Products Grid -->
            <div class="shop-grid" id="productsGrid">
                <!-- Products will be dynamically generated here -->
            </div>

            <!-- Cart Section -->
            <div class="cart-section" id="cartSection" style="display: none;">
                <div class="cart-header">
                    <div class="cart-title">ðŸ›’ Your Cart</div>
                    <div class="cart-count" id="cartCount">0 items</div>
                </div>
                <div id="cartItems">
                    <!-- Cart items will be displayed here -->
                </div>
                <div class="cart-total">
                    <div class="total-amount" id="cartTotal">Total: $0.00</div>
                    <button class="btn-checkout" onclick="checkout()">Checkout</button>
                </div>
            </div>

            <!-- Delivery Details Section -->
            <div class="delivery-details-section" id="deliveryDetailsSection" style="display: none;">
                <div class="delivery-header">
                    <h3>ðŸ“¦ Delivery & Shipping</h3>
                    <p>Track your medicine orders and manage shipping preferences</p>
                </div>

                <!-- Map Display -->
                <div class="map-container">
                    <div id="mapDisplay">
                        <!-- Map will be loaded here -->
                    </div>
                </div>

                <!-- Shipping Information -->
                <div class="shipping-info">
                    <h4>ðŸ“ Shipping Address</h4>
                    <div id="shippingAddressDisplay">
                        <!-- Shipping address will be displayed here -->
                    </div>
                    
                    <div class="delivery-estimate">
                        <div class="estimate-header">
                            <div class="estimate-icon">ðŸšš</div>
                            <div class="estimate-title">Estimated Delivery</div>
                        </div>
                        <div class="estimate-details">
                            Standard shipping: 2-4 business days<br>
                            Express shipping: 1-2 business days (Premium only)
                        </div>
                    </div>
                    
                    <button class="btn-confirm-shipping" onclick="confirmShippingAddress()">
                        âœ… Confirm Shipping Address
                    </button>
                </div>

                <!-- Shipping History -->
                <div class="shipping-history">
                    <h4>ðŸ“‹ Shipping History</h4>
                    <div id="shippingHistory">
                        <!-- Shipping history will be displayed here -->
                    </div>
                </div>
            </div>
        </div>



        <!-- Settings Section -->
        <div class="card" id="settings">
            <h2>Settings</h2>
            <div class="form-group">
                <label>Language</label>
                <select class="form-control" id="settingsLanguage">
                    <option value="en">English</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="settingsNotifications" checked>
                    Enable Push Notifications
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="settingsPremium">
                    Premium Subscription
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="settingsFamilyPlan">
                    Family Plan Subscription
                </label>
            </div>
            <button class="btn" onclick="saveSettings()">Save Settings</button>
        </div>

        <!-- Terms Section -->
        <div class="card" id="terms">
            <h2>Terms & Conditions & Privacy Policy for DiagKnows</h2>
            <div class="terms-content" style="max-height: 60vh; overflow-y: auto; padding: 1rem;">
                <p><strong>Last Updated:</strong> 8/2/2025</p>
                <p>Welcome to DiagKnows. These Terms & Conditions and Privacy Policy outline the rules and limitations for using our health guidance app. By using this app, you agree to these terms. If you do not agree, please do not use the app.</p>

                <h3>ðŸ”¹ 1. General Information</h3>
                <p>DiagKnows is designed to provide basic health guidance, including symptom analysis and dosage suggestions, using AI. It is meant for educational and informational purposes only.</p>

                <h3>ðŸ”¹ 2. No Medical Advice</h3>
                <ul>
                    <li>This app does not provide professional medical advice.</li>
                    <li>All content, including AI-generated diagnoses and dosage suggestions, is intended for general information and should not be considered medical instructions.</li>
                    <li>Always consult a licensed medical professional before taking medication or making health-related decisions.</li>
                </ul>

                <h3>ðŸ”¹ 3. Privacy Policy â€“ We Respect Your Privacy</h3>
                <ul>
                    <li>âœ… We do not collect, store, or share any personally identifiable information (PII).</li>
                    <li>âœ… Any symptom or health input is processed locally or temporarily and is not saved.</li>
                    <li>âœ… We do not track your device, location, or identity.</li>
                    <li>âœ… We do not share data with third parties, advertisers, or marketers.</li>
                </ul>
                <p>If the app includes any analytics in the future, it will only be based on anonymized, non-identifiable usage statistics, such as:</p>
                <ul>
                    <li>Number of users per day</li>
                    <li>Most common symptoms (without user identity)</li>
                </ul>

                <h3>ðŸ”¹ 4. Data Security</h3>
                <p>Since we do not collect personal data, there's no sensitive information stored on our servers. If any local data is saved (e.g., reminders or history), it stays only on your device, unless you explicitly choose to back it up.</p>

                <h3>ðŸ”¹ 5. User Responsibility</h3>
                <ul>
                    <li>Do not rely on the app for emergencies or urgent care.</li>
                    <li>If your condition worsens or does not improve, contact a doctor immediately.</li>
                    <li>Use over-the-counter medications only as directed by packaging or a healthcare professional.</li>
                </ul>

                <h3>ðŸ”¹ 6. Limitation of Liability</h3>
                <p>We provide this app "as-is" with no warranties of any kind. We are not liable for:</p>
                <ul>
                    <li>Misinterpretation of app suggestions</li>
                    <li>Harm caused by incorrect self-medication</li>
                    <li>Failure to seek appropriate medical help</li>
                </ul>
                <p>Your use of the app is entirely at your own risk.</p>

                <h3>ðŸ”¹ 7. Future Updates</h3>
                <p>We may improve the app over time. If we ever decide to collect personal information (e.g., to create accounts or save your history across devices), we will:</p>
                <ul>
                    <li>Explicitly notify you</li>
                    <li>Update this policy</li>
                    <li>Request your clear consent</li>
                </ul>

                <h3>ðŸ”¹ 8. Contact Us</h3>
                <p>If you have any questions or concerns about our policies, feel free to contact us:</p>
                <p>ðŸ“§ Email: <a href="mailto:support@diagknows.com" style="color: var(--primary); text-decoration: none;">support@diagknows.com</a></p>

                <p style="margin-top: 2rem; padding: 1rem; background: var(--light); border-radius: var(--radius); border-left: 4px solid var(--primary);"><strong>By using DiagKnows, you agree to these Terms & Conditions and Privacy Policy. Thank you for trusting us to support your health journey.</strong></p>
            </div>
        </div>
    </div>

            <!-- Modal for Premium Upgrade -->
        <div class="modal" id="premiumModal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>Upgrade to Premium</h2>
                <p>Unlock advanced features including personalized health insights, video guides, and faster AI analysis.</p>
                <button class="btn" onclick="upgradeToPremium()">Start 7-Day Free Trial</button>
            </div>
        </div>

        <!-- Modal for Authentication Required -->
        <div class="modal" id="authModal">
            <div class="modal-content">
                <span class="close" onclick="closeAuthModal()">&times;</span>
                <h2>ðŸ”’ Authentication Required</h2>
                <p>You must be logged in to access this feature.</p>
                <div style="text-align: center; margin-top: 1.5rem;">
                    <button class="btn" onclick="showSection('login')">Login</button>
                    <button class="btn btn-secondary" onclick="showSection('signup')">Sign Up</button>
                </div>
            </div>
        </div>

    <script>
        // Global variables
        let currentUser = null;
        let isPremium = false;
        let isFamilyPlan = false;
        let isLoggedIn = false; // Authentication state
        let chatHistory = [];
        let currentQuestion = 0;
        let userSymptoms = {};
        let detectedCondition = '';
        let conversationPath = 'general';
        let followUpQuestions = [];
        let emergencyFlag = false;
        let typingInterval = null;
        let currentLanguage = 'en';
        let isDarkMode = false;
        let notificationInterval;
        let recognition = null;
        let registeredUsers = []; // Store registered users for validation
        let familyMembers = []; // Store family members
        let appointments = []; // Store appointments
        let medications = []; // Store medications
        let vaccinations = []; // Store vaccinations
        let cart = []; // Store cart items
        let products = []; // Store products
        let currentFilter = 'all'; // Current filter
        let shippingHistory = []; // Store shipping history
        let userAllergies = []; // Store user allergies
        let feedbackShown = false; // Track if feedback has been shown in current session
        let askedQuestions = new Set(); // Track which questions have been asked to prevent duplicates
        let currentSymptom = null; // Track the current symptom being handled
        let symptomFollowUpAsked = false; // Track if follow-up for current symptom has been asked
        let sleepEnergyQuestionAnswered = false; // Track if sleep/appetite/energy question has been answered
        let sleepAppetiteEnergyAsked = false; // Track if sleep/appetite/energy question has been asked
        let sleepAppetiteEnergyAnswered = false; // Track if sleep/appetite/energy question has been answered
        let sleepAppetiteEnergyQuestionShown = false; // Track if sleep/appetite/energy question has been displayed
        let sleepAppetiteEnergyAlreadyAsked = false; // Track if sleep/appetite/energy question has already been asked
        let lastQuestionAsked = null; // Store the last question text to prevent duplicates

        // Translation mappings
        const translations = {
            en: {
                welcome: "Welcome to DiagKnows",
                chatbot: "AI Chatbot",
                symptoms: "What symptoms are you experiencing?",
                save: "Save",
                send: "Send",
                login: "Login",
                signup: "Sign Up"
            },
            es: {
                welcome: "Bienvenido a DiagKnows",
                chatbot: "Chatbot IA",
                symptoms: "Â¿QuÃ© sÃ­ntomas estÃ¡s experimentando?",
                save: "Guardar",
                send: "Enviar",
                login: "Iniciar sesiÃ³n",
                signup: "Registrarse"
            },
            fr: {
                welcome: "Bienvenue sur DiagKnows",
                chatbot: "Chatbot IA",
                symptoms: "Quels symptÃ´mes ressentez-vous?",
                save: "Sauvegarder",
                send: "Envoyer",
                login: "Connexion",
                signup: "S'inscrire"
            }
        };

        // Enhanced questions for the chatbot with comprehensive health assessment
        const questions = [
            "What symptoms are you experiencing? (e.g., fever, cough, headache, fatigue, stomach pain, chest pain)",
            "How long have you had these symptoms? (hours/days/weeks)",
            "Do you have any known medical conditions?",
            "Are you currently taking any medication?",
            "Do you have any known allergies to medications or substances? (e.g., Penicillin, Ibuprofen, Aspirin, Sulfa drugs)",
            "Can you provide any vital signs? (pulse, blood pressure, temperature, blood glucose)",
            "Do you or your immediate family have a history of any of the following?",
            "Have you been feeling unusually sad, hopeless, or disinterested in activities?",
            "What is your vaccination status? (COVID, flu, etc.)",
            "How has your sleep, appetite, and energy level been?"
        ];

        // Enhanced branching logic for dynamic conversations
        const conversationBranches = {
            "fever": {
                followUp: "How high is your temperature?",
                options: ["Below 100Â°F", "100-102Â°F", "Above 102Â°F", "Don't know"],
                nextBranch: "fever_severity"
            },
            "cough": {
                followUp: "Is the cough dry or productive (bringing up mucus)?",
                options: ["Dry cough", "Productive cough", "Both", "Not sure"],
                nextBranch: "cough_type"
            },
            "headache": {
                followUp: "Where is the pain located?",
                options: ["Front of head", "Back of head", "One side", "All over", "Not sure"],
                nextBranch: "headache_location"
            },
            "chest_pain": {
                followUp: "Does the pain worsen when breathing deeply?",
                options: ["Yes", "No", "Sometimes", "Not sure"],
                nextBranch: "chest_pain_breathing",
                emergency: true
            },
            "shortness_breath": {
                followUp: "When did this start?",
                options: ["Suddenly", "Gradually", "During exercise", "At rest", "Not sure"],
                nextBranch: "breath_timing",
                emergency: true
            },
            "stomach_pain": {
                followUp: "Is the pain sharp, dull, or cramping?",
                options: ["Sharp", "Dull", "Cramping", "Mixed", "Not sure"],
                nextBranch: "stomach_pain_type"
            },
            "fatigue": {
                followUp: "How severe is your fatigue?",
                options: ["Mild", "Moderate", "Severe", "Extreme"],
                nextBranch: "fatigue_severity"
            }
        };

        // Follow-up question logic
        const followUpLogic = {
            "fever_severity": {
                "Above 102Â°F": {
                    response: "A high fever requires attention. Do you also have chills or body aches?",
                    options: ["Yes", "No", "Not sure"],
                    emergency: true
                },
                "100-102Â°F": {
                    response: "A moderate fever. Are you experiencing any other symptoms?",
                    options: ["Yes", "No"],
                    nextBranch: "fever_symptoms"
                }
            },
            "cough_type": {
                "Productive cough": {
                    response: "A productive cough with mucus. What color is the mucus?",
                    options: ["Clear/White", "Yellow", "Green", "Blood-tinged", "Not sure"],
                    emergency: function(color) { return color === "Blood-tinged"; }
                }
            },
            "chest_pain_breathing": {
                "Yes": {
                    response: "âš ï¸ Chest pain that worsens with breathing could indicate a serious condition. Do you also have shortness of breath?",
                    options: ["Yes", "No", "Not sure"],
                    emergency: true
                }
            }
        };

        // Function to calculate disease probabilities based on symptoms
        function calculateDiseaseProbabilities(symptoms, vitalSigns, familyHistory, bmi) {
            const diseaseDatabase = {
                'Acute Bronchitis': {
                    symptoms: ['cough', 'chest congestion', 'mucus', 'fatigue', 'mild fever', 'shortness of breath'],
                    description: 'Inflammation of the bronchial tubes, often caused by viral infection',
                    otcOptions: ['Cough suppressant', 'Expectorant', 'Acetaminophen', 'Rest'],
                    warnings: ['See doctor if symptoms persist beyond 10 days']
                },
                'Influenza': {
                    symptoms: ['fever', 'body aches', 'fatigue', 'headache', 'cough', 'sore throat', 'chills'],
                    description: 'Viral respiratory infection with sudden onset of symptoms',
                    otcOptions: ['Acetaminophen', 'Ibuprofen', 'Rest', 'Fluids'],
                    warnings: ['Seek medical care if high fever or difficulty breathing']
                },
                'Mild COVID-19': {
                    symptoms: ['fever', 'cough', 'fatigue', 'loss of taste', 'loss of smell', 'sore throat'],
                    description: 'Viral respiratory infection with varying symptom severity',
                    otcOptions: ['Acetaminophen', 'Rest', 'Fluids', 'Monitor oxygen levels'],
                    warnings: ['Seek immediate care if difficulty breathing or chest pain']
                },
                'Common Cold': {
                    symptoms: ['runny nose', 'congestion', 'sneezing', 'sore throat', 'mild cough'],
                    description: 'Viral upper respiratory infection',
                    otcOptions: ['Decongestant', 'Cough medicine', 'Rest', 'Fluids'],
                    warnings: ['Symptoms should improve within 7-10 days']
                },
                'Allergic Rhinitis': {
                    symptoms: ['sneezing', 'runny nose', 'itchy eyes', 'congestion', 'post-nasal drip'],
                    description: 'Allergic reaction causing nasal and eye symptoms',
                    otcOptions: ['Antihistamine', 'Nasal spray', 'Eye drops'],
                    warnings: ['Avoid known allergens']
                },
                'Gastroenteritis': {
                    symptoms: ['nausea', 'vomiting', 'diarrhea', 'stomach cramps', 'fever'],
                    description: 'Inflammation of the stomach and intestines',
                    otcOptions: ['Anti-diarrheal', 'Electrolyte replacement', 'Bland diet'],
                    warnings: ['Seek care if severe dehydration or blood in stool']
                },
                'Tension Headache': {
                    symptoms: ['headache', 'pressure around head', 'neck tension', 'stress'],
                    description: 'Common headache type often related to stress or muscle tension',
                    otcOptions: ['Acetaminophen', 'Ibuprofen', 'Rest', 'Stress management'],
                    warnings: ['See doctor if severe or persistent headaches']
                },
                'Urinary Tract Infection': {
                    symptoms: ['frequent urination', 'burning sensation', 'cloudy urine', 'pelvic pain'],
                    description: 'Bacterial infection of the urinary system',
                    otcOptions: ['Cranberry supplements', 'Increased fluids'],
                    warnings: ['Requires antibiotic treatment - see doctor']
                },
                'Anxiety': {
                    symptoms: ['worry', 'restlessness', 'rapid heartbeat', 'sweating', 'difficulty concentrating'],
                    description: 'Mental health condition with excessive worry and physical symptoms',
                    otcOptions: ['Deep breathing exercises', 'Meditation', 'Regular exercise'],
                    warnings: ['Consider speaking with a mental health professional']
                },
                'Depression': {
                    symptoms: ['sadness', 'loss of interest', 'fatigue', 'sleep changes', 'appetite changes'],
                    description: 'Mental health condition affecting mood and daily functioning',
                    otcOptions: ['Regular exercise', 'Social support', 'Sleep hygiene'],
                    warnings: ['Seek professional mental health support']
                },
                'Hypertension': {
                    symptoms: ['headache', 'dizziness', 'chest pain', 'shortness of breath'],
                    description: 'High blood pressure, often asymptomatic',
                    otcOptions: ['Lifestyle changes', 'Stress reduction'],
                    warnings: ['Requires medical evaluation and treatment']
                },
                'Diabetes': {
                    symptoms: ['increased thirst', 'frequent urination', 'fatigue', 'blurred vision'],
                    description: 'Metabolic disorder affecting blood sugar regulation',
                    otcOptions: ['Blood glucose monitoring', 'Diet management'],
                    warnings: ['Requires medical diagnosis and treatment']
                }
            };
            
            const matches = [];
            const symptomsLower = symptoms.toLowerCase();
            const symptomWords = symptomsLower.split(/\s+/);
            
            // Calculate match percentage for each disease
            for (const [disease, data] of Object.entries(diseaseDatabase)) {
                let matchCount = 0;
                const totalSymptoms = data.symptoms.length;
                
                // Check each symptom against user input
                data.symptoms.forEach(symptom => {
                    if (symptomsLower.includes(symptom) || symptomWords.some(word => symptom.includes(word))) {
                        matchCount++;
                    }
                });
                
                // Calculate percentage match
                const matchPercentage = Math.round((matchCount / totalSymptoms) * 100);
                
                // Only include diseases with at least 20% match
                if (matchPercentage >= 20) {
                    matches.push({
                        disease: disease,
                        percentage: matchPercentage,
                        description: data.description,
                        otcOptions: data.otcOptions,
                        warnings: data.warnings,
                        matchedSymptoms: matchCount,
                        totalSymptoms: totalSymptoms
                    });
                }
            }
            
            // Factor in vital signs if available
            if (vitalSigns) {
                matches.forEach(match => {
                    // Adjust probability based on vital signs
                    if (vitalSigns.temperature && vitalSigns.temperature > 100.4) {
                        if (match.disease.includes('Fever') || match.disease.includes('Influenza') || match.disease.includes('COVID')) {
                            match.percentage = Math.min(100, match.percentage + 15);
                        }
                    }
                    
                    if (vitalSigns.bloodPressure) {
                        const [systolic, diastolic] = vitalSigns.bloodPressure.split('/').map(Number);
                        if (systolic > 140 || diastolic > 90) {
                            if (match.disease.includes('Hypertension')) {
                                match.percentage = Math.min(100, match.percentage + 20);
                            }
                        }
                    }
                    
                    if (vitalSigns.pulse && vitalSigns.pulse > 100) {
                        if (match.disease.includes('Anxiety')) {
                            match.percentage = Math.min(100, match.percentage + 10);
                        }
                    }
                });
            }
            
            // Factor in family history if available
            if (familyHistory) {
                matches.forEach(match => {
                    if (familyHistory.diabetes && match.disease.includes('Diabetes')) {
                        match.percentage = Math.min(100, match.percentage + 15);
                    }
                    if (familyHistory.hypertension && match.disease.includes('Hypertension')) {
                        match.percentage = Math.min(100, match.percentage + 15);
                    }
                    if (familyHistory.depression && match.disease.includes('Depression')) {
                        match.percentage = Math.min(100, match.percentage + 10);
                    }
                });
            }
            
            // Factor in BMI if available
            if (bmi) {
                matches.forEach(match => {
                    if (bmi > 30 && (match.disease.includes('Diabetes') || match.disease.includes('Hypertension'))) {
                        match.percentage = Math.min(100, match.percentage + 10);
                    }
                });
            }
            
            // Sort by match percentage (highest first)
            matches.sort((a, b) => b.percentage - a.percentage);
            
            return matches;
        }
        
        // Comprehensive Disease Database for AI Symptom Analysis
        const diseaseLogic = {
            // Respiratory Symptoms
            "fever": {
                conditions: ["flu", "cold", "infection", "COVID-19", "strep throat", "mononucleosis", "pneumonia", "bronchitis", "sinusitis", "ear infection"],
                severity: "moderate",
                treatments: ["rest", "fluids", "acetaminophen", "thermometer monitoring", "ibuprofen"],
                causes: ["viral infection", "bacterial infection", "immune response", "inflammatory conditions"],
                reason: "Common with viral infections and immune responses"
            },
            "cough": {
                conditions: ["cold", "flu", "allergies", "bronchitis", "pneumonia", "asthma", "post-nasal drip", "GERD", "smoking", "COVID-19"],
                severity: "mild",
                treatments: ["honey", "steam", "cough suppressants", "humidifier", "allergy medication"],
                causes: ["viral infection", "allergens", "irritants", "acid reflux", "smoking"],
                reason: "Typical of respiratory infections and allergies"
            },
            "sore throat": {
                conditions: ["strep throat", "cold", "flu", "mononucleosis", "tonsillitis", "allergies", "GERD", "smoking"],
                severity: "mild",
                treatments: ["salt water gargle", "throat lozenges", "warm liquids", "rest", "antibiotics if bacterial"],
                causes: ["viral infection", "bacterial infection", "allergies", "acid reflux"],
                reason: "Common with respiratory infections"
            },
            "runny nose": {
                conditions: ["cold", "allergies", "sinusitis", "flu", "COVID-19", "vasomotor rhinitis"],
                severity: "mild",
                treatments: ["antihistamines", "decongestants", "saline spray", "steam inhalation"],
                causes: ["viral infection", "allergens", "irritants", "weather changes"],
                reason: "Common with respiratory infections and allergies"
            },
            "congestion": {
                conditions: ["cold", "allergies", "sinusitis", "flu", "COVID-19", "deviated septum"],
                severity: "mild",
                treatments: ["decongestants", "saline spray", "steam inhalation", "nasal strips"],
                causes: ["viral infection", "allergens", "irritants", "anatomical factors"],
                reason: "Common with respiratory infections"
            },
            "shortness of breath": {
                conditions: ["asthma", "pneumonia", "anxiety", "heart failure", "COPD", "pulmonary embolism", "anemia", "allergic reaction"],
                severity: "severe",
                treatments: ["inhaler", "medical attention", "oxygen therapy", "emergency care"],
                causes: ["respiratory disease", "cardiac issues", "anxiety", "allergic reaction"],
                reason: "Requires medical evaluation"
            },
            "wheezing": {
                conditions: ["asthma", "bronchitis", "allergic reaction", "COPD", "heart failure", "pneumonia"],
                severity: "moderate",
                treatments: ["inhaler", "bronchodilators", "medical evaluation", "avoiding triggers"],
                causes: ["airway inflammation", "allergies", "respiratory infection"],
                reason: "Indicates airway obstruction"
            },

            // Neurological Symptoms
            "headache": {
                conditions: ["migraine", "tension headache", "dehydration", "sinusitis", "cluster headache", "concussion", "hypertension", "eye strain", "stress"],
                severity: "mild",
                treatments: ["rest", "hydration", "pain relievers", "dark room", "ice pack"],
                causes: ["stress", "dehydration", "eye strain", "sinus pressure", "tension"],
                reason: "Common with stress, dehydration, and sinus issues"
            },
            "migraine": {
                conditions: ["migraine", "cluster headache", "tension headache", "sinus headache", "eye strain"],
                severity: "moderate",
                treatments: ["dark room", "pain relievers", "hydration", "rest", "prescription medication"],
                causes: ["triggers", "hormonal changes", "stress", "diet", "environmental factors"],
                reason: "Neurological condition with specific triggers"
            },
            "dizziness": {
                conditions: ["vertigo", "anemia", "low blood pressure", "inner ear issues", "dehydration", "anxiety", "migraine", "medication side effects"],
                severity: "moderate",
                treatments: ["rest", "hydration", "iron supplements", "balance exercises", "medical evaluation"],
                causes: ["inner ear problems", "low blood pressure", "anemia", "dehydration"],
                reason: "Can be related to balance, blood pressure, or nutrition"
            },
            "vertigo": {
                conditions: ["benign paroxysmal positional vertigo", "Meniere's disease", "vestibular neuritis", "inner ear infection", "migraine"],
                severity: "moderate",
                treatments: ["Epley maneuver", "vestibular exercises", "medication", "medical evaluation"],
                causes: ["inner ear problems", "head injury", "infection", "aging"],
                reason: "Inner ear balance disorder"
            },
            "numbness": {
                conditions: ["carpal tunnel syndrome", "diabetic neuropathy", "pinched nerve", "stroke", "multiple sclerosis", "vitamin deficiency"],
                severity: "moderate",
                treatments: ["medical evaluation", "physical therapy", "medication", "surgery if needed"],
                causes: ["nerve compression", "diabetes", "vitamin deficiency", "neurological conditions"],
                reason: "Indicates nerve or neurological issues"
            },
            "tingling": {
                conditions: ["carpal tunnel syndrome", "diabetic neuropathy", "pinched nerve", "vitamin deficiency", "anxiety", "hyperventilation"],
                severity: "moderate",
                treatments: ["medical evaluation", "vitamin supplements", "stress management", "physical therapy"],
                causes: ["nerve compression", "vitamin deficiency", "anxiety", "diabetes"],
                reason: "Often related to nerve issues or anxiety"
            },

            // Gastrointestinal Symptoms
            "nausea": {
                conditions: ["food poisoning", "migraine", "gastroenteritis", "pregnancy", "GERD", "motion sickness", "anxiety", "medication side effects"],
                severity: "moderate",
                treatments: ["ginger", "small meals", "anti-nausea medication", "bland diet", "rest"],
                causes: ["viral infection", "foodborne illness", "hormonal changes", "anxiety"],
                reason: "Often associated with gastrointestinal issues"
            },
            "vomiting": {
                conditions: ["food poisoning", "gastroenteritis", "migraine", "pregnancy", "appendicitis", "concussion", "medication side effects"],
                severity: "moderate",
                treatments: ["fluids", "rest", "anti-nausea medication", "bland diet", "medical evaluation"],
                causes: ["infection", "foodborne illness", "hormonal changes", "head injury"],
                reason: "Common with gastrointestinal infections"
            },
            "diarrhea": {
                conditions: ["food poisoning", "gastroenteritis", "irritable bowel syndrome", "infection", "lactose intolerance", "celiac disease", "medication side effects"],
                severity: "moderate",
                treatments: ["fluids", "electrolytes", "bland diet", "probiotics", "medical evaluation"],
                causes: ["viral infection", "bacterial infection", "food intolerance", "medication"],
                reason: "Often caused by infections or food issues"
            },
            "constipation": {
                conditions: ["irritable bowel syndrome", "dehydration", "low fiber diet", "medication side effects", "hypothyroidism", "diabetes"],
                severity: "mild",
                treatments: ["fiber", "hydration", "exercise", "laxatives", "diet changes"],
                causes: ["low fiber diet", "dehydration", "lack of exercise", "medication"],
                reason: "Common with diet and lifestyle factors"
            },
            "abdominal pain": {
                conditions: ["appendicitis", "gallstones", "ulcers", "irritable bowel syndrome", "UTI", "food poisoning", "gastritis", "diverticulitis"],
                severity: "moderate",
                treatments: ["medical evaluation", "pain management", "diet changes", "rest"],
                causes: ["infection", "inflammation", "diet", "stress"],
                reason: "Location and type of pain important for diagnosis"
            },
            "heartburn": {
                conditions: ["GERD", "gastritis", "ulcers", "hiatal hernia", "pregnancy", "obesity"],
                severity: "mild",
                treatments: ["antacids", "diet changes", "elevation", "weight loss", "medication"],
                causes: ["acid reflux", "diet", "pregnancy", "obesity"],
                reason: "Common with acid reflux and diet"
            },
            "bloating": {
                conditions: ["irritable bowel syndrome", "lactose intolerance", "celiac disease", "gastritis", "constipation", "overeating"],
                severity: "mild",
                treatments: ["diet changes", "probiotics", "exercise", "smaller meals", "avoiding triggers"],
                causes: ["diet", "food intolerance", "digestive issues", "overeating"],
                reason: "Common with digestive issues"
            },

            // Cardiovascular Symptoms
            "chest pain": {
                conditions: ["angina", "heart attack", "GERD", "anxiety", "costochondritis", "pneumonia", "pulmonary embolism", "panic attack"],
                severity: "severe",
                treatments: ["immediate medical attention", "aspirin", "nitroglycerin", "emergency care"],
                causes: ["heart disease", "acid reflux", "muscle strain", "anxiety"],
                reason: "Requires immediate evaluation - could be cardiac"
            },
            "palpitations": {
                conditions: ["anxiety", "arrhythmia", "anemia", "hyperthyroidism", "dehydration", "caffeine", "medication side effects"],
                severity: "moderate",
                treatments: ["medical evaluation", "stress management", "avoiding triggers", "medication"],
                causes: ["anxiety", "heart conditions", "anemia", "caffeine"],
                reason: "Can indicate heart or anxiety issues"
            },
            "high blood pressure": {
                conditions: ["hypertension", "stress", "obesity", "kidney disease", "thyroid problems", "sleep apnea"],
                severity: "moderate",
                treatments: ["lifestyle changes", "medication", "diet", "exercise", "stress management"],
                causes: ["genetics", "lifestyle", "obesity", "stress"],
                reason: "Requires monitoring and management"
            },

            // Musculoskeletal Symptoms
            "joint pain": {
                conditions: ["arthritis", "bursitis", "tendonitis", "gout", "fibromyalgia", "lupus", "injury", "overuse"],
                severity: "moderate",
                treatments: ["rest", "ice/heat", "anti-inflammatory medication", "physical therapy", "exercise"],
                causes: ["inflammation", "overuse", "age", "autoimmune", "injury"],
                reason: "Common with age and overuse injuries"
            },
            "back pain": {
                conditions: ["muscle strain", "herniated disc", "sciatica", "arthritis", "kidney problems", "poor posture", "injury"],
                severity: "moderate",
                treatments: ["rest", "ice/heat", "stretching", "physical therapy", "posture correction"],
                causes: ["poor posture", "heavy lifting", "age", "injury"],
                reason: "Often related to posture and activity"
            },
            "neck pain": {
                conditions: ["muscle strain", "herniated disc", "arthritis", "poor posture", "whiplash", "stress", "sleep position"],
                severity: "moderate",
                treatments: ["rest", "ice/heat", "stretching", "posture correction", "physical therapy"],
                causes: ["poor posture", "stress", "injury", "sleep position"],
                reason: "Common with posture and stress"
            },
            "shoulder pain": {
                conditions: ["rotator cuff injury", "frozen shoulder", "bursitis", "tendonitis", "arthritis", "injury"],
                severity: "moderate",
                treatments: ["rest", "ice/heat", "physical therapy", "exercise", "medication"],
                causes: ["overuse", "injury", "age", "repetitive motion"],
                reason: "Common with overuse and injury"
            },
            "knee pain": {
                conditions: ["arthritis", "meniscus tear", "ligament injury", "bursitis", "tendonitis", "overuse"],
                severity: "moderate",
                treatments: ["rest", "ice/heat", "physical therapy", "exercise", "weight management"],
                causes: ["overuse", "injury", "age", "weight", "arthritis"],
                reason: "Common with overuse and aging"
            },

            // Genitourinary Symptoms
            "urinary symptoms": {
                conditions: ["UTI", "kidney stones", "prostatitis", "bladder infection", "overactive bladder", "diabetes"],
                severity: "moderate",
                treatments: ["antibiotics", "hydration", "cranberry juice", "medical evaluation"],
                causes: ["bacterial infection", "dehydration", "anatomical factors", "diabetes"],
                reason: "Common in women and older adults"
            },
            "frequent urination": {
                conditions: ["UTI", "diabetes", "overactive bladder", "prostate problems", "pregnancy", "diuretics"],
                severity: "moderate",
                treatments: ["medical evaluation", "bladder training", "medication", "diet changes"],
                causes: ["infection", "diabetes", "pregnancy", "medication"],
                reason: "Can indicate various conditions"
            },
            "painful urination": {
                conditions: ["UTI", "kidney stones", "prostatitis", "bladder infection", "STI", "vaginal infection"],
                severity: "moderate",
                treatments: ["antibiotics", "hydration", "medical evaluation", "pain medication"],
                causes: ["bacterial infection", "STI", "irritation", "stones"],
                reason: "Requires medical evaluation"
            },

            // Dermatological Symptoms
            "skin rash": {
                conditions: ["allergic reaction", "eczema", "psoriasis", "hives", "contact dermatitis", "viral rash", "fungal infection"],
                severity: "mild",
                treatments: ["antihistamines", "topical creams", "avoiding triggers", "medical evaluation"],
                causes: ["allergies", "irritants", "autoimmune", "infection"],
                reason: "Often related to allergies or skin conditions"
            },
            "itching": {
                conditions: ["allergic reaction", "eczema", "psoriasis", "dry skin", "fungal infection", "liver problems", "kidney problems"],
                severity: "mild",
                treatments: ["moisturizer", "antihistamines", "topical creams", "medical evaluation"],
                causes: ["allergies", "dry skin", "infection", "systemic conditions"],
                reason: "Common with skin conditions"
            },
            "acne": {
                conditions: ["acne vulgaris", "hormonal acne", "rosacea", "folliculitis", "allergic reaction"],
                severity: "mild",
                treatments: ["topical treatments", "cleansing", "diet changes", "medical evaluation"],
                causes: ["hormones", "bacteria", "diet", "stress"],
                reason: "Common with hormonal changes"
            },

            // General Symptoms
            "fatigue": {
                conditions: ["flu", "anemia", "stress", "sleep disorder", "thyroid issues", "depression", "diabetes", "chronic fatigue syndrome"],
                severity: "mild",
                treatments: ["rest", "iron supplements", "stress management", "vitamin D", "medical evaluation"],
                causes: ["viral infection", "iron deficiency", "poor sleep", "stress"],
                reason: "Common with viral infections and stress"
            },
            "swelling": {
                conditions: ["edema", "allergic reaction", "infection", "heart failure", "kidney problems", "liver problems", "injury"],
                severity: "moderate",
                treatments: ["elevation", "compression", "medical evaluation", "diuretics"],
                causes: ["fluid retention", "inflammation", "allergic reaction", "organ problems"],
                reason: "Location and cause important for treatment"
            },
            "weight loss": {
                conditions: ["hyperthyroidism", "diabetes", "cancer", "depression", "eating disorders", "malabsorption", "infection"],
                severity: "moderate",
                treatments: ["medical evaluation", "nutritional support", "treatment of underlying cause"],
                causes: ["metabolic disorders", "chronic illness", "mental health", "infection"],
                reason: "May indicate underlying health conditions"
            },
            "weight gain": {
                conditions: ["hypothyroidism", "diabetes", "depression", "medication side effects", "pregnancy", "metabolic syndrome"],
                severity: "mild",
                treatments: ["diet", "exercise", "medical evaluation", "lifestyle changes"],
                causes: ["diet", "lack of exercise", "hormonal changes", "medication"],
                reason: "Common with lifestyle and hormonal factors"
            },
            "night sweats": {
                conditions: ["menopause", "infection", "cancer", "medication side effects", "anxiety", "hyperthyroidism"],
                severity: "moderate",
                treatments: ["medical evaluation", "cooling measures", "treatment of underlying cause"],
                causes: ["hormonal changes", "infection", "medication", "anxiety"],
                reason: "Can indicate various conditions"
            },
            "insomnia": {
                conditions: ["stress", "anxiety", "depression", "sleep apnea", "restless leg syndrome", "medication side effects"],
                severity: "mild",
                treatments: ["sleep hygiene", "stress management", "medical evaluation", "medication"],
                causes: ["stress", "anxiety", "medical conditions", "lifestyle"],
                reason: "Common with stress and medical conditions"
            },
            "depression": {
                conditions: ["major depressive disorder", "bipolar disorder", "seasonal affective disorder", "adjustment disorder", "medical conditions"],
                severity: "moderate",
                treatments: ["therapy", "medication", "lifestyle changes", "medical evaluation"],
                causes: ["genetics", "life events", "medical conditions", "chemical imbalance"],
                reason: "Requires professional evaluation and treatment"
            },
            "anxiety": {
                conditions: ["generalized anxiety disorder", "panic disorder", "social anxiety", "PTSD", "medical conditions"],
                severity: "moderate",
                treatments: ["therapy", "medication", "stress management", "lifestyle changes"],
                causes: ["genetics", "life events", "medical conditions", "stress"],
                reason: "Common mental health condition"
            }
        };

        // Enhanced decision tree with database-driven conversation paths
        const conversationPaths = {
            'headache': {
                followUp: "Based on our medical database, I need to understand your headache better. Is the pain sharp, dull, or throbbing?",
                options: ["Sharp", "Dull", "Throbbing", "Not sure"],
                nextPath: {
                    'sharp': 'headache_sharp',
                    'dull': 'headache_dull',
                    'throbbing': 'headache_throbbing'
                },
                databaseContext: "Headaches can indicate various conditions including migraines, tension headaches, sinusitis, or more serious issues like hypertension or concussion."
            },
            'fever': {
                followUp: "According to our medical database, fever severity helps determine the underlying cause. How high is your temperature?",
                options: ["Below 100Â°F", "100-102Â°F", "Above 102Â°F", "Not sure"],
                nextPath: {
                    'below 100': 'fever_low',
                    '100-102': 'fever_moderate',
                    'above 102': 'fever_high'
                },
                databaseContext: "Fever can indicate viral infections, bacterial infections, inflammatory conditions, or immune responses. Temperature helps determine severity."
            },
            'chest pain': {
                followUp: "This is important - our database shows chest pain can indicate serious conditions. Is the pain crushing, sharp, or dull?",
                options: ["Crushing", "Sharp", "Dull", "Not sure"],
                nextPath: {
                    'crushing': 'chest_emergency',
                    'sharp': 'chest_sharp',
                    'dull': 'chest_dull'
                },
                databaseContext: "Chest pain can indicate cardiac issues, GERD, anxiety, or musculoskeletal problems. Crushing pain often indicates cardiac emergency."
            },
            'shortness of breath': {
                followUp: "Our medical database indicates this could be serious. Did this come on suddenly or gradually?",
                options: ["Suddenly", "Gradually", "Not sure"],
                nextPath: {
                    'suddenly': 'breath_emergency',
                    'gradually': 'breath_gradual'
                },
                databaseContext: "Shortness of breath can indicate asthma, pneumonia, anxiety, heart failure, or pulmonary embolism. Sudden onset often requires immediate attention."
            },
            'stomach pain': {
                followUp: "Based on our database, location helps identify the cause. Where is the pain located?",
                options: ["Upper abdomen", "Lower abdomen", "All over", "Not sure"],
                nextPath: {
                    'upper': 'stomach_upper',
                    'lower': 'stomach_lower',
                    'all over': 'stomach_general'
                },
                databaseContext: "Abdominal pain can indicate appendicitis, gallstones, ulcers, IBS, or other gastrointestinal conditions. Location helps narrow down causes."
            },
            'cough': {
                followUp: "Our database shows coughs can have various causes. Is it dry, productive (with mucus), or accompanied by other symptoms?",
                options: ["Dry cough", "Productive cough", "With other symptoms", "Not sure"],
                nextPath: {
                    'dry': 'cough_dry',
                    'productive': 'cough_productive',
                    'with other': 'cough_complex'
                },
                databaseContext: "Coughs can indicate cold, flu, allergies, bronchitis, pneumonia, asthma, or GERD. Type and accompanying symptoms help determine cause."
            },
            'fatigue': {
                followUp: "Our medical database indicates fatigue can have many causes. How long have you been feeling tired?",
                options: ["Few days", "Few weeks", "Months", "Not sure"],
                nextPath: {
                    'few days': 'fatigue_acute',
                    'few weeks': 'fatigue_subacute',
                    'months': 'fatigue_chronic'
                },
                databaseContext: "Fatigue can indicate viral infections, anemia, stress, sleep disorders, thyroid issues, depression, or chronic conditions."
            },
            'nausea': {
                followUp: "Based on our database, nausea can have various triggers. Is it accompanied by vomiting, fever, or other symptoms?",
                options: ["With vomiting", "With fever", "Alone", "Not sure"],
                nextPath: {
                    'with vomiting': 'nausea_vomiting',
                    'with fever': 'nausea_fever',
                    'alone': 'nausea_isolated'
                },
                databaseContext: "Nausea can indicate food poisoning, migraine, gastroenteritis, pregnancy, GERD, or medication side effects."
            },
            'joint pain': {
                followUp: "Our database shows joint pain can indicate various conditions. Which joints are affected?",
                options: ["Knees", "Shoulders", "Multiple joints", "Not sure"],
                nextPath: {
                    'knees': 'joint_knees',
                    'shoulders': 'joint_shoulders',
                    'multiple': 'joint_multiple'
                },
                databaseContext: "Joint pain can indicate arthritis, bursitis, tendonitis, gout, fibromyalgia, lupus, or overuse injuries."
            },
            'skin rash': {
                followUp: "Based on our medical database, rashes can have various causes. Is it itchy, painful, or accompanied by other symptoms?",
                options: ["Itchy", "Painful", "With other symptoms", "Not sure"],
                nextPath: {
                    'itchy': 'rash_itchy',
                    'painful': 'rash_painful',
                    'with other': 'rash_complex'
                },
                databaseContext: "Skin rashes can indicate allergic reactions, eczema, psoriasis, hives, contact dermatitis, viral rashes, or fungal infections."
            }
        };

        // Emergency symptoms that require immediate attention
                const emergencySymptoms = [
            'chest pain', 'shortness of breath', 'severe confusion',
            'unconsciousness', 'severe bleeding', 'sudden paralysis',
            'severe head injury', 'severe burns', 'poisoning'
        ];

        // Vital signs thresholds
        const vitalThresholds = {
            bloodPressure: { systolic: 180, diastolic: 120 },
            bloodGlucose: 240,
            temperature: 105, // Fahrenheit
            pulse: { min: 50, max: 100 },
            respiration: { min: 12, max: 20 }
        };

        // Family history options
        const familyHistoryOptions = [
            'High blood pressure',
            'Diabetes',
            'High cholesterol',
            'Alcohol/drug abuse',
            'Anemia or blood disorders',
            'Asthma or breathing issues',
            'Arthritis',
            'Cancer',
            'Heart disease',
            'Migraines',
            'Psychiatric disorders',
            'Seizure disorders',
            'Sinus problems',
            'Stroke',
            'Thyroid disease',
            'Tuberculosis'
        ];

        // Condition-specific follow-up questions
        const conditionFollowUps = {
            'headache_sharp': {
                question: "Is the pain on one side of your head?",
                options: ["Yes", "No", "Not sure"],
                emergency: false
            },
            'headache_throbbing': {
                question: "Is the pain worse with movement?",
                options: ["Yes", "No", "Not sure"],
                emergency: false
            },
            'fever_high': {
                question: "Do you have any rash or skin changes?",
                options: ["Yes", "No", "Not sure"],
                emergency: true
            },
            'chest_emergency': {
                question: "Do you also have shortness of breath or sweating?",
                options: ["Yes", "No", "Not sure"],
                emergency: true
            },
            'breath_emergency': {
                question: "Are you experiencing chest pain or dizziness?",
                options: ["Yes", "No", "Not sure"],
                emergency: true
            }
        };

        // Authentication check function
        function checkAuthAndShow(sectionId) {
            if (!isLoggedIn) {
                showAuthModal();
                return false;
            }
            showSection(sectionId);
            return true;
        }

        // Show authentication modal
        function showAuthModal() {
            document.getElementById('authModal').style.display = 'block';
        }

        // Close authentication modal
        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }

        // Update navigation based on login state
        function updateNavigation() {
            const navLogin = document.getElementById('navLogin');
            const navSignup = document.getElementById('navSignup');
            const navLogout = document.getElementById('navLogout');
            const navChatbot = document.getElementById('navChatbot');
            const navCheckin = document.getElementById('navCheckin');
            const navDashboard = document.getElementById('navDashboard');
            const navProfile = document.getElementById('navProfile');
            const navPremium = document.getElementById('navPremium');
            const navFamily = document.getElementById('navFamily');
            const navPlanning = document.getElementById('navPlanning');
            const navShop = document.getElementById('navShop');
            const navSettings = document.getElementById('navSettings');
            
            if (isLoggedIn) {
                navLogin.style.display = 'none';
                navSignup.style.display = 'none';
                navLogout.style.display = 'inline-block';
                navChatbot.style.display = 'block';
                navCheckin.style.display = 'block';
                navDashboard.style.display = 'block';
                navProfile.style.display = 'block';
                navPremium.style.display = 'block';
                navFamily.style.display = 'block';
                navPlanning.style.display = 'block';
                navShop.style.display = 'block';
                navSettings.style.display = 'block';
            } else {
                navLogin.style.display = 'block';
                navSignup.style.display = 'block';
                navLogout.style.display = 'none';
                navChatbot.style.display = 'none';
                navCheckin.style.display = 'none';
                navDashboard.style.display = 'none';
                navProfile.style.display = 'none';
                navPremium.style.display = 'none';
                navFamily.style.display = 'none';
                navPlanning.style.display = 'none';
                navShop.style.display = 'none';
                navSettings.style.display = 'none';
            }
        }

        // Fix spacing issues after login
        function fixSpacingAfterLogin() {
            // Remove margin from all hidden cards
            document.querySelectorAll('.card:not(.active)').forEach(card => {
                card.style.marginBottom = '0';
                card.style.marginTop = '0';
                card.style.padding = '1.5rem';
            });
            
            // Ensure active card has minimal spacing
            const activeCard = document.querySelector('.card.active');
            if (activeCard) {
                activeCard.style.marginBottom = '1rem';
                activeCard.style.marginTop = '0';
            }
            
            // Remove any extra spacing from premium banner if not needed
            const premiumBanner = document.getElementById('premiumBanner');
            if (premiumBanner && isLoggedIn) {
                premiumBanner.style.marginBottom = '0.5rem';
            }
            
            // Ensure container has minimal top margin
            const container = document.querySelector('.container');
            if (container) {
                container.style.marginTop = '0.5rem';
            }
        }

        // Premium trial functionality
        function startPremiumTrial() {
            if (!isLoggedIn) {
                showAuthModal();
                return;
            }
            
            // Simulate premium activation
            isPremium = true;
            currentUser.isPremium = true;
            
            // Store in localStorage
            localStorage.setItem('isPremium', 'true');
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Show success message
            showAlert('ðŸŽ‰ Premium trial activated! You now have access to all premium features for 7 days.', 'success');
            
            // Update premium features visibility
            updatePremiumFeatures();
            
            // Hide premium banner
            const premiumBanner = document.getElementById('premiumBanner');
            if (premiumBanner) {
                premiumBanner.style.display = 'none';
            }
        }

        // Family Plan functionality
        function upgradeToFamilyPlan() {
            if (!isLoggedIn) {
                showAuthModal();
                return;
            }
            
            // Simulate family plan activation
            isFamilyPlan = true;
            currentUser.isFamilyPlan = true;
            
            // Store in localStorage
            localStorage.setItem('isFamilyPlan', 'true');
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Show success message
            showAlert('ðŸŽ‰ Family plan activated! You can now add up to 4 family members.', 'success');
            
            // Update family plan UI
            updateFamilyPlanUI();
        }

        function loadFamilyPlan() {
            // Load family members from localStorage
            familyMembers = JSON.parse(localStorage.getItem('familyMembers') || '[]');
            
            // Update UI based on family plan status
            updateFamilyPlanUI();
            
            // Display existing family members
            displayFamilyMembers();
        }

        function updateFamilyPlanUI() {
            const familyPlanStatus = document.getElementById('familyPlanStatus');
            const familyPlanUpgrade = document.getElementById('familyPlanUpgrade');
            const familyMembersForm = document.getElementById('familyMembersForm');
            
            if (isFamilyPlan) {
                familyPlanStatus.style.display = 'block';
                familyPlanUpgrade.style.display = 'none';
                familyMembersForm.style.display = 'block';
            } else {
                familyPlanStatus.style.display = 'none';
                familyPlanUpgrade.style.display = 'block';
                familyMembersForm.style.display = 'none';
            }
        }

        function displayFamilyMembers() {
            const container = document.getElementById('familyMembersList');
            
            if (familyMembers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--secondary);">No family members added yet.</p>';
                return;
            }
            
            container.innerHTML = familyMembers.map((member, index) => `
                <div class="family-member-card">
                    <div class="family-member-header">
                        <div class="family-member-name">${member.name}</div>
                        <div class="family-member-relationship">${member.relationship}</div>
                    </div>
                    <div class="family-member-details">
                        <div><strong>Age:</strong> ${member.age} years</div>
                        ${member.email ? `<div><strong>Email:</strong> ${member.email}</div>` : ''}
                    </div>
                    <div class="family-member-actions">
                        <button class="btn-remove-member" onclick="removeFamilyMember(${index})">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function showAddMemberForm() {
            const addMemberForm = document.getElementById('addMemberForm');
            const showAddMemberBtn = document.getElementById('showAddMemberBtn');
            
            if (familyMembers.length >= 3) {
                showAlert('You have reached the maximum number of family members (4 total including you).', 'warning');
                return;
            }
            
            addMemberForm.style.display = 'block';
            showAddMemberBtn.style.display = 'none';
        }

        function cancelAddMember() {
            const addMemberForm = document.getElementById('addMemberForm');
            const showAddMemberBtn = document.getElementById('showAddMemberBtn');
            
            addMemberForm.style.display = 'none';
            showAddMemberBtn.style.display = 'block';
            
            // Clear form
            document.getElementById('memberName').value = '';
            document.getElementById('memberAge').value = '';
            document.getElementById('memberEmail').value = '';
            document.getElementById('memberRelationship').value = '';
        }

        function addFamilyMember() {
            const name = document.getElementById('memberName').value.trim();
            const age = document.getElementById('memberAge').value;
            const email = document.getElementById('memberEmail').value.trim();
            const relationship = document.getElementById('memberRelationship').value;
            
            if (!name || !age || !relationship) {
                showAlert('Please fill in all required fields (Name, Age, and Relationship).', 'danger');
                return;
            }
            
            if (familyMembers.length >= 3) {
                showAlert('You have reached the maximum number of family members.', 'warning');
                return;
            }
            
            const newMember = {
                name: name,
                age: parseInt(age),
                email: email,
                relationship: relationship
            };
            
            familyMembers.push(newMember);
            
            // Save to localStorage
            localStorage.setItem('familyMembers', JSON.stringify(familyMembers));
            
            // Update display
            displayFamilyMembers();
            
            // Hide form
            cancelAddMember();
            
            showAlert(`Successfully added ${name} to your family plan!`, 'success');
        }

        function removeFamilyMember(index) {
            const member = familyMembers[index];
            if (confirm(`Are you sure you want to remove ${member.name} from your family plan?`)) {
                familyMembers.splice(index, 1);
                
                // Save to localStorage
                localStorage.setItem('familyMembers', JSON.stringify(familyMembers));
                
                // Update display
                displayFamilyMembers();
                
                showAlert(`${member.name} has been removed from your family plan.`, 'success');
            }
        }

        // Planning & Reminders functionality
        function loadPlanning() {
            // Load data from localStorage
            appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            medications = JSON.parse(localStorage.getItem('medications') || '[]');
            vaccinations = JSON.parse(localStorage.getItem('vaccinations') || '[]');
            
            // Display all data
            displayAppointments();
            displayMedications();
            displayVaccinations();
            
            // Check for medication reminders
            checkMedicationReminders();
        }

        function switchPlanningTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.planning-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.planning-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Appointment functions
        function displayAppointments() {
            const container = document.getElementById('appointmentsList');
            
            if (appointments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--secondary);">No upcoming appointments.</p>';
                return;
            }
            
            // Sort appointments by date
            const sortedAppointments = appointments.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            container.innerHTML = sortedAppointments.map((appointment, index) => {
                const appointmentDate = new Date(appointment.date);
                const formattedDate = appointmentDate.toLocaleDateString();
                const formattedTime = appointment.time;
                
                return `
                    <div class="appointment-card">
                        <div class="appointment-header">
                            <div class="appointment-doctor">${appointment.doctor}</div>
                            <div class="appointment-date">${formattedDate} at ${formattedTime}</div>
                        </div>
                        <div class="appointment-details">
                            <div><strong>Date:</strong> ${formattedDate}</div>
                            <div><strong>Time:</strong> ${formattedTime}</div>
                            ${appointment.notes ? `<div><strong>Notes:</strong> ${appointment.notes}</div>` : ''}
                        </div>
                        <div class="appointment-actions">
                            <button class="btn-remove-appointment" onclick="removeAppointment(${index})">Remove</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function removeAppointment(index) {
            const appointment = appointments[index];
            if (confirm(`Are you sure you want to remove the appointment with ${appointment.doctor}?`)) {
                appointments.splice(index, 1);
                
                // Save to localStorage
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                // Update display
                displayAppointments();
                
                showAlert('Appointment removed successfully!', 'success');
            }
        }

        // Medication functions
        function displayMedications() {
            const container = document.getElementById('medicationsList');
            
            if (medications.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--secondary);">No active medication reminders.</p>';
                return;
            }
            
            container.innerHTML = medications.map((medication, index) => {
                const time = medication.time;
                const frequency = medication.frequency || 'daily';
                
                return `
                    <div class="medication-card">
                        <div class="medication-header">
                            <div class="medication-name">${medication.name}</div>
                            <div class="medication-time">${time}</div>
                        </div>
                        <div class="medication-details">
                            <div><strong>Dosage:</strong> ${medication.dosage}</div>
                            <div><strong>Frequency:</strong> ${frequency}</div>
                        </div>
                        <div class="medication-actions">
                            <button class="btn-remove-medication" onclick="removeMedication(${index})">Remove</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function removeMedication(index) {
            const medication = medications[index];
            if (confirm(`Are you sure you want to remove ${medication.name} from your reminders?`)) {
                medications.splice(index, 1);
                
                // Save to localStorage
                localStorage.setItem('medications', JSON.stringify(medications));
                
                // Update display
                displayMedications();
                
                showAlert('Medication reminder removed successfully!', 'success');
            }
        }

        function checkMedicationReminders() {
            const now = new Date();
            const currentTime = now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0');
            
            medications.forEach(medication => {
                if (medication.time === currentTime) {
                    showNotification(`ðŸ’Š Time to take ${medication.name} - ${medication.dosage}`);
                }
            });
        }

        // Vaccination functions
        function displayVaccinations() {
            const container = document.getElementById('vaccinationTimeline');
            
            if (vaccinations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--secondary);">No vaccination records found.</p>';
                return;
            }
            
            // Sort vaccinations by date
            const sortedVaccinations = vaccinations.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            container.innerHTML = sortedVaccinations.map((vaccination, index) => {
                const vaccineDate = new Date(vaccination.date);
                const formattedDate = vaccineDate.toLocaleDateString();
                const isCompleted = vaccination.type === 'completed';
                
                return `
                    <div class="timeline-item ${isCompleted ? 'completed' : 'upcoming'}">
                        <div class="timeline-icon">${isCompleted ? 'âœ…' : 'ðŸ“…'}</div>
                        <div class="timeline-content">
                            <div class="timeline-vaccine">${vaccination.name}</div>
                            <div class="timeline-date">${formattedDate}</div>
                        </div>
                        <div class="timeline-status ${isCompleted ? 'completed' : 'upcoming'}">
                            ${isCompleted ? 'Completed' : 'Upcoming'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function removeVaccination(index) {
            const vaccination = vaccinations[index];
            if (confirm(`Are you sure you want to remove ${vaccination.name} from your vaccination records?`)) {
                vaccinations.splice(index, 1);
                
                // Save to localStorage
                localStorage.setItem('vaccinations', JSON.stringify(vaccinations));
                
                // Update display
                displayVaccinations();
                
                showAlert('Vaccination record removed successfully!', 'success');
            }
        }

        // Shop functionality
        function loadShop() {
            // Load cart from localStorage
            cart = JSON.parse(localStorage.getItem('cart') || '[]');
            
            // Initialize products
            initializeProducts();
            
            // Display products
            displayProducts();
            
            // Update cart display
            updateCartDisplay();
            
            // Load delivery information
            loadDeliveryInfo();
        }

        function loadDeliveryInfo() {
            // Load shipping history
            shippingHistory = JSON.parse(localStorage.getItem('shippingHistory') || '[]');
            
            // Load user location from profile
            const userLocation = localStorage.getItem('userLocation') || '';
            if (userLocation) {
                localStorage.setItem('userLocation', userLocation);
            }
            
            // Display map
            displayMap(userLocation);
            
            // Display shipping info
            displayShippingInfo(userLocation);
            
            // Display shipping history
            displayShippingHistory();
        }

        function showDeliveryDetails() {
            const deliverySection = document.getElementById('deliveryDetailsSection');
            if (deliverySection) {
                deliverySection.style.display = 'block';
                loadDeliveryInfo();
                
                // Scroll to delivery section
                deliverySection.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function initializeProducts() {
            products = [
                // Monitoring Devices
                {
                    id: 1,
                    name: "Blood Pressure Monitor",
                    description: "Digital automatic BP monitor with large LCD display. Includes carrying case.",
                    price: 89.99,
                    category: "monitoring",
                    icon: "ðŸ©º"
                },
                {
                    id: 2,
                    name: "Blood Sugar Monitor",
                    description: "Glucose meter with 50 test strips included. Fast 5-second results.",
                    price: 45.99,
                    category: "monitoring",
                    icon: "ðŸ©¸"
                },
                {
                    id: 3,
                    name: "Pulse Oximeter",
                    description: "Finger pulse oximeter for oxygen saturation monitoring. Portable design.",
                    price: 29.99,
                    category: "monitoring",
                    icon: "ðŸ’“"
                },
                {
                    id: 4,
                    name: "Digital Thermometer",
                    description: "Fast-reading digital thermometer with backlit display. 10-second readings.",
                    price: 19.99,
                    category: "monitoring",
                    icon: "ðŸŒ¡ï¸"
                },
                
                // Emergency Medications
                {
                    id: 5,
                    name: "EpiPen Auto-Injector",
                    description: "Epinephrine auto-injector for severe allergic reactions. 0.3mg dose.",
                    price: 349.99,
                    category: "emergency",
                    icon: "ðŸ’‰"
                },
                {
                    id: 6,
                    name: "Asthma Inhaler",
                    description: "Albuterol inhaler for asthma relief. 200 puffs per inhaler.",
                    price: 25.99,
                    category: "emergency",
                    icon: "ðŸ’¨"
                },
                
                // First Aid
                {
                    id: 7,
                    name: "First Aid Kit",
                    description: "Comprehensive 100-piece first aid kit for home and travel use.",
                    price: 34.99,
                    category: "first-aid",
                    icon: "ðŸ©¹"
                },
                {
                    id: 8,
                    name: "Antibiotic Ointment",
                    description: "Triple antibiotic ointment for minor cuts and scrapes. 1oz tube.",
                    price: 5.99,
                    category: "first-aid",
                    icon: "ðŸ§´"
                },
                {
                    id: 9,
                    name: "Band-Aids",
                    description: "Assorted adhesive bandages for minor cuts and scrapes. 100 count.",
                    price: 4.99,
                    category: "first-aid",
                    icon: "ðŸ©¹"
                },
                
                // Pain Relief
                {
                    id: 10,
                    name: "Ibuprofen",
                    description: "Anti-inflammatory pain reliever. 200mg tablets, 50 count.",
                    price: 8.99,
                    category: "pain",
                    icon: "ðŸ’Š"
                },
                {
                    id: 11,
                    name: "Tylenol (Acetaminophen)",
                    description: "Pain reliever and fever reducer. 500mg tablets, 100 count.",
                    price: 12.99,
                    category: "pain",
                    icon: "ðŸ’Š"
                },
                
                // Cold & Flu
                {
                    id: 12,
                    name: "Cold & Flu Medicine",
                    description: "Multi-symptom cold and flu relief. Day and night formula. 24 tablets.",
                    price: 11.99,
                    category: "cold",
                    icon: "ðŸ¤§"
                },
                {
                    id: 13,
                    name: "Cough Syrup",
                    description: "Relieves cough and chest congestion. 4oz bottle.",
                    price: 6.99,
                    category: "cold",
                    icon: "ðŸ¯"
                },
                {
                    id: 14,
                    name: "Decongestant",
                    description: "Relieves nasal congestion and sinus pressure. 12 tablets.",
                    price: 7.99,
                    category: "cold",
                    icon: "ðŸ’Š"
                },
                
                // Allergies
                {
                    id: 15,
                    name: "Antihistamines",
                    description: "Loratadine tablets for allergy relief. Non-drowsy formula. 30 tablets.",
                    price: 9.99,
                    category: "allergy",
                    icon: "ðŸŒ¸"
                },
                {
                    id: 16,
                    name: "Benadryl",
                    description: "Diphenhydramine for severe allergy symptoms. 25mg tablets, 24 count.",
                    price: 7.99,
                    category: "allergy",
                    icon: "ðŸ’Š"
                },
                
                // Vitamins & Supplements
                {
                    id: 17,
                    name: "Vitamin C",
                    description: "Immune system support. 1000mg tablets, 60 count.",
                    price: 15.99,
                    category: "vitamins",
                    icon: "ðŸŠ"
                },
                {
                    id: 18,
                    name: "Multivitamin",
                    description: "Complete daily vitamin and mineral supplement. 60 tablets.",
                    price: 18.99,
                    category: "vitamins",
                    icon: "ðŸ’Š"
                },
                {
                    id: 19,
                    name: "Electrolyte Packets",
                    description: "Oral rehydration solution. 10 individual packets for hydration.",
                    price: 12.99,
                    category: "vitamins",
                    icon: "ðŸ’§"
                },
                {
                    id: 20,
                    name: "Zinc Supplements",
                    description: "Immune support and wound healing. 50mg tablets, 30 count.",
                    price: 9.99,
                    category: "vitamins",
                    icon: "ðŸ’ª"
                }
            ];
        }

        function displayProducts() {
            const container = document.getElementById('productsGrid');
            const filteredProducts = currentFilter === 'all' ? products : products.filter(p => p.category === currentFilter);
            
            container.innerHTML = filteredProducts.map(product => {
                const discount = isPremium ? 0.20 : 0; // Increased to 20% discount
                const discountedPrice = product.price * (1 - discount);
                const isDiscounted = discount > 0;
                const conflictingAllergies = getConflictingAllergies(product);
                const hasAllergyWarning = conflictingAllergies.length > 0;
                
                return `
                    <div class="medicine-card ${hasAllergyWarning ? 'allergy-warning' : ''}">
                        <div class="medicine-image">
                            ${product.icon}
                        </div>
                        <div class="medicine-info">
                            <div class="medicine-name">${product.name}</div>
                            <div class="medicine-description">${product.description}</div>
                            ${hasAllergyWarning ? `
                                <div class="allergy-warning-badge">
                                    âš ï¸ Allergy Warning: May not be safe for you due to allergy to ${conflictingAllergies.join(', ')}
                                </div>
                            ` : ''}
                            <div class="medicine-price">
                                ${isDiscounted ? `
                                    <div class="price-discounted">$${discountedPrice.toFixed(2)}</div>
                                    <div class="price-original">$${product.price.toFixed(2)}</div>
                                    <div class="premium-badge">Premium Discount Applied!</div>
                                ` : `
                                    <div class="price-regular">$${product.price.toFixed(2)}</div>
                                `}
                            </div>
                            <button class="btn-add-cart ${hasAllergyWarning ? 'btn-warning' : ''}" onclick="addToCart(${product.id})">
                                ${hasAllergyWarning ? 'âš ï¸ Add to Cart (Check with Doctor)' : 'Add to Cart'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterProducts(category) {
            currentFilter = category;
            
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Display filtered products
            displayProducts();
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // Check for allergy conflicts
            const conflictingAllergies = getConflictingAllergies(product);
            if (conflictingAllergies.length > 0) {
                const confirmAdd = confirm(`Warning: You're allergic to ${conflictingAllergies.join(', ')}. Please consult a doctor before using this medicine. Do you still want to add this to your cart?`);
                if (!confirmAdd) {
                    return;
                }
            }
            
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                const discount = isPremium ? 0.20 : 0; // Increased to 20% discount
                const discountedPrice = product.price * (1 - discount);
                
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: discountedPrice,
                    originalPrice: product.price,
                    quantity: 1
                });
            }
            
            // Save to localStorage
            localStorage.setItem('cart', JSON.stringify(cart));
            
            // Update display
            updateCartDisplay();
            displayProducts();
            
            showAlert(`${product.name} added to cart!`, 'success');
        }

        function updateCartDisplay() {
            const cartSection = document.getElementById('cartSection');
            const cartItems = document.getElementById('cartItems');
            const cartCount = document.getElementById('cartCount');
            const cartTotal = document.getElementById('cartTotal');
            
            if (cart.length === 0) {
                cartSection.style.display = 'none';
                return;
            }
            
            cartSection.style.display = 'block';
            cartCount.textContent = `${cart.length} items`;
            
            cartItems.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">$${item.price.toFixed(2)} each</div>
                    </div>
                    <div class="cart-item-quantity">
                        <button class="quantity-btn" onclick="updateQuantity(${item.id}, -1)">-</button>
                        <span>${item.quantity}</span>
                        <button class="quantity-btn" onclick="updateQuantity(${item.id}, 1)">+</button>
                    </div>
                </div>
            `).join('');
            
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            cartTotal.textContent = `Total: $${total.toFixed(2)}`;
        }

        function updateQuantity(productId, change) {
            const item = cart.find(item => item.id === productId);
            if (!item) return;
            
            item.quantity += change;
            
            if (item.quantity <= 0) {
                cart = cart.filter(item => item.id !== productId);
            }
            
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartDisplay();
        }

        function checkout() {
            if (cart.length === 0) {
                showAlert('Your cart is empty!', 'warning');
                return;
            }
            
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const userLocation = localStorage.getItem('userLocation') || '';
            
            // Create shipping record
            const orderId = 'ORD' + Date.now();
            const shipment = {
                orderId: orderId,
                date: new Date().toISOString(),
                items: cart.map(item => item.name),
                total: total,
                location: userLocation,
                status: 'shipping'
            };
            
            // Add to shipping history
            shippingHistory.unshift(shipment);
            localStorage.setItem('shippingHistory', JSON.stringify(shippingHistory));
            
            // Clear cart
            cart = [];
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartDisplay();
            
            // Show delivery details section
            showDeliveryDetails();
            
            // Show shipping message
            if (userLocation) {
                showAlert(`Thank you for your purchase! Total: $${total.toFixed(2)}. Your medicine will be shipped to ${userLocation}. Estimated delivery: 2-4 business days.`, 'success');
            } else {
                showAlert(`Thank you for your purchase! Total: $${total.toFixed(2)}. Please update your shipping location in your profile.`, 'success');
            }
        }

        // Condition to medicine mapping
        const conditionRecommendations = {
            'flu': [11, 10, 13, 17], // Tylenol, Ibuprofen, Cough Syrup, Vitamin C
            'cold': [13, 17, 14], // Cough Syrup, Vitamin C, Decongestant
            'headache': [11, 10], // Tylenol, Ibuprofen
            'fever': [11, 10, 4], // Tylenol, Ibuprofen, Thermometer
            'pain': [11, 10], // Tylenol, Ibuprofen
            'infection': [17, 20], // Vitamin C, Zinc
            'cough': [13], // Cough Syrup
            'fatigue': [17, 18], // Vitamin C, Multivitamin
            'nausea': [17, 19], // Vitamin C, Electrolyte Packets
            'asthma': [6], // Asthma Inhaler
            'allergy': [15, 16, 5], // Antihistamines, Benadryl, EpiPen
            'diabetes': [2], // Blood Sugar Monitor
            'hypertension': [1], // Blood Pressure Monitor
            'respiratory': [3, 6], // Pulse Oximeter, Asthma Inhaler
            'dehydration': [19], // Electrolyte Packets
            'wound': [8, 9], // Antibiotic Ointment, Band-Aids
            'general': [17, 18] // Vitamin C, Multivitamin
        };

        // Allergy to medicine mapping for safety filtering
        const allergyMedicineMapping = {
            'ibuprofen': [10], // Ibuprofen product ID
            'aspirin': [10], // Ibuprofen (similar NSAID)
            'penicillin': [8], // Antibiotic Ointment
            'sulfa': [8], // Antibiotic Ointment
            'acetaminophen': [11], // Tylenol product ID
            'tylenol': [11], // Tylenol product ID
            'paracetamol': [11], // Tylenol product ID
            'loratadine': [15], // Antihistamines
            'benadryl': [16], // Benadryl
            'diphenhydramine': [16], // Benadryl
            'albuterol': [6], // Asthma Inhaler
            'epinephrine': [5], // EpiPen
            'antibiotic': [8], // Antibiotic Ointment
            'decongestant': [14], // Decongestant
            'cough': [13], // Cough Syrup
            'vitamin': [17, 18, 20], // Vitamin C, Multivitamin, Zinc
            'zinc': [20], // Zinc Supplements
            'electrolyte': [19] // Electrolyte Packets
        };

        function showRecommendations(condition) {
            const recommendationsSection = document.getElementById('recommendationsSection');
            const recommendationsList = document.getElementById('recommendationsList');
            
            const recommendedProductIds = conditionRecommendations[condition] || conditionRecommendations['general'];
            const recommendedProducts = products.filter(p => recommendedProductIds.includes(p.id));
            
            // Filter out products that conflict with user allergies
            const safeProducts = recommendedProducts.filter(product => {
                return !hasAllergyConflict(product);
            });
            
            if (safeProducts.length > 0) {
                recommendationsList.innerHTML = safeProducts.map(product => {
                    const discount = isPremium ? 0.20 : 0; // Increased to 20% discount
                    const discountedPrice = product.price * (1 - discount);
                    const isDiscounted = discount > 0;
                    
                    return `
                        <div class="medicine-card recommended" data-product-id="${product.id}">
                            <div class="medicine-image">
                                ${product.icon}
                            </div>
                            <div class="medicine-info">
                                <div class="medicine-name">${product.name}</div>
                                <div class="medicine-description">${product.description}</div>
                                <div class="medicine-price">
                                    ${isDiscounted ? `
                                        <div class="price-discounted">$${discountedPrice.toFixed(2)}</div>
                                        <div class="price-original">$${product.price.toFixed(2)}</div>
                                        <div class="premium-badge">Premium Discount Applied!</div>
                                    ` : `
                                        <div class="price-regular">$${product.price.toFixed(2)}</div>
                                    `}
                                </div>
                                <button class="btn-add-cart" onclick="addToCart(${product.id})">
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                recommendationsSection.style.display = 'block';
                
                // Also highlight items in the main shop
                highlightRecommendedItemsInShop(safeProducts);
            }
        }

        function showAIRecommendations() {
            const recommendedSection = document.getElementById('recommendedSection');
            const recommendedProducts = document.getElementById('recommendedProducts');
            
            if (!recommendedSection || !recommendedProducts) return;
            
            // Get the latest chat summary
            const chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            if (chatHistory.length === 0) return;
            
            const latestDiagnosis = chatHistory[0];
            if (!latestDiagnosis.topConditions || latestDiagnosis.topConditions.length === 0) return;
            
            // Clear previous recommendations
            recommendedProducts.innerHTML = '';
            
            // Collect all recommended medications from all conditions
            let allRecommendedMeds = [];
            latestDiagnosis.topConditions.forEach(condition => {
                if (condition.safeMedications && condition.safeMedications.length > 0) {
                    allRecommendedMeds.push(...condition.safeMedications);
                }
            });
            
            // Remove duplicates and limit to top 5
            const uniqueMeds = [...new Set(allRecommendedMeds)].slice(0, 5);
            
            if (uniqueMeds.length > 0) {
                uniqueMeds.forEach(medication => {
                    const productCard = createRecommendedProductCard(medication);
                    recommendedProducts.appendChild(productCard);
                });
                
                recommendedSection.style.display = 'block';
            }
        }

        function createRecommendedProductCard(medication) {
            const card = document.createElement('div');
            card.className = 'recommended-product-card';
            
            // Try to find matching product in shop
            const matchingProduct = findMatchingProduct(medication);
            
            if (matchingProduct) {
                // Calculate price with premium discount
                const isPremium = localStorage.getItem('isPremium') === 'true';
                const isFamilyPlan = localStorage.getItem('isFamilyPlan') === 'true';
                const discount = (isPremium || isFamilyPlan) ? 0.15 : 0; // 15% discount
                const discountedPrice = matchingProduct.price * (1 - discount);
                
                card.innerHTML = `
                    <div class="recommended-badge">ðŸ©º AI Recommended</div>
                    <h4>${matchingProduct.name}</h4>
                    <p>${matchingProduct.description}</p>
                    <div class="recommended-product-info">
                        <div class="recommended-product-price ${discount > 0 ? 'discounted' : ''}">
                            ${discount > 0 ? `<span class="original-price">$${matchingProduct.price.toFixed(2)}</span>` : ''}
                            $${discountedPrice.toFixed(2)}
                            ${discount > 0 ? '<span style="color: #4CAF50; font-size: 12px;">(15% off)</span>' : ''}
                        </div>
                        <button class="btn btn-primary btn-small" onclick="addToCart('${matchingProduct.id}')">
                            Add to Cart
                        </button>
                    </div>
                `;
            } else {
                // Generic medication card if no exact match found
                card.innerHTML = `
                    <div class="recommended-badge">ðŸ©º AI Recommended</div>
                    <h4>${medication}</h4>
                    <p>Recommended based on your diagnosis</p>
                    <div class="recommended-product-info">
                        <div class="recommended-product-price">
                            Consult your pharmacist
                        </div>
                        <button class="btn btn-secondary btn-small" onclick="searchForMedication('${medication}')">
                            Find in Store
                        </button>
                    </div>
                `;
            }
            
            return card;
        }

        function findMatchingProduct(medication) {
            // Create a mapping of medication names to products
            const medicationMapping = {
                'Acetaminophen (Tylenol)': { id: 'tylenol', name: 'Acetaminophen (Tylenol)', price: 8.99, description: 'Pain reliever and fever reducer' },
                'Ibuprofen (Advil)': { id: 'advil', name: 'Ibuprofen (Advil)', price: 7.99, description: 'Anti-inflammatory pain reliever' },
                'Dextromethorphan (Cough Suppressant)': { id: 'cough_syrup', name: 'Dextromethorphan Cough Syrup', price: 6.50, description: 'Cough suppressant medication' },
                'Guaifenesin (Expectorant)': { id: 'expectorant', name: 'Guaifenesin Expectorant', price: 5.99, description: 'Helps loosen mucus' },
                'Pseudoephedrine (Sudafed)': { id: 'sudafed', name: 'Pseudoephedrine (Sudafed)', price: 9.99, description: 'Nasal decongestant' },
                'Chlorpheniramine (Chlor-Trimeton)': { id: 'chlor_trimeton', name: 'Chlorpheniramine (Chlor-Trimeton)', price: 4.99, description: 'Antihistamine for allergies' },
                'Zinc Lozenges': { id: 'zinc_lozenges', name: 'Zinc Lozenges', price: 12.99, description: 'Immune support supplement' },
                'Vitamin C Supplements': { id: 'vitamin_c', name: 'Vitamin C Supplements', price: 15.99, description: 'Immune system support' },
                'Honey (Natural Cough Remedy)': { id: 'honey', name: 'Natural Honey', price: 8.99, description: 'Natural cough remedy' },
                'Aspirin (Bayer)': { id: 'aspirin', name: 'Aspirin (Bayer)', price: 6.99, description: 'Pain reliever and blood thinner' },
                'Naproxen (Aleve)': { id: 'naproxen', name: 'Naproxen (Aleve)', price: 8.99, description: 'Anti-inflammatory pain reliever' },
                'Caffeine + Acetaminophen (Excedrin)': { id: 'excedrin', name: 'Excedrin Extra Strength', price: 9.99, description: 'Pain reliever with caffeine' },
                'Sumatriptan (Imitrex)': { id: 'sumatriptan', name: 'Sumatriptan (Imitrex)', price: 45.99, description: 'Prescription migraine medication' },
                'Rizatriptan (Maxalt)': { id: 'rizatriptan', name: 'Rizatriptan (Maxalt)', price: 52.99, description: 'Prescription migraine medication' },
                'Loperamide (Imodium)': { id: 'imodium', name: 'Loperamide (Imodium)', price: 7.99, description: 'Anti-diarrheal medication' },
                'Bismuth Subsalicylate (Pepto-Bismol)': { id: 'pepto', name: 'Pepto-Bismol', price: 6.99, description: 'Upset stomach relief' },
                'Ondansetron (Zofran)': { id: 'zofran', name: 'Ondansetron (Zofran)', price: 35.99, description: 'Prescription anti-nausea medication' },
                'Pedialyte (Electrolyte Solution)': { id: 'pedialyte', name: 'Pedialyte Electrolyte Solution', price: 8.99, description: 'Rehydration solution' },
                'Probiotics (Culturelle)': { id: 'probiotics', name: 'Probiotics (Culturelle)', price: 18.99, description: 'Digestive health supplement' },
                'Nitrofurantoin (Macrobid)': { id: 'macrobid', name: 'Nitrofurantoin (Macrobid)', price: 25.99, description: 'Prescription antibiotic' },
                'Trimethoprim/Sulfamethoxazole (Bactrim)': { id: 'bactrim', name: 'Bactrim (Sulfamethoxazole)', price: 22.99, description: 'Prescription antibiotic' },
                'Ciprofloxacin (Cipro)': { id: 'cipro', name: 'Ciprofloxacin (Cipro)', price: 28.99, description: 'Prescription antibiotic' },
                'Cranberry Supplements': { id: 'cranberry', name: 'Cranberry Supplements', price: 12.99, description: 'Urinary tract health' },
                'Phenazopyridine (Azo)': { id: 'azo', name: 'Phenazopyridine (Azo)', price: 9.99, description: 'Urinary pain relief' },
                'Cetirizine (Zyrtec)': { id: 'zyrtec', name: 'Cetirizine (Zyrtec)', price: 14.99, description: 'Non-drowsy antihistamine' },
                'Loratadine (Claritin)': { id: 'claritin', name: 'Loratadine (Claritin)', price: 13.99, description: '24-hour allergy relief' },
                'Fexofenadine (Allegra)': { id: 'allegra', name: 'Fexofenadine (Allegra)', price: 15.99, description: 'Non-drowsy allergy relief' },
                'Fluticasone (Flonase)': { id: 'flonase', name: 'Fluticasone (Flonase)', price: 16.99, description: 'Nasal allergy spray' },
                'Ketotifen (Zaditor Eye Drops)': { id: 'zaditor', name: 'Ketotifen (Zaditor Eye Drops)', price: 11.99, description: 'Eye allergy relief' },
                'Sertraline (Zoloft)': { id: 'zoloft', name: 'Sertraline (Zoloft)', price: 45.99, description: 'Prescription antidepressant' },
                'Escitalopram (Lexapro)': { id: 'lexapro', name: 'Escitalopram (Lexapro)', price: 48.99, description: 'Prescription antidepressant' },
                'Buspirone (Buspar)': { id: 'buspar', name: 'Buspirone (Buspar)', price: 42.99, description: 'Prescription anti-anxiety medication' },
                'Alprazolam (Xanax)': { id: 'xanax', name: 'Alprazolam (Xanax)', price: 38.99, description: 'Prescription anti-anxiety medication' },
                'L-Theanine Supplements': { id: 'l_theanine', name: 'L-Theanine Supplements', price: 19.99, description: 'Natural anxiety relief' },
                'Fluoxetine (Prozac)': { id: 'prozac', name: 'Fluoxetine (Prozac)', price: 44.99, description: 'Prescription antidepressant' },
                'Bupropion (Wellbutrin)': { id: 'wellbutrin', name: 'Bupropion (Wellbutrin)', price: 46.99, description: 'Prescription antidepressant' },
                'Omega-3 Supplements': { id: 'omega3', name: 'Omega-3 Supplements', price: 24.99, description: 'Mental health support supplement' },
                'Lisinopril (Zestril)': { id: 'zestril', name: 'Lisinopril (Zestril)', price: 32.99, description: 'Prescription blood pressure medication' },
                'Amlodipine (Norvasc)': { id: 'norvasc', name: 'Amlodipine (Norvasc)', price: 35.99, description: 'Prescription blood pressure medication' },
                'Metoprolol (Lopressor)': { id: 'lopressor', name: 'Metoprolol (Lopressor)', price: 29.99, description: 'Prescription blood pressure medication' },
                'Hydrochlorothiazide (HCTZ)': { id: 'hctz', name: 'Hydrochlorothiazide (HCTZ)', price: 18.99, description: 'Prescription diuretic' },
                'Losartan (Cozaar)': { id: 'cozaar', name: 'Losartan (Cozaar)', price: 36.99, description: 'Prescription blood pressure medication' },
                'Metformin (Glucophage)': { id: 'metformin', name: 'Metformin (Glucophage)', price: 28.99, description: 'Prescription diabetes medication' },
                'Glipizide (Glucotrol)': { id: 'glucotrol', name: 'Glipizide (Glucotrol)', price: 31.99, description: 'Prescription diabetes medication' },
                'Insulin (Various types)': { id: 'insulin', name: 'Insulin (Various types)', price: 89.99, description: 'Prescription diabetes medication' },
                'Sitagliptin (Januvia)': { id: 'januvia', name: 'Sitagliptin (Januvia)', price: 95.99, description: 'Prescription diabetes medication' },
                'Empagliflozin (Jardiance)': { id: 'jardiance', name: 'Empagliflozin (Jardiance)', price: 98.99, description: 'Prescription diabetes medication' }
            };
            
            // Try to find exact match
            for (const [key, product] of Object.entries(medicationMapping)) {
                if (key.toLowerCase().includes(medication.toLowerCase()) || 
                    medication.toLowerCase().includes(key.toLowerCase())) {
                    return product;
                }
            }
            
            // Try partial matching
            for (const [key, product] of Object.entries(medicationMapping)) {
                const keyWords = key.toLowerCase().split(' ');
                const medWords = medication.toLowerCase().split(' ');
                
                for (const keyWord of keyWords) {
                    for (const medWord of medWords) {
                        if (keyWord.length > 3 && medWord.length > 3 && 
                            (keyWord.includes(medWord) || medWord.includes(keyWord))) {
                            return product;
                        }
                    }
                }
            }
            
            return null;
        }

        function searchForMedication(medication) {
            alert(`Searching for ${medication} in local pharmacies...\n\nPlease consult your local pharmacist for availability and pricing.`);
        }

        function highlightRecommendedItemsInShop(recommendedProducts) {
            const shopItems = document.querySelectorAll('.medicine-card');
            const recommendedIds = recommendedProducts.map(p => p.id);
            
            shopItems.forEach(item => {
                const itemId = item.getAttribute('data-product-id');
                if (recommendedIds.includes(parseInt(itemId))) {
                    item.classList.add('recommended');
                    item.style.border = '2px solid var(--primary)';
                    item.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.3)';
                }
            });
        }

        function hasAllergyConflict(product) {
            if (!userAllergies || userAllergies.length === 0) return false;
            
            const productName = product.name.toLowerCase();
            const productDescription = product.description.toLowerCase();
            
            for (const allergy of userAllergies) {
                const allergyLower = allergy.toLowerCase();
                
                // Check if allergy matches any medicine mapping
                if (allergyMedicineMapping[allergyLower]) {
                    const conflictingProductIds = allergyMedicineMapping[allergyLower];
                    if (conflictingProductIds.includes(product.id)) {
                        return true;
                    }
                }
                
                // Check if allergy appears in product name or description
                if (productName.includes(allergyLower) || productDescription.includes(allergyLower)) {
                    return true;
                }
            }
            
            return false;
        }

        function getConflictingAllergies(product) {
            if (!userAllergies || userAllergies.length === 0) return [];
            
            const conflicts = [];
            const productName = product.name.toLowerCase();
            const productDescription = product.description.toLowerCase();
            
            for (const allergy of userAllergies) {
                const allergyLower = allergy.toLowerCase();
                
                // Check if allergy matches any medicine mapping
                if (allergyMedicineMapping[allergyLower]) {
                    const conflictingProductIds = allergyMedicineMapping[allergyLower];
                    if (conflictingProductIds.includes(product.id)) {
                        conflicts.push(allergy);
                    }
                }
                
                // Check if allergy appears in product name or description
                if (productName.includes(allergyLower) || productDescription.includes(allergyLower)) {
                    conflicts.push(allergy);
                }
            }
            
            return conflicts;
        }



        function displayMap(location) {
            const mapDisplay = document.getElementById('mapDisplay');
            
            if (!location) {
                mapDisplay.innerHTML = `
                    <div class="map-placeholder">
                        <div class="map-placeholder-icon">ðŸ—ºï¸</div>
                        <h3>No Location Set</h3>
                        <p>Please update your shipping location in your profile to view the map.</p>
                    </div>
                `;
                return;
            }
            
            // Use OpenStreetMap with location search
            const encodedLocation = encodeURIComponent(location);
            mapDisplay.innerHTML = `
                <iframe 
                    class="map-frame"
                    src="https://www.openstreetmap.org/export/embed.html?bbox=-74.2591,40.4774,-73.7002,40.9162&layer=mapnik&marker=${encodedLocation}"
                    title="Shipping Location Map">
                </iframe>
            `;
        }

        function displayShippingInfo(location) {
            const shippingAddressDisplay = document.getElementById('shippingAddressDisplay');
            
            if (!location) {
                shippingAddressDisplay.innerHTML = `
                    <div class="shipping-address">
                        <div class="address-icon">âš ï¸</div>
                        <div class="address-details">
                            <div class="address-label">No Shipping Address Set</div>
                            <div class="address-text">Please update your location in your profile to enable shipping.</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            shippingAddressDisplay.innerHTML = `
                <div class="shipping-address">
                    <div class="address-icon">ðŸ“</div>
                    <div class="address-details">
                        <div class="address-label">Your Current Shipping Address</div>
                        <div class="address-text">${location}</div>
                    </div>
                </div>
            `;
        }

        function displayShippingHistory() {
            const container = document.getElementById('shippingHistory');
            
            if (shippingHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--secondary);">No shipping history found.</p>';
                return;
            }
            
            container.innerHTML = shippingHistory.map(shipment => {
                const orderDate = new Date(shipment.date);
                const formattedDate = orderDate.toLocaleDateString();
                const statusClass = shipment.status === 'delivered' ? 'status-delivered' : 'status-shipping';
                const statusText = shipment.status === 'delivered' ? 'Delivered' : 'In Transit';
                
                return `
                    <div class="history-item">
                        <div class="history-info">
                            <div class="history-order">Order #${shipment.orderId}</div>
                            <div class="history-date">${formattedDate} - ${shipment.items.join(', ')}</div>
                        </div>
                        <div class="history-status ${statusClass}">${statusText}</div>
                    </div>
                `;
            }).join('');
        }

        function confirmShippingAddress() {
            const location = localStorage.getItem('userLocation');
            if (!location) {
                showAlert('Please set your shipping location in your profile first.', 'warning');
                return;
            }
            
            showAlert(`Shipping address confirmed: ${location}`, 'success');
        }

        function updateUserLocation() {
            const location = document.getElementById('updateLocation').value.trim();
            const streetAddress = document.getElementById('updateStreetAddress').value.trim();
            const zipCode = document.getElementById('updateZipCode').value.trim();
            
            if (!location) {
                showAlert('Please enter your city and state.', 'danger');
                return;
            }
            
            let fullAddress = location;
            if (isPremium && streetAddress && zipCode) {
                fullAddress = `${streetAddress}, ${location} ${zipCode}`;
            }
            
            localStorage.setItem('userLocation', fullAddress);
            
            // Update current user object
            if (currentUser) {
                currentUser.location = fullAddress;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
            
            showAlert('Shipping location updated successfully!', 'success');
            
            // Reload shop section if active (which now includes delivery)
            if (document.getElementById('shop').classList.contains('active')) {
                loadShop();
            }
        }

        // Update premium features visibility
        function updatePremiumFeatures() {
            const premiumFeatures = document.getElementById('premiumFeatures');
            const videoGallery = document.getElementById('videoGallery');
            
            if (isPremium) {
                if (premiumFeatures) premiumFeatures.style.display = 'block';
                if (videoGallery) videoGallery.style.display = 'block';
            } else {
                if (premiumFeatures) premiumFeatures.style.display = 'none';
                if (videoGallery) videoGallery.style.display = 'none';
            }
        }

        // Optimize layout after login
        function optimizePostLoginLayout() {
            // Hide premium banner if user is logged in
            const premiumBanner = document.getElementById('premiumBanner');
            if (premiumBanner && isLoggedIn) {
                premiumBanner.style.display = 'none';
            }
            
            // Ensure minimal spacing for active section
            const activeCard = document.querySelector('.card.active');
            if (activeCard) {
                activeCard.style.marginTop = '0';
                activeCard.style.marginBottom = '1rem';
                activeCard.style.padding = '1.5rem';
            }
            
            // Remove spacing from all hidden cards
            document.querySelectorAll('.card:not(.active)').forEach(card => {
                card.style.marginTop = '0';
                card.style.marginBottom = '0';
                card.style.padding = '1.5rem';
            });
            
            // Optimize container spacing
            const container = document.querySelector('.container');
            if (container) {
                container.style.marginTop = '0.5rem';
            }
        }

        // Logout function
        function logout() {
            // Clear all login-related data
            isLoggedIn = false;
            currentUser = null;
            isPremium = false;
            isFamilyPlan = false;
            
            // Clear localStorage
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('isPremium');
            localStorage.removeItem('isFamilyPlan');
            localStorage.removeItem('userAllergies');
            localStorage.removeItem('chatHistory');
            localStorage.removeItem('cart');
            localStorage.removeItem('appointments');
            localStorage.removeItem('medications');
            localStorage.removeItem('vaccinations');
            localStorage.removeItem('familyMembers');
            localStorage.removeItem('shippingHistory');
            localStorage.removeItem('username');
            localStorage.removeItem('userProfile');
            
            // Update navigation
            updateNavigation();
            
            // Show confirmation
            alert("You have been logged out.");
            
            // Redirect to home page
            showSection('home');
            
            // Reload page to ensure all protected features are hidden
            setTimeout(() => {
                location.reload();
            }, 500);
        }

        // Navigation
        function showSection(sectionId) {
            // Remove active class from all cards
            document.querySelectorAll('.card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Add active class to the target section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                
                // Fix spacing issue when logged in - ensure proper margins
                if (isLoggedIn) {
                    // Remove any extra spacing from hidden cards
                    document.querySelectorAll('.card:not(.active)').forEach(card => {
                        card.style.marginBottom = '0';
                        card.style.marginTop = '0';
                    });
                    
                    // Ensure active card has minimal spacing
                    targetSection.style.marginBottom = '1rem';
                    targetSection.style.marginTop = '0';
                }
                
                // Scroll to top for better UX
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            if (sectionId === 'chatbot') {
                initializeChatbot();
            } else if (sectionId === 'checkin') {
                loadCheckinHistory();
            } else if (sectionId === 'dashboard') {
                loadDashboard();
            } else if (sectionId === 'profile') {
                loadProfile();
            } else if (sectionId === 'videos') {
                loadVideos();
            } else if (sectionId === 'premium') {
                updatePremiumFeatures();
            } else if (sectionId === 'family') {
                loadFamilyPlan();
            } else if (sectionId === 'planning') {
                loadPlanning();
            } else if (sectionId === 'shop') {
                loadShop();
                showAIRecommendations(); // Show AI recommendations when shop is opened
            }
        }

        // Form handling
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showAlert('Please fill in all fields', 'danger');
                return;
            }
            
            // Load registered users from localStorage
            const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                // Set login state
                isLoggedIn = true;
                currentUser = user;
                isPremium = user.isPremium || false;
                
                // Store in localStorage
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Update navigation
                updateNavigation();
                
                // Optimize layout after login
                optimizePostLoginLayout();
                
                showAlert('Login successful!', 'success');
                showSection('chatbot');
            } else {
                showAlert('Incorrect username or password', 'danger');
            }
        });

        document.getElementById('signupForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = {
                username: document.getElementById('signupUsername').value,
                password: document.getElementById('signupPassword').value,
                confirmPassword: document.getElementById('signupConfirmPassword').value,
                name: document.getElementById('signupName').value,
                age: document.getElementById('signupAge').value,
                height: document.getElementById('signupHeight').value,
                weight: document.getElementById('signupWeight').value,
                email: document.getElementById('signupEmail').value,
                location: document.getElementById('signupLocation').value,
                phone: document.getElementById('signupPhone').value,
                medical: document.getElementById('signupMedical').value,
                medicalRecords: localStorage.getItem('medicalRecordData') || null,
                language: document.getElementById('signupLanguage').value,
                terms: document.getElementById('signupTerms').checked,
                isPremium: false
            };
            
            if (validateSignup(formData)) {
                // Check if username already exists
                const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
                if (users.find(u => u.username === formData.username)) {
                    showAlert('Username already exists. Please choose a different username.', 'danger');
                    return;
                }
                
                // Add user to registered users
                users.push(formData);
                localStorage.setItem('registeredUsers', JSON.stringify(users));
                
                // Set login state after successful signup
                isLoggedIn = true;
                currentUser = formData;
                isPremium = formData.isPremium;
                
                // Save user location for delivery
                localStorage.setItem('userLocation', formData.location);
                
                // Store in localStorage
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Update navigation
                updateNavigation();
                
                // Optimize layout after signup
                optimizePostLoginLayout();
                
                showAlert('Account created and logged in successfully!', 'success');
                showSection('chatbot');
            }
        });

        function validateSignup(data) {
            if (!data.username || !data.password || !data.confirmPassword || !data.name || !data.age || !data.height || !data.weight || !data.email || !data.location || !data.phone) {
                showAlert('Please fill in all required fields', 'danger');
                return false;
            }
            if (data.password.length < 6) {
                showAlert('Password must be at least 6 characters long', 'danger');
                return false;
            }
            if (data.password !== data.confirmPassword) {
                showAlert('Passwords do not match', 'danger');
                return false;
            }
            if (!data.terms) {
                showAlert('Please accept the Terms & Conditions', 'danger');
                return false;
            }
            return true;
        }

        // Chatbot functionality
        function initializeChatbot() {
            chatHistory = [];
            currentQuestion = 0;
            userSymptoms = {};
            feedbackShown = false; // Reset feedback flag
            isVitalSignsStep = false; // Flag to block progression during vital signs
            askedQuestions.clear(); // Reset asked questions tracking
            currentSymptom = null; // Reset current symptom tracking
            symptomFollowUpAsked = false; // Reset follow-up flag
            sleepEnergyQuestionAnswered = false; // Reset sleep/appetite/energy question flag
            sleepAppetiteEnergyAsked = false; // Reset sleep/appetite/energy asked flag
            sleepAppetiteEnergyAnswered = false; // Reset sleep/appetite/energy answered flag
            sleepAppetiteEnergyQuestionShown = false; // Reset sleep/appetite/energy question shown flag
            sleepAppetiteEnergyAlreadyAsked = false; // Reset sleep/appetite/energy already asked flag
            lastQuestionAsked = null; // Reset last question asked flag
            
            // Load user's height/weight from profile if available
            let profileInfo = '';
            if (currentUser && currentUser.height && currentUser.weight) {
                const heightInches = currentUser.height;
                const weightLbs = currentUser.weight;
                const bmi = ((weightLbs * 703) / (heightInches * heightInches)).toFixed(1);
                profileInfo = `<br><br>I can see your profile information: Height ${currentUser.height} inches, Weight ${currentUser.weight} lbs (BMI: ${bmi})`;
            }
            
            document.getElementById('chatMessages').innerHTML = `
                <div class="message bot">
                    <div class="message-content">
                        Hello! I'm your AI health assistant. What symptoms are you experiencing today?${profileInfo}
                    </div>
                </div>
            `;
            
            // Mark first question as asked and add quick options
            askedQuestions.add(0);
            showQuickOptions(getQuickOptionsForQuestion(0));
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Process response
            setTimeout(() => {
                processChatbotResponse(message);
            }, 500);
        }

        function processChatbotResponse(userMessage) {
            // Block progression if we're in the vital signs step
            if (isVitalSignsStep) {
                return; // Don't process any input until vital signs are completed
            }
            
            if (followUpQuestions.length > 0) {
                // Handle follow-up question response
                handleFollowUpResponse(userMessage);
                return;
            }
            
            if (currentQuestion < questions.length) {
                // Check if sleep/appetite/energy question has already been asked
                if (sleepAppetiteEnergyAlreadyAsked) {
                    // Don't ask again
                    currentQuestion++;
                    while (currentQuestion < questions.length && (askedQuestions.has(currentQuestion) || 
                           (currentQuestion === 9 && (sleepEnergyQuestionAnswered || sleepAppetiteEnergyAnswered)))) {
                        currentQuestion++;
                    }
                    if (currentQuestion < questions.length) {
                        askedQuestions.add(currentQuestion);
                        showTypingIndicator();
                        setTimeout(() => {
                            removeTypingIndicator();
                            addMessage(questions[currentQuestion], 'bot');
                            showQuickOptions(getQuickOptionsForQuestion(currentQuestion));
                        }, 1500);
                    } else {
                        showTypingIndicator();
                        setTimeout(() => {
                            removeTypingIndicator();
                            analyzeSymptoms();
                        }, 2000);
                    }
                    return;
                }
                
                // Check if sleep/appetite/energy question has already been shown
                if (currentQuestion === 9 && sleepAppetiteEnergyQuestionShown) {
                    // Already shown, skip this step
                    currentQuestion++;
                    while (currentQuestion < questions.length && (askedQuestions.has(currentQuestion) || 
                           (currentQuestion === 9 && (sleepEnergyQuestionAnswered || sleepAppetiteEnergyAnswered)))) {
                        currentQuestion++;
                    }
                    if (currentQuestion < questions.length) {
                        askedQuestions.add(currentQuestion);
                        showTypingIndicator();
                        setTimeout(() => {
                            removeTypingIndicator();
                            addMessage(questions[currentQuestion], 'bot');
                            showQuickOptions(getQuickOptionsForQuestion(currentQuestion));
                        }, 1500);
                    } else {
                        showTypingIndicator();
                        setTimeout(() => {
                            removeTypingIndicator();
                            analyzeSymptoms();
                        }, 2000);
                    }
                    return;
                }
                
                // Check if sleep/appetite/energy question has already been asked or answered
                if (currentQuestion === 9 && (sleepAppetiteEnergyAsked === true || sleepAppetiteEnergyAnswered === true)) {
                    // Do NOT ask again
                    currentQuestion++;
                    while (currentQuestion < questions.length && (askedQuestions.has(currentQuestion) || 
                           (currentQuestion === 9 && (sleepEnergyQuestionAnswered || sleepAppetiteEnergyAnswered)))) {
                        currentQuestion++;
                    }
                    if (currentQuestion < questions.length) {
                        askedQuestions.add(currentQuestion);
                        showTypingIndicator();
                        setTimeout(() => {
                            removeTypingIndicator();
                            addMessage(questions[currentQuestion], 'bot');
                            showQuickOptions(getQuickOptionsForQuestion(currentQuestion));
                        }, 1500);
                    } else {
                        showTypingIndicator();
                        setTimeout(() => {
                            removeTypingIndicator();
                            analyzeSymptoms();
                        }, 2000);
                    }
                    return;
                }
                
                // Store user's answer
                userSymptoms[`question${currentQuestion}`] = userMessage;
                
                // Special handling for vital signs question (question 5)
                if (currentQuestion === 5) {
                    processVitalSignsInput(userMessage);
                    return;
                }
                
                // Special handling for family history question (question 6)
                if (currentQuestion === 6) {
                    processFamilyHistoryInput(userMessage);
                    return;
                }
                
                // Special handling for depression check (question 7)
                if (currentQuestion === 7) {
                    processDepressionInput(userMessage);
                }
                
                // Special handling for sleep/appetite/energy question (question 9)
                if (currentQuestion === 9) {
                    sleepEnergyQuestionAnswered = true; // Mark as answered
                    sleepAppetiteEnergyAnswered = true; // Mark as answered
                    sleepAppetiteEnergyAsked = true; // Mark as asked
                    sleepAppetiteEnergyQuestionShown = true; // Mark as shown
                    sleepAppetiteEnergyAlreadyAsked = true; // Mark as already asked
                    
                    // Remove the buttons after selection
                    const existingOptions = document.querySelectorAll('.quick-options');
                    existingOptions.forEach(option => option.remove());
                }
                
                // Check for dynamic conversation paths
                if (currentQuestion === 0) {
                    const symptoms = userMessage.toLowerCase();
                    const detectedPath = detectConversationPath(symptoms);
                    
                    if (detectedPath) {
                        conversationPath = detectedPath;
                        currentSymptom = detectedPath; // Track the current symptom
                        symptomFollowUpAsked = false; // Reset follow-up flag
                        showFollowUpQuestion(detectedPath);
                        return;
                    }
                }
                
                // Clear symptom tracking when moving to next question
                currentSymptom = null;
                symptomFollowUpAsked = false;
                
                // Move to next question
                currentQuestion++;
                
                // Find the next unasked question
                while (currentQuestion < questions.length && (askedQuestions.has(currentQuestion) || 
                       (currentQuestion === 9 && (sleepEnergyQuestionAnswered || sleepAppetiteEnergyAnswered)))) {
                    currentQuestion++;
                }
                
                if (currentQuestion < questions.length) {
                    // Mark this question as asked
                    askedQuestions.add(currentQuestion);
                    
                    // Check if sleep/appetite/energy question has already been asked
                    if (sleepAppetiteEnergyAlreadyAsked) {
                        // Don't ask again
                        currentQuestion++;
                        while (currentQuestion < questions.length && (askedQuestions.has(currentQuestion) || 
                               (currentQuestion === 9 && (sleepEnergyQuestionAnswered || sleepAppetiteEnergyAnswered)))) {
                            currentQuestion++;
                        }
                        if (currentQuestion < questions.length) {
                            askedQuestions.add(currentQuestion);
                            showTypingIndicator();
                            setTimeout(() => {
                                removeTypingIndicator();
                    addMessage(questions[currentQuestion], 'bot');
                                showQuickOptions(getQuickOptionsForQuestion(currentQuestion));
                            }, 1500);
                        } else {
                            showTypingIndicator();
                            setTimeout(() => {
                                removeTypingIndicator();
                                analyzeSymptoms();
                            }, 2000);
                        }
                        return;
                    }
                    
                    // Check if sleep/appetite/energy question has already been shown
                    if (currentQuestion === 9 && sleepAppetiteEnergyQuestionShown) {
                        // Already shown, skip this step
                        currentQuestion++;
                        while (currentQuestion < questions.length && (askedQuestions.has(currentQuestion) || 
                               (currentQuestion === 9 && (sleepEnergyQuestionAnswered || sleepAppetiteEnergyAnswered)))) {
                            currentQuestion++;
                        }
                        if (currentQuestion < questions.length) {
                            askedQuestions.add(currentQuestion);
                            showTypingIndicator();
                            setTimeout(() => {
                                removeTypingIndicator();
                                addMessage(questions[currentQuestion], 'bot');
                                showQuickOptions(getQuickOptionsForQuestion(currentQuestion));
                            }, 1500);
                        } else {
                            showTypingIndicator();
                            setTimeout(() => {
                                removeTypingIndicator();
                                analyzeSymptoms();
                            }, 2000);
                        }
                        return;
                    }
                    
                    // Check if sleep/appetite/energy question has already been asked or answered
                    if (currentQuestion === 9 && (sleepAppetiteEnergyAsked === true || sleepAppetiteEnergyAnswered === true)) {
                        // Do NOT ask again
                        currentQuestion++;
                        while (currentQuestion < questions.length && (askedQuestions.has(currentQuestion) || 
                               (currentQuestion === 9 && (sleepEnergyQuestionAnswered || sleepAppetiteEnergyAnswered)))) {
                            currentQuestion++;
                        }
                        if (currentQuestion < questions.length) {
                            askedQuestions.add(currentQuestion);
                            showTypingIndicator();
                            setTimeout(() => {
                                removeTypingIndicator();
                                addMessage(questions[currentQuestion], 'bot');
                                showQuickOptions(getQuickOptionsForQuestion(currentQuestion));
                            }, 1500);
                        } else {
                            showTypingIndicator();
                            setTimeout(() => {
                                removeTypingIndicator();
                                analyzeSymptoms();
                            }, 2000);
                        }
                        return;
                    }
                    
                    // Ask next question with typing effect
                    showTypingIndicator();
                                            setTimeout(() => {
                            removeTypingIndicator();
                            
                            // Check if sleep/appetite/energy question has already been asked
                            if (currentQuestion === 9 && sleepAppetiteEnergyAlreadyAsked) {
                                // Don't ask again, move to next question
                                currentQuestion++;
                                while (currentQuestion < questions.length && (askedQuestions.has(currentQuestion) || 
                                       (currentQuestion === 9 && (sleepEnergyQuestionAnswered || sleepAppetiteEnergyAnswered)))) {
                                    currentQuestion++;
                                }
                                if (currentQuestion < questions.length) {
                                    askedQuestions.add(currentQuestion);
                                    // Check if this question was already asked
                                    if (lastQuestionAsked !== questions[currentQuestion].trim()) {
                                        addMessage(questions[currentQuestion], 'bot');
                                    }
                                    showQuickOptions(getQuickOptionsForQuestion(currentQuestion));
                                } else {
                                    analyzeSymptoms();
                                }
                                return;
                            }
                            
                            // Check if this question was already asked
                            if (lastQuestionAsked !== questions[currentQuestion].trim()) {
                                addMessage(questions[currentQuestion], 'bot');
                            }
                            
                            // Mark sleep/appetite/energy question as asked and shown
                            if (currentQuestion === 9) {
                                sleepAppetiteEnergyAsked = true;
                                sleepAppetiteEnergyQuestionShown = true;
                                sleepAppetiteEnergyAlreadyAsked = true; // Mark as already asked
                            }
                            
                            showQuickOptions(getQuickOptionsForQuestion(currentQuestion));
                        }, 1500);
                } else {
                    // Analyze symptoms
                    showTypingIndicator();
                    setTimeout(() => {
                        removeTypingIndicator();
                    analyzeSymptoms();
                    }, 2000);
                }
            }
        }

        function detectConversationPath(symptoms) {
            const symptomsLower = symptoms.toLowerCase();
            
            // Check for emergency symptoms first
            if (symptomsLower.includes('chest pain') || symptomsLower.includes('shortness of breath')) {
                emergencyFlag = true;
                return 'emergency';
            }
            
            // Enhanced symptom detection with multiple combinations
            if (symptomsLower.includes('fever') && symptomsLower.includes('cough')) {
                return 'respiratory_infection';
            }
            
            if (symptomsLower.includes('fever') && symptomsLower.includes('body aches')) {
                return 'flu_like';
            }
            
            if (symptomsLower.includes('headache') && symptomsLower.includes('nausea')) {
                return 'migraine';
            }
            
            if (symptomsLower.includes('stomach pain') && symptomsLower.includes('nausea')) {
                return 'gastrointestinal';
            }
            
            if (symptomsLower.includes('fatigue') && symptomsLower.includes('shortness of breath')) {
                return 'anemia_or_cardiac';
            }
            
            if (symptomsLower.includes('joint pain') && symptomsLower.includes('stiffness')) {
                return 'arthritis';
            }
            
            // Individual symptom paths - only if not already handling this symptom
            if (symptomsLower.includes('fever') && currentSymptom !== 'fever') return 'fever';
            if (symptomsLower.includes('cough') && currentSymptom !== 'cough') return 'cough';
            if (symptomsLower.includes('headache') && currentSymptom !== 'headache') return 'headache';
            if (symptomsLower.includes('chest pain') && currentSymptom !== 'chest_pain') return 'chest_pain';
            if (symptomsLower.includes('shortness of breath') && currentSymptom !== 'shortness_breath') return 'shortness_breath';
            if (symptomsLower.includes('stomach pain') && currentSymptom !== 'stomach_pain') return 'stomach_pain';
            if (symptomsLower.includes('fatigue') && currentSymptom !== 'fatigue' && !sleepEnergyQuestionAnswered && !sleepAppetiteEnergyAnswered) return 'fatigue';
            
            return null;
        }

        function showFollowUpQuestion(path) {
            const pathData = conversationPaths[path];
            if (pathData) {
                addMessage(pathData.followUp, 'bot');
                showQuickOptions(pathData.options);
                symptomFollowUpAsked = true; // Mark that follow-up has been asked
            }
        }

        function handleFollowUpResponse(response) {
            const followUpType = followUpQuestions[0];
            
            if (followUpType === 'vital_signs') {
                handleVitalSignsResponse(response);
            } else if (followUpType === 'family_history') {
                // Family history is handled by the checkbox form
                return;
            } else {
                // Handle conversation path follow-ups
                const currentPath = conversationPath;
                const pathData = conversationPaths[currentPath];
                
                if (pathData && pathData.nextPath) {
                    const responseLower = response.toLowerCase();
                    let nextPath = null;
                    
                    for (const [key, value] of Object.entries(pathData.nextPath)) {
                        if (responseLower.includes(key)) {
                            nextPath = value;
                            break;
                        }
                    }
                    
                    if (nextPath && conditionFollowUps[nextPath]) {
                        const followUp = conditionFollowUps[nextPath];
                        addMessage(followUp.question, 'bot');
                        showQuickOptions(followUp.options);
                        
                        if (followUp.emergency) {
                            emergencyFlag = true;
                            setTimeout(() => {
                                addMessage("âš ï¸ These symptoms could indicate a medical emergency. Please seek care immediately.", 'bot');
                            }, 1000);
                        }
                    } else {
                        // Continue with regular questions
                        followUpQuestions = [];
                        currentSymptom = null; // Clear current symptom tracking
                        symptomFollowUpAsked = false; // Reset follow-up flag
                        currentQuestion++;
                        
                        // Find the next unasked question
                        while (currentQuestion < questions.length && (askedQuestions.has(currentQuestion) || 
                               (currentQuestion === 9 && (sleepEnergyQuestionAnswered || sleepAppetiteEnergyAnswered)))) {
                            currentQuestion++;
                        }
                        
                        if (currentQuestion < questions.length) {
                            // Mark this question as asked
                            askedQuestions.add(currentQuestion);
                            // Check if this question was already asked
                            if (lastQuestionAsked !== questions[currentQuestion].trim()) {
                                addMessage(questions[currentQuestion], 'bot');
                            }
                        } else {
                            analyzeSymptoms();
                        }
                    }
                }
            }
        }

        function handleVitalSignsResponse(response) {
            const responseLower = response.toLowerCase();
            
            if (responseLower.includes('skip') || responseLower.includes('don\'t know')) {
                addMessage("No problem! Let's continue without vital signs.", 'bot');
                followUpQuestions = [];
                currentSymptom = null; // Clear symptom tracking
                symptomFollowUpAsked = false;
                currentQuestion++;
                
                // Find the next unasked question
                while (currentQuestion < questions.length && (askedQuestions.has(currentQuestion) || 
                       (currentQuestion === 9 && (sleepEnergyQuestionAnswered || sleepAppetiteEnergyAnswered)))) {
                    currentQuestion++;
                }
                
                if (currentQuestion < questions.length) {
                    // Mark this question as asked
                    askedQuestions.add(currentQuestion);
                    // Check if this question was already asked
                    if (lastQuestionAsked !== questions[currentQuestion].trim()) {
                        addMessage(questions[currentQuestion], 'bot');
                    }
                } else {
                    analyzeSymptoms();
                }
                return;
            }
            
            // Parse vital signs from response
            const vitalSigns = parseVitalSigns(response);
            userSymptoms.vitalSigns = vitalSigns;
            
            // Check for critical values
            const criticalWarnings = checkCriticalVitalSigns(vitalSigns);
            if (criticalWarnings.length > 0) {
                addMessage("âš ï¸ **CRITICAL VITAL SIGNS DETECTED:**\n" + criticalWarnings.join('\n') + "\n\nPlease seek emergency medical care immediately!", 'bot');
            }
            
            followUpQuestions = [];
            currentSymptom = null; // Clear symptom tracking
            symptomFollowUpAsked = false;
            currentQuestion++;
            
            // Find the next unasked question
            while (currentQuestion < questions.length && (askedQuestions.has(currentQuestion) || 
                   (currentQuestion === 9 && (sleepEnergyQuestionAnswered || sleepAppetiteEnergyAnswered)))) {
                currentQuestion++;
            }
            
            if (currentQuestion < questions.length) {
                // Mark this question as asked
                askedQuestions.add(currentQuestion);
                // Check if this question was already asked
                if (lastQuestionAsked !== questions[currentQuestion].trim()) {
                    addMessage(questions[currentQuestion], 'bot');
                }
            } else {
                analyzeSymptoms();
            }
        }

        function parseVitalSigns(input) {
            const vitalSigns = {};
            const inputLower = input.toLowerCase();
            
            // Parse blood pressure
            const bpMatch = input.match(/(\d+)\/(\d+)/);
            if (bpMatch) {
                vitalSigns.bloodPressure = {
                    systolic: parseInt(bpMatch[1]),
                    diastolic: parseInt(bpMatch[2])
                };
            }
            
            // Parse pulse
            const pulseMatch = input.match(/(\d+)\s*(?:bpm|pulse)/);
            if (pulseMatch) {
                vitalSigns.pulse = parseInt(pulseMatch[1]);
            }
            
            // Parse temperature
            const tempMatch = input.match(/(\d+(?:\.\d+)?)\s*[Â°f]?/i);
            if (tempMatch) {
                vitalSigns.temperature = parseFloat(tempMatch[1]);
            }
            
            // Parse blood glucose
            const glucoseMatch = input.match(/(\d+)\s*(?:mg\/dl|glucose)/i);
            if (glucoseMatch) {
                vitalSigns.bloodGlucose = parseInt(glucoseMatch[1]);
            }
            
            return vitalSigns;
        }

        function checkCriticalVitalSigns(vitalSigns) {
            const warnings = [];
            
            if (vitalSigns.bloodPressure) {
                const { systolic, diastolic } = vitalSigns.bloodPressure;
                
                // Check for hypertensive crisis
                if (systolic >= 180 || diastolic >= 120) {
                    warnings.push(`ðŸš¨ **HYPERTENSIVE CRISIS:** Blood pressure ${systolic}/${diastolic} mmHg is critically high. This requires immediate medical attention.`);
                }
                // Check for stage 2 hypertension
                else if (systolic >= 160 || diastolic >= 100) {
                    warnings.push(`âš ï¸ **HIGH BLOOD PRESSURE:** ${systolic}/${diastolic} mmHg indicates stage 2 hypertension. Please consult a doctor soon.`);
                }
                // Check for stage 1 hypertension
                else if (systolic >= 140 || diastolic >= 90) {
                    warnings.push(`ðŸ“‹ **ELEVATED BLOOD PRESSURE:** ${systolic}/${diastolic} mmHg indicates stage 1 hypertension. Monitor and consider lifestyle changes.`);
                }
                // Check for hypotension
                else if (systolic < 90 || diastolic < 60) {
                    warnings.push(`âš ï¸ **LOW BLOOD PRESSURE:** ${systolic}/${diastolic} mmHg is below normal. If symptomatic, seek medical attention.`);
                }
            }
            
            if (vitalSigns.bloodGlucose) {
                const glucose = vitalSigns.bloodGlucose;
                
                // Check for diabetic crisis
                if (glucose >= 400) {
                    warnings.push(`ðŸš¨ **DIABETIC CRISIS:** Blood glucose ${glucose} mg/dL is critically high. Seek emergency medical care immediately.`);
                }
                // Check for very high glucose
                else if (glucose >= 240) {
                    warnings.push(`âš ï¸ **VERY HIGH GLUCOSE:** ${glucose} mg/dL is dangerously high. Contact your doctor immediately.`);
                }
                // Check for high glucose
                else if (glucose >= 180) {
                    warnings.push(`ðŸ“‹ **ELEVATED GLUCOSE:** ${glucose} mg/dL is above normal. Monitor and consider dietary changes.`);
                }
                // Check for hypoglycemia
                else if (glucose < 70) {
                    warnings.push(`âš ï¸ **LOW BLOOD GLUCOSE:** ${glucose} mg/dL is below normal. If symptomatic, consume sugar and seek medical attention.`);
                }
            }
            
            if (vitalSigns.temperature) {
                const temp = vitalSigns.temperature;
                
                // Check for hyperpyrexia (very high fever)
                if (temp >= 105) {
                    warnings.push(`ðŸš¨ **HYPERTHERMIA:** Temperature ${temp}Â°F is critically high. Seek emergency medical care immediately.`);
                }
                // Check for high fever
                else if (temp >= 103) {
                    warnings.push(`âš ï¸ **HIGH FEVER:** ${temp}Â°F indicates a high fever. Consider medical attention if persistent.`);
                }
                // Check for fever
                else if (temp >= 100.4) {
                    warnings.push(`ðŸ“‹ **FEVER:** ${temp}Â°F indicates a fever. Monitor symptoms and rest.`);
                }
                // Check for hypothermia
                else if (temp < 95) {
                    warnings.push(`âš ï¸ **HYPOTHERMIA:** ${temp}Â°F is below normal. If symptomatic, seek medical attention.`);
                }
            }
            
            if (vitalSigns.pulse) {
                const pulse = vitalSigns.pulse;
                
                // Check for tachycardia
                if (pulse >= 100) {
                    warnings.push(`âš ï¸ **TACHYCARDIA:** Pulse ${pulse} bpm is elevated. Monitor and consider medical evaluation if persistent.`);
                }
                // Check for bradycardia
                else if (pulse < 60) {
                    warnings.push(`âš ï¸ **BRADYCARDIA:** Pulse ${pulse} bpm is below normal. If symptomatic, seek medical attention.`);
                }
            }
            
            return warnings;
        }

        function showQuickOptions(options) {
            // Check if sleep/appetite/energy question has already been asked
            if (sleepAppetiteEnergyAlreadyAsked) {
                return; // Don't show options if question already asked
            }
            
            // Check if sleep/appetite/energy question has already been shown
            if (currentQuestion === 9 && sleepAppetiteEnergyQuestionShown) {
                return; // Don't show options if question already shown
            }
            
            // Remove any existing quick options to prevent duplicates
            const existingOptions = document.querySelectorAll('.quick-options');
            existingOptions.forEach(option => option.remove());
            
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'quick-options';
            optionsContainer.style.cssText = `
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                margin: 1rem 0;
            `;
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'quick-option-btn';
                button.style.cssText = `
                    padding: 0.5rem 1rem;
                    border: 1px solid var(--primary);
                    background: white;
                    color: var(--primary);
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 0.9rem;
                    transition: all 0.3s;
                `;
                
                button.onclick = () => {
                    addMessage(option, 'user');
                    processChatbotResponse(option);
                    optionsContainer.remove();
                };
                
                optionsContainer.appendChild(button);
            });
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.appendChild(optionsContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showFamilyHistoryOptions() {
            const historyDiv = document.createElement('div');
            historyDiv.className = 'family-history-options';
            historyDiv.style.cssText = `
                background: white;
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 1rem;
                margin: 1rem 0;
                max-height: 300px;
                overflow-y: auto;
            `;
            
            const title = document.createElement('h4');
            title.textContent = 'Select applicable conditions:';
            title.style.marginBottom = '1rem';
            historyDiv.appendChild(title);
            
            familyHistoryOptions.forEach(option => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'history-checkbox';
                checkboxDiv.style.cssText = `
                    display: flex;
                    align-items: center;
                    margin: 0.5rem 0;
                    gap: 0.5rem;
                `;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `history_${option.replace(/\s+/g, '_')}`;
                checkbox.value = option;
                
                const label = document.createElement('label');
                label.htmlFor = `history_${option.replace(/\s+/g, '_')}`;
                label.textContent = option;
                label.style.cursor = 'pointer';
                
                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                historyDiv.appendChild(checkboxDiv);
            });
            
            const submitBtn = document.createElement('button');
            submitBtn.className = 'btn btn-primary btn-small';
            submitBtn.textContent = 'Submit Family History';
            submitBtn.style.marginTop = '1rem';
            submitBtn.onclick = () => {
                const selectedConditions = [];
                historyDiv.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    selectedConditions.push(checkbox.value);
                });
                userSymptoms.familyHistory = selectedConditions;
                historyDiv.remove();
                
                currentQuestion++;
                
                // Find the next unasked question
                while (currentQuestion < questions.length && askedQuestions.has(currentQuestion)) {
                    currentQuestion++;
                }
                
                if (currentQuestion < questions.length) {
                    // Mark this question as asked
                    askedQuestions.add(currentQuestion);
                    addMessage(questions[currentQuestion], 'bot');
                } else {
                    analyzeSymptoms();
                }
            };
            
            historyDiv.appendChild(submitBtn);
            document.getElementById('chatMessages').appendChild(historyDiv);
        }

        function processAllergyInput(allergyInput) {
            // Parse allergy input and save to userAllergies
            const allergies = allergyInput.toLowerCase()
                .split(/[,;]/)
                .map(allergy => allergy.trim())
                .filter(allergy => allergy.length > 0);
            
            userAllergies = [...new Set([...userAllergies, ...allergies])];
            
            // Save to localStorage
            localStorage.setItem('userAllergies', JSON.stringify(userAllergies));
            
            // Update current user object
            if (currentUser) {
                currentUser.allergies = userAllergies;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
        }

        function processVitalSignsInput(input) {
            const response = input.toLowerCase();
            
            if (response.includes('enter values') || response.includes('yes') || response.includes('sure') || response.includes('okay')) {
                isVitalSignsStep = true; // Block progression
                showVitalSignsForm();
            } else if (response.includes('skip')) {
                addMessage("That's perfectly fine! We can proceed without vital signs. Let's continue with the assessment.", 'bot');
                currentSymptom = null; // Clear symptom tracking
                symptomFollowUpAsked = false;
                currentQuestion++;
                
                // Find the next unasked question
                while (currentQuestion < questions.length && (askedQuestions.has(currentQuestion) || 
                       (currentQuestion === 9 && (sleepEnergyQuestionAnswered || sleepAppetiteEnergyAnswered)))) {
                    currentQuestion++;
                }
                
                if (currentQuestion < questions.length) {
                    // Mark this question as asked
                    askedQuestions.add(currentQuestion);
                    setTimeout(() => {
                        // Check if this question was already asked
                        if (lastQuestionAsked !== questions[currentQuestion].trim()) {
                            addMessage(questions[currentQuestion], 'bot');
                        }
                        showQuickOptions(getQuickOptionsForQuestion(currentQuestion));
                    }, 1000);
                } else {
                    setTimeout(() => {
                        analyzeSymptoms();
                    }, 1000);
                }
            }
        }

        function showVitalSignsForm() {
            const formHTML = `
                <div class="vital-signs-form">
                                    <div class="form-header">
                    <h4>ðŸ“Š Vital Signs Input</h4>
                    <p>Please enter any vital signs you know. You can leave any field blank if you don't know the value.</p>
                </div>
                    <div class="vital-inputs">
                        <div class="input-group">
                            <label for="pulse">Pulse (bpm)</label>
                            <input type="number" id="pulse" placeholder="e.g., 75" min="40" max="200" oninput="validateVitalSign('pulse', this.value)">
                            <small class="input-hint">Normal range: 60-100 bpm</small>
                        </div>
                        <div class="input-group">
                            <label for="systolic">Blood Pressure (mmHg)</label>
                            <div class="bp-inputs">
                                <input type="number" id="systolic" placeholder="e.g., 120" min="70" max="250" oninput="validateVitalSign('systolic', this.value)">
                                <span class="bp-separator">/</span>
                                <input type="number" id="diastolic" placeholder="e.g., 80" min="40" max="150" oninput="validateVitalSign('diastolic', this.value)">
                            </div>
                            <small class="input-hint">Normal range: 90/60 - 140/90 mmHg</small>
                        </div>
                        <div class="input-group">
                            <label for="temperature">Body Temperature (Â°F)</label>
                            <input type="number" id="temperature" placeholder="e.g., 98.6" min="90" max="110" step="0.1" oninput="validateVitalSign('temperature', this.value)">
                            <small class="input-hint">Normal range: 97-99Â°F</small>
                        </div>
                        <div class="input-group">
                            <label for="glucose">Blood Glucose (mg/dL)</label>
                            <input type="number" id="glucose" placeholder="e.g., 100" min="40" max="600" oninput="validateVitalSign('glucose', this.value)">
                            <small class="input-hint">Normal range: 70-140 mg/dL</small>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="submitVitalSigns()">Submit</button>
                        <button class="btn btn-secondary" onclick="skipVitalSigns()">Skip for now</button>
                    </div>
                </div>
            `;
            
            addMessage(formHTML, 'bot');
        }

        function validateVitalSign(type, value) {
            const input = document.getElementById(type);
            const hint = input.parentNode.querySelector('.input-hint');
            
            if (!value) {
                input.style.borderColor = '';
                if (hint) hint.style.color = '';
                return;
            }
            
            const numValue = parseFloat(value);
            let isValid = true;
            let message = '';
            
            switch(type) {
                case 'pulse':
                    if (numValue < 40 || numValue > 200) {
                        isValid = false;
                        message = 'âš ï¸ Pulse should be between 40-200 bpm';
                    }
                    break;
                case 'systolic':
                    if (numValue < 70 || numValue > 250) {
                        isValid = false;
                        message = 'âš ï¸ Systolic should be between 70-250 mmHg';
                    }
                    break;
                case 'diastolic':
                    if (numValue < 40 || numValue > 150) {
                        isValid = false;
                        message = 'âš ï¸ Diastolic should be between 40-150 mmHg';
                    }
                    break;
                case 'temperature':
                    if (numValue < 90 || numValue > 110) {
                        isValid = false;
                        message = 'âš ï¸ Temperature should be between 90-110Â°F';
                    }
                    break;
                case 'glucose':
                    if (numValue < 40 || numValue > 600) {
                        isValid = false;
                        message = 'âš ï¸ Glucose should be between 40-600 mg/dL';
                    }
                    break;
            }
            
            if (!isValid) {
                input.style.borderColor = '#ef4444';
                if (hint) {
                    hint.style.color = '#ef4444';
                    hint.textContent = message;
                }
            } else {
                input.style.borderColor = '#10b981';
                if (hint) {
                    hint.style.color = '#10b981';
                    hint.textContent = 'âœ… Valid value';
                }
            }
        }

        function submitVitalSigns() {
            const pulse = document.getElementById('pulse').value;
            const systolic = document.getElementById('systolic').value;
            const diastolic = document.getElementById('diastolic').value;
            const temperature = document.getElementById('temperature').value;
            const glucose = document.getElementById('glucose').value;
            
            const vitalSigns = {};
            let hasValues = false;
            
            // Validate and collect vital signs
            if (pulse && pulse >= 40 && pulse <= 200) {
                vitalSigns.pulse = parseInt(pulse);
                hasValues = true;
            }
            
            if (systolic && diastolic && systolic >= 70 && systolic <= 250 && diastolic >= 40 && diastolic <= 150) {
                vitalSigns.bloodPressure = {
                    systolic: parseInt(systolic),
                    diastolic: parseInt(diastolic)
                };
                hasValues = true;
            }
            
            if (temperature && temperature >= 90 && temperature <= 110) {
                vitalSigns.temperature = parseFloat(temperature);
                hasValues = true;
            }
            
            if (glucose && glucose >= 40 && glucose <= 600) {
                vitalSigns.bloodGlucose = parseInt(glucose);
                hasValues = true;
            }
            
            // Store vital signs
            userSymptoms.vitalSigns = vitalSigns;
            
            // Create summary message
            let summary = "ðŸ“Š **Vital Signs Summary:**\n";
            if (vitalSigns.pulse) summary += `â€¢ Pulse: ${vitalSigns.pulse} bpm\n`;
            if (vitalSigns.bloodPressure) summary += `â€¢ Blood Pressure: ${vitalSigns.bloodPressure.systolic}/${vitalSigns.bloodPressure.diastolic} mmHg\n`;
            if (vitalSigns.temperature) summary += `â€¢ Temperature: ${vitalSigns.temperature}Â°F\n`;
            if (vitalSigns.bloodGlucose) summary += `â€¢ Blood Glucose: ${vitalSigns.bloodGlucose} mg/dL\n`;
            
            if (!hasValues) {
                summary = "No vital signs provided.";
            }
            
            addMessage(summary, 'bot');
            
            // Check for critical values
            const criticalWarnings = checkCriticalVitalSigns(vitalSigns);
            if (criticalWarnings.length > 0) {
                setTimeout(() => {
                    addMessage("âš ï¸ **CRITICAL VITAL SIGNS DETECTED:**\n" + criticalWarnings.join('\n') + "\n\nPlease seek emergency medical care immediately!", 'bot');
                }, 1000);
            }
            
            // Remove the form
            const vitalSignsForm = document.querySelector('.vital-signs-form');
            if (vitalSignsForm) {
                vitalSignsForm.remove();
            }
            
            // Clear the vital signs step flag and continue
            isVitalSignsStep = false;
            currentSymptom = null; // Clear symptom tracking
            symptomFollowUpAsked = false;
            currentQuestion++;
            
            // Find the next unasked question
            while (currentQuestion < questions.length && (askedQuestions.has(currentQuestion) || 
                   (currentQuestion === 9 && (sleepEnergyQuestionAnswered || sleepAppetiteEnergyAnswered)))) {
                currentQuestion++;
            }
            
            if (currentQuestion < questions.length) {
                // Mark this question as asked
                askedQuestions.add(currentQuestion);
                setTimeout(() => {
                    // Check if this question was already asked
                    if (lastQuestionAsked !== questions[currentQuestion].trim()) {
                        addMessage(questions[currentQuestion], 'bot');
                    }
                    showQuickOptions(getQuickOptionsForQuestion(currentQuestion));
                }, 1500);
            } else {
                setTimeout(() => {
                    analyzeSymptoms();
                }, 1500);
            }
        }

        function skipVitalSigns() {
            addMessage("That's perfectly fine! We can proceed without vital signs. Let's continue with the assessment.", 'bot');
            
            // Remove the form
            const vitalSignsForm = document.querySelector('.vital-signs-form');
            if (vitalSignsForm) {
                vitalSignsForm.remove();
            }
            
            // Clear the vital signs step flag and continue
            isVitalSignsStep = false;
            currentSymptom = null; // Clear symptom tracking
            symptomFollowUpAsked = false;
            currentQuestion++;
            
            // Find the next unasked question
            while (currentQuestion < questions.length && (askedQuestions.has(currentQuestion) || 
                   (currentQuestion === 9 && (sleepEnergyQuestionAnswered || sleepAppetiteEnergyAnswered)))) {
                currentQuestion++;
            }
            
            if (currentQuestion < questions.length) {
                // Mark this question as asked
                askedQuestions.add(currentQuestion);
                setTimeout(() => {
                    // Check if this question was already asked
                    if (lastQuestionAsked !== questions[currentQuestion].trim()) {
                        addMessage(questions[currentQuestion], 'bot');
                    }
                    showQuickOptions(getQuickOptionsForQuestion(currentQuestion));
                }, 1000);
            } else {
                setTimeout(() => {
                    analyzeSymptoms();
                }, 1000);
            }
        }

        function processFamilyHistoryInput(input) {
            const response = input.toLowerCase();
            
            if (response.includes('yes') || response.includes('sure') || response.includes('okay')) {
                addMessage("Please select any conditions that apply to you or your immediate family:", 'bot');
                showFamilyHistoryOptions();
                followUpQuestions = ['family_history'];
            } else {
                addMessage("No problem! Let's continue with the assessment.", 'bot');
                currentSymptom = null; // Clear symptom tracking
                symptomFollowUpAsked = false;
                currentQuestion++;
                
                // Find the next unasked question
                while (currentQuestion < questions.length && (askedQuestions.has(currentQuestion) || 
                       (currentQuestion === 9 && (sleepEnergyQuestionAnswered || sleepAppetiteEnergyAnswered)))) {
                    currentQuestion++;
                }
                
                if (currentQuestion < questions.length) {
                    // Mark this question as asked
                    askedQuestions.add(currentQuestion);
                    setTimeout(() => {
                        // Check if this question was already asked
                        if (lastQuestionAsked !== questions[currentQuestion].trim()) {
                            addMessage(questions[currentQuestion], 'bot');
                        }
                        showQuickOptions(getQuickOptionsForQuestion(currentQuestion));
                    }, 1000);
                } else {
                    setTimeout(() => {
                        analyzeSymptoms();
                    }, 1000);
                }
            }
        }

        function processDepressionInput(input) {
            const response = input.toLowerCase();
            userSymptoms.depressionRisk = response.includes('yes') || response.includes('sad') || response.includes('hopeless') || response.includes('disinterested');
            
            if (userSymptoms.depressionRisk) {
                addMessage("Thank you for sharing that. It's important to talk about mental health. We'll include some resources in your assessment summary.", 'bot');
            }
            
            // Continue to next question or analysis
            currentSymptom = null; // Clear symptom tracking
            symptomFollowUpAsked = false;
            currentQuestion++;
            
            // Find the next unasked question
            while (currentQuestion < questions.length && (askedQuestions.has(currentQuestion) || 
                   (currentQuestion === 9 && (sleepEnergyQuestionAnswered || sleepAppetiteEnergyAnswered)))) {
                currentQuestion++;
            }
            
            if (currentQuestion < questions.length) {
                // Mark this question as asked
                askedQuestions.add(currentQuestion);
                setTimeout(() => {
                    // Check if this question was already asked
                    if (lastQuestionAsked !== questions[currentQuestion].trim()) {
                        addMessage(questions[currentQuestion], 'bot');
                    }
                    showQuickOptions(getQuickOptionsForQuestion(currentQuestion));
                }, 1000);
            } else {
                setTimeout(() => {
                    analyzeSymptoms();
                }, 1000);
            }
        }

        function analyzeSymptoms() {
            // Clear any existing vital signs form
            const vitalSignsForm = document.getElementById('vitalSignsForm');
            if (vitalSignsForm) {
                vitalSignsForm.remove();
            }
            
            // Analyze user symptoms and provide diagnosis
            const symptoms = Object.values(userSymptoms).join(' ').toLowerCase();
            const userAge = localStorage.getItem('userAge') || 'unknown';
            const userGender = localStorage.getItem('userGender') || 'unknown';
            const userAllergies = JSON.parse(localStorage.getItem('userAllergies') || '[]');
            
            // Get vital signs if available
            const vitalSigns = JSON.parse(localStorage.getItem('vitalSigns') || '{}');
            const familyHistory = JSON.parse(localStorage.getItem('familyHistory') || '{}');
            const depressionRisk = localStorage.getItem('depressionRisk') || 'unknown';
            
            // Calculate BMI if height and weight are available
            let bmi = null;
            const userHeight = localStorage.getItem('userHeight');
            const userWeight = localStorage.getItem('userWeight');
            if (userHeight && userWeight) {
                const heightInMeters = userHeight / 100;
                bmi = (userWeight / (heightInMeters * heightInMeters)).toFixed(1);
            }
            
            // Probabilistic disease analysis
            const diseaseScores = calculateDiseaseProbabilities(symptoms, vitalSigns, familyHistory, bmi);
            
            // Check for emergency conditions first
            let emergencyFlag = false;
            let emergencyMessage = '';
            
            if (symptoms.includes('chest pain') && symptoms.includes('shortness of breath')) {
                emergencyFlag = true;
                emergencyMessage = 'âš ï¸ EMERGENCY: Your symptoms could indicate a serious cardiovascular issue. Please seek immediate medical attention.';
            } else if (symptoms.includes('severe headache') && symptoms.includes('vision problems')) {
                emergencyFlag = true;
                emergencyMessage = 'âš ï¸ EMERGENCY: Your symptoms could indicate a stroke or severe neurological issue. Please seek immediate medical attention.';
            }
            
            if (emergencyFlag) {
                addMessage(emergencyMessage, 'bot');
                addMessage("ðŸš¨ Please call 911 or go to the nearest emergency room immediately.", 'bot');
                return;
            }
            
            // Build the diagnosis message
            let diagnosisMessage = `Based on your symptoms and assessment, here are potential conditions:\n\n`;
            
            if (diseaseScores.length > 0) {
                const topConditions = diseaseScores.slice(0, 3); // Show top 3 matches
                
                topConditions.forEach((condition, index) => {
                    diagnosisMessage += `**${condition.disease}** (Match: ${condition.percentage}%)\n`;
                    if (condition.confidence === 'high') {
                        diagnosisMessage += `   Confidence: High\n`;
                    } else if (condition.confidence === 'medium') {
                        diagnosisMessage += `   Confidence: Medium\n`;
                    } else {
                        diagnosisMessage += `   Confidence: Low\n`;
                    }
                    if (condition.description) {
                        diagnosisMessage += `   Description: ${condition.description}\n`;
                    }
                    
                    // Add top 5 medications for this condition (filtered by allergies)
                    if (condition.topMedications && condition.topMedications.length > 0) {
                        // Filter medications based on allergies
                        const safeMedications = filterMedicationsByAllergies(condition.topMedications, userAllergies);
                        
                        if (safeMedications.length > 0) {
                            diagnosisMessage += `   **Top Medications:**\n`;
                            // Show up to 5 safe medications
                            const top5SafeMeds = safeMedications.slice(0, 5);
                            top5SafeMeds.forEach((med, medIndex) => {
                                diagnosisMessage += `   ${medIndex + 1}. ${med}\n`;
                            });
                        } else {
                            diagnosisMessage += `   **Top Medications:**\n   No safe medications available. Please consult a physician.\n`;
                        }
                    }
                    
                    diagnosisMessage += `\n`;
                });
                
                // Set detected condition for shop recommendations
                detectedCondition = topConditions[0]?.disease || 'general';
            } else {
                diagnosisMessage += `Your symptoms don't clearly match any specific condition with high certainty. Please monitor your health and consult a doctor if symptoms worsen.\n\n`;
                detectedCondition = 'general';
            }
            
            // Collect warnings from matched conditions
            let allWarnings = [];
            
            if (diseaseScores.length > 0) {
                diseaseScores.forEach(condition => {
                    if (condition.warnings) {
                        allWarnings.push(...condition.warnings);
                    }
                });
            }
            
            // Add general recommendations based on top match confidence
            let generalRecommendations = [];
            if (diseaseScores.length > 0) {
                const topMatch = diseaseScores[0];
                if (topMatch.confidence === 'high') {
                    generalRecommendations.push('Schedule a doctor appointment within 24-48 hours');
                } else if (topMatch.confidence === 'medium') {
                    generalRecommendations.push('Monitor symptoms and see a doctor if they persist for more than 3-5 days');
                } else {
                    generalRecommendations.push('Consider consulting a healthcare provider for a thorough evaluation');
                }
            }
            
            // Add BMI-based recommendations
            if (bmi) {
                if (bmi > 30) {
                    generalRecommendations.push('Consider lifestyle changes to manage weight');
                } else if (bmi < 18.5) {
                    generalRecommendations.push('Consider nutritional counseling');
                }
            }
            
            // Add depression screening recommendations
            if (depressionRisk === 'high') {
                generalRecommendations.push('Consider speaking with a mental health professional');
                allWarnings.push('Your responses suggest possible depression symptoms');
            }
            
            // Display the diagnosis
            addMessage(diagnosisMessage, 'bot');
            
            // Show general recommendations
            if (generalRecommendations.length > 0) {
                addMessage(`**Recommended Actions:**\n${generalRecommendations.map(action => `â€¢ ${action}`).join('\n')}`, 'bot');
            }
            
            // Show warnings
            if (allWarnings.length > 0) {
                addMessage(`**âš ï¸ Important Warnings:**\n${allWarnings.map(warning => `â€¢ ${warning}`).join('\n')}`, 'bot');
            }
            
            // Add final disclaimer
            addMessage(`**Important:** These are estimates based on your symptoms. Please consult a healthcare provider for a confirmed diagnosis.`, 'bot');
            
            // Show feedback prompt
            if (!feedbackShown) {
                setTimeout(() => {
                    showFeedbackPrompt();
                    feedbackShown = true;
                }, 2000);
            }
            
            // Store chat summary with probabilistic data
            const chatSummary = {
                date: new Date().toISOString(),
                symptoms: symptoms,
                detectedCondition: detectedCondition || 'general',
                topConditions: diseaseScores.slice(0, 3).map(c => ({ 
                    name: c.disease, 
                    percentage: c.percentage, 
                    confidence: c.confidence,
                    safeMedications: filterMedicationsByAllergies(c.topMedications || [], userAllergies).slice(0, 5)
                })),
                warnings: allWarnings,
                generalRecommendations: generalRecommendations
            };
            
            chatHistory.unshift(chatSummary);
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            
            // Show AI recommendations after a delay
            setTimeout(() => {
                showAIRecommendations();
            }, 2000);
            
            // Show restart option
            setTimeout(() => {
                addMessage("Would you like to start a new assessment?", 'bot', ["Yes, Start Over", "No, I'm Done"]);
            }, 3000);
        }

        function showEmergencyAlert() {
            const alertMessage = "âš ï¸ **EMERGENCY ALERT:** Your symptoms could indicate a serious medical condition. Please seek immediate medical care.";
            addMessage(alertMessage, 'bot');
        }
        
        function handleFeedback(type) {
            if (type === 'yes') {
                addMessage('Thanks for your feedback!', 'bot');
            } else {
                addMessage('We\'re sorry â€” we\'ll keep improving.', 'bot');
            }
            
            // Remove feedback buttons
            const feedbackOptions = document.querySelector('.feedback-options');
            if (feedbackOptions) {
                feedbackOptions.remove();
            }
            
            // Store feedback anonymously
            const feedback = {
                type: type,
                timestamp: new Date().toISOString()
            };
            
            const feedbackHistory = JSON.parse(localStorage.getItem('feedbackHistory') || '[]');
            feedbackHistory.push(feedback);
            localStorage.setItem('feedbackHistory', JSON.stringify(feedbackHistory));
        }

        function calculateDiseaseProbabilities(symptoms, vitalSigns, familyHistory, bmi) {
            const diseaseDatabase = {
                'Acute Bronchitis': {
                    symptoms: ['cough', 'mucus', 'chest congestion', 'fatigue', 'mild fever'],
                    vitalSigns: { temperature: { min: 99, max: 101 } },
                    matchScore: 0,
                    description: 'Inflammation of the bronchial tubes causing cough and mucus production',
                    topMedications: [
                        'Dextromethorphan (Cough Suppressant)',
                        'Guaifenesin (Expectorant)',
                        'Acetaminophen (Tylenol)',
                        'Ibuprofen (Advil)',
                        'Honey (Natural Cough Remedy)'
                    ],
                    warnings: ['See doctor if cough persists more than 2 weeks']
                },
                'Influenza': {
                    symptoms: ['fever', 'body aches', 'fatigue', 'headache', 'cough', 'sore throat'],
                    vitalSigns: { temperature: { min: 100, max: 104 } },
                    matchScore: 0,
                    description: 'Viral infection affecting the respiratory system',
                    topMedications: [
                        'Acetaminophen (Tylenol)',
                        'Ibuprofen (Advil)',
                        'Pseudoephedrine (Decongestant)',
                        'Oseltamivir (Tamiflu)',
                        'Zinc Supplements'
                    ],
                    warnings: ['Seek medical care if symptoms are severe']
                },
                'Common Cold': {
                    symptoms: ['runny nose', 'congestion', 'sneezing', 'sore throat', 'mild cough'],
                    vitalSigns: { temperature: { min: 98, max: 100 } },
                    matchScore: 0,
                    description: 'Viral upper respiratory infection',
                    topMedications: [
                        'Pseudoephedrine (Sudafed)',
                        'Dextromethorphan (Robitussin)',
                        'Chlorpheniramine (Chlor-Trimeton)',
                        'Zinc Lozenges',
                        'Vitamin C Supplements'
                    ],
                    warnings: ['Symptoms typically resolve in 7-10 days']
                },
                'COVID-19': {
                    symptoms: ['fever', 'cough', 'fatigue', 'loss of taste', 'loss of smell', 'shortness of breath'],
                    vitalSigns: { temperature: { min: 100, max: 104 } },
                    matchScore: 0,
                    description: 'Viral respiratory illness caused by SARS-CoV-2',
                    topMedications: [
                        'Acetaminophen (Tylenol)',
                        'Ibuprofen (Advil)',
                        'Paxlovid (Prescription)',
                        'Molnupiravir (Prescription)',
                        'Vitamin D Supplements'
                    ],
                    warnings: ['Consider testing and isolation if suspected']
                },
                'Tension Headache': {
                    symptoms: ['headache', 'pressure', 'tension', 'stress'],
                    vitalSigns: {},
                    matchScore: 0,
                    description: 'Common headache caused by muscle tension',
                    topMedications: [
                        'Acetaminophen (Tylenol)',
                        'Ibuprofen (Advil)',
                        'Aspirin (Bayer)',
                        'Naproxen (Aleve)',
                        'Caffeine + Acetaminophen (Excedrin)'
                    ],
                    warnings: ['See doctor if headaches are severe or frequent']
                },
                'Migraine': {
                    symptoms: ['severe headache', 'nausea', 'sensitivity to light', 'aura'],
                    vitalSigns: {},
                    matchScore: 0,
                    description: 'Neurological condition causing severe headaches',
                    topMedications: [
                        'Sumatriptan (Imitrex)',
                        'Rizatriptan (Maxalt)',
                        'Acetaminophen (Tylenol)',
                        'Ibuprofen (Advil)',
                        'Caffeine + Acetaminophen (Excedrin)'
                    ],
                    warnings: ['Consider prescription medication for frequent migraines']
                },
                'Gastroenteritis': {
                    symptoms: ['nausea', 'vomiting', 'diarrhea', 'stomach pain', 'fever'],
                    vitalSigns: { temperature: { min: 99, max: 102 } },
                    matchScore: 0,
                    description: 'Inflammation of the stomach and intestines',
                    topMedications: [
                        'Loperamide (Imodium)',
                        'Bismuth Subsalicylate (Pepto-Bismol)',
                        'Ondansetron (Zofran)',
                        'Pedialyte (Electrolyte Solution)',
                        'Probiotics (Culturelle)'
                    ],
                    warnings: ['Seek care if dehydration or severe symptoms']
                },
                'Urinary Tract Infection': {
                    symptoms: ['frequent urination', 'burning sensation', 'cloudy urine', 'pelvic pain'],
                    vitalSigns: {},
                    matchScore: 0,
                    description: 'Bacterial infection of the urinary system',
                    topMedications: [
                        'Nitrofurantoin (Macrobid)',
                        'Trimethoprim/Sulfamethoxazole (Bactrim)',
                        'Ciprofloxacin (Cipro)',
                        'Cranberry Supplements',
                        'Phenazopyridine (Azo)'
                    ],
                    warnings: ['Requires antibiotic treatment - see doctor']
                },
                'Allergic Rhinitis': {
                    symptoms: ['sneezing', 'runny nose', 'itchy eyes', 'congestion'],
                    vitalSigns: {},
                    matchScore: 0,
                    description: 'Allergic reaction causing nasal symptoms',
                    topMedications: [
                        'Cetirizine (Zyrtec)',
                        'Loratadine (Claritin)',
                        'Fexofenadine (Allegra)',
                        'Fluticasone (Flonase)',
                        'Ketotifen (Zaditor Eye Drops)'
                    ],
                    warnings: ['Avoid allergens and consider allergy testing']
                },
                'Anxiety': {
                    symptoms: ['worry', 'nervousness', 'rapid heartbeat', 'sweating', 'trouble concentrating'],
                    vitalSigns: { pulse: { min: 80, max: 120 } },
                    matchScore: 0,
                    description: 'Mental health condition causing excessive worry',
                    topMedications: [
                        'Sertraline (Zoloft)',
                        'Escitalopram (Lexapro)',
                        'Buspirone (Buspar)',
                        'Alprazolam (Xanax)',
                        'L-Theanine Supplements'
                    ],
                    warnings: ['Consider professional mental health support']
                },
                'Depression': {
                    symptoms: ['sadness', 'hopelessness', 'fatigue', 'sleep changes', 'appetite changes'],
                    vitalSigns: {},
                    matchScore: 0,
                    description: 'Mental health condition affecting mood and behavior',
                    topMedications: [
                        'Sertraline (Zoloft)',
                        'Escitalopram (Lexapro)',
                        'Fluoxetine (Prozac)',
                        'Bupropion (Wellbutrin)',
                        'Omega-3 Supplements'
                    ],
                    warnings: ['Professional mental health evaluation recommended']
                },
                'Hypertension': {
                    symptoms: ['headache', 'dizziness', 'shortness of breath'],
                    vitalSigns: { bloodPressure: { systolic: { min: 140, max: 200 }, diastolic: { min: 90, max: 120 } } },
                    matchScore: 0,
                    description: 'High blood pressure requiring medical management',
                    topMedications: [
                        'Lisinopril (Zestril)',
                        'Amlodipine (Norvasc)',
                        'Metoprolol (Lopressor)',
                        'Hydrochlorothiazide (HCTZ)',
                        'Losartan (Cozaar)'
                    ],
                    warnings: ['Requires medical evaluation and treatment']
                },
                'Diabetes': {
                    symptoms: ['frequent urination', 'excessive thirst', 'fatigue', 'blurred vision'],
                    vitalSigns: { glucose: { min: 126, max: 400 } },
                    matchScore: 0,
                    description: 'Metabolic disorder affecting blood sugar regulation',
                    topMedications: [
                        'Metformin (Glucophage)',
                        'Glipizide (Glucotrol)',
                        'Insulin (Various types)',
                        'Sitagliptin (Januvia)',
                        'Empagliflozin (Jardiance)'
                    ],
                    warnings: ['Requires medical diagnosis and treatment']
                }
            };
            
            const symptomsArray = symptoms.toLowerCase().split(' ');
            const matches = [];
            
            // Calculate match scores for each disease
            for (const [disease, data] of Object.entries(diseaseDatabase)) {
                let matchCount = 0;
                let totalSymptoms = data.symptoms.length;
                
                // Count matching symptoms
                for (const symptom of data.symptoms) {
                    if (symptomsArray.some(s => symptom.includes(s) || s.includes(symptom))) {
                        matchCount++;
                    }
                }
                
                // Calculate percentage match
                const matchPercentage = Math.round((matchCount / totalSymptoms) * 100);
                
                // Check vital signs if available
                let vitalSignsBonus = 0;
                if (vitalSigns && Object.keys(vitalSigns).length > 0) {
                    for (const [vital, range] of Object.entries(data.vitalSigns)) {
                        if (vitalSigns[vital]) {
                            const value = parseFloat(vitalSigns[vital]);
                            if (range.min && range.max && value >= range.min && value <= range.max) {
                                vitalSignsBonus += 10; // Bonus for matching vital signs
                            }
                        }
                    }
                }
                
                // Only include diseases with at least 20% match
                if (matchPercentage >= 20) {
                    const finalScore = Math.min(100, matchPercentage + vitalSignsBonus);
                    
                    // Determine confidence level
                    let confidence = 'low';
                    if (finalScore >= 70) confidence = 'high';
                    else if (finalScore >= 50) confidence = 'medium';
                    
                    matches.push({
                        disease: disease,
                        percentage: finalScore,
                        confidence: confidence,
                        description: data.description,
                        topMedications: data.topMedications,
                        warnings: data.warnings
                    });
                }
            }
            
            // Sort by match percentage (highest first)
            matches.sort((a, b) => b.percentage - a.percentage);
            
            return matches;
        }

        function filterMedicationsByAllergies(medications, allergies) {
            return medications.filter(med => {
                return !allergies.some(allergy => 
                    med.toLowerCase().includes(allergy.toLowerCase())
                );
            });
        }

        // Feedback System Functions
        function showFeedbackPrompt() {
            // Only show feedback once per session
            if (feedbackShown) {
                return;
            }
            
            feedbackShown = true;
            
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'feedback-prompt';
            feedbackDiv.innerHTML = `
                <div class="feedback-content">
                    <h4>Was this helpful?</h4>
                    <div class="feedback-buttons">
                        <button class="feedback-btn feedback-positive" onclick="submitFeedback('positive')">
                            ðŸ‘ Yes
                        </button>
                        <button class="feedback-btn feedback-negative" onclick="submitFeedback('negative')">
                            ðŸ‘Ž No
                        </button>
                    </div>
                </div>
            `;
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.appendChild(feedbackDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function submitFeedback(type) {
            // Remove the feedback prompt
            const feedbackPrompt = document.querySelector('.feedback-prompt');
            if (feedbackPrompt) {
                feedbackPrompt.remove();
            }
            
            // Show thank you message
            let thankYouMessage = '';
            if (type === 'positive') {
                thankYouMessage = "Thanks for your feedback!";
            } else {
                thankYouMessage = "We're sorry â€” we'll keep improving.";
                // Show optional comment box for negative feedback
                showCommentBox();
            }
            
            addMessage(thankYouMessage, 'bot');
            
            // Store feedback anonymously
            storeFeedback(type);
        }

        function showCommentBox() {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'feedback-comment';
            commentDiv.innerHTML = `
                <div class="comment-content">
                    <p>Would you like to share additional comments to help us improve?</p>
                    <textarea class="comment-textarea" placeholder="Your feedback helps us improve our service... (optional)"></textarea>
                    <div class="comment-buttons">
                        <button class="btn btn-primary btn-small" onclick="submitComment()">Submit</button>
                        <button class="btn btn-secondary btn-small" onclick="skipComment()">Skip</button>
                    </div>
                </div>
            `;
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.appendChild(commentDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function submitComment() {
            const commentTextarea = document.querySelector('.comment-textarea');
            const comment = commentTextarea ? commentTextarea.value.trim() : '';
            
            if (comment) {
                // Store the comment with the feedback
                storeFeedback('negative', comment);
                addMessage("Thank you for your detailed feedback!", 'bot');
            }
            
            // Remove comment box
            const commentDiv = document.querySelector('.feedback-comment');
            if (commentDiv) {
                commentDiv.remove();
            }
        }

        function skipComment() {
            // Remove comment box
            const commentDiv = document.querySelector('.feedback-comment');
            if (commentDiv) {
                commentDiv.remove();
            }
        }

        function storeFeedback(type, comment = '') {
            const feedback = {
                timestamp: new Date().toISOString(),
                type: type,
                comment: comment,
                sessionId: Date.now(), // Anonymous session identifier
                symptoms: userSymptoms.question0 || '',
                detectedCondition: detectedCondition || 'none'
            };
            
            // Store in localStorage
            const feedbackHistory = JSON.parse(localStorage.getItem('feedbackHistory') || '[]');
            feedbackHistory.push(feedback);
            localStorage.setItem('feedbackHistory', JSON.stringify(feedbackHistory));
            
            // Log to console for development (remove in production)
            console.log('Feedback submitted:', feedback);
        }

        function handleRestartOption(choice) {
            if (choice === "Yes, Start Over") {
                // Reset chatbot state
                currentQuestion = 0;
                userSymptoms = {};
                emergencyFlag = false;
                followUpQuestions = [];
                conversationPath = 'general';
                feedbackShown = false; // Reset feedback flag for new session
                
                // Clear chat messages
                document.getElementById('chatMessages').innerHTML = '';
                
                // Restart chatbot
                initializeChatbot();
            } else {
                addMessage("Thank you for using DiagKnows. Take care!", 'bot');
            }
        }

        // Medical Upload Functions
        function openCamera() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        video.srcObject = stream;
                        video.style.display = 'block';
                        
                        // Add capture button
                        const captureBtn = document.createElement('button');
                        captureBtn.className = 'btn btn-primary';
                        captureBtn.textContent = 'ðŸ“¸ Capture Photo';
                        captureBtn.onclick = capturePhoto;
                        video.parentNode.appendChild(captureBtn);
                    })
                    .catch(function(err) {
                        alert('Camera access denied. Please allow camera permissions or use file upload instead.');
                    });
            } else {
                alert('Camera not available. Please use file upload instead.');
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg');
            showUploadPreview(imageData, 'camera');
            
            // Stop camera stream
            const stream = video.srcObject;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            video.style.display = 'none';
            video.parentNode.querySelector('button').remove();
        }

        function openFileUpload() {
            document.getElementById('medicalFileUpload').click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    showUploadPreview(e.target.result, 'file');
                };
                reader.readAsDataURL(file);
            }
        }

        function showUploadPreview(data, type) {
            const preview = document.getElementById('uploadPreview');
            const content = document.getElementById('previewContent');
            
            if (type === 'camera' || file.type.startsWith('image/')) {
                content.innerHTML = `<img src="${data}" alt="Medical Record">`;
            } else {
                content.innerHTML = `<p>ðŸ“„ File uploaded: ${file.name}</p>`;
            }
            
            preview.style.display = 'block';
            
            // Store in localStorage for form submission
            localStorage.setItem('medicalRecordData', data);
        }

        function removeUpload() {
            document.getElementById('uploadPreview').style.display = 'none';
            document.getElementById('medicalFileUpload').value = '';
            localStorage.removeItem('medicalRecordData');
        }

        function scrollToRecommendedItems() {
            const shopSection = document.getElementById('shop');
            if (shopSection) {
                shopSection.scrollIntoView({ behavior: 'smooth' });
                
                // Highlight recommended items
                setTimeout(() => {
                    const recommendedItems = document.querySelectorAll('.medicine-card.recommended');
                    recommendedItems.forEach(item => {
                        item.style.border = '2px solid var(--primary)';
                        item.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.3)';
                    });
                }, 500);
            }
        }

        function getSafeMedications(conditions) {
            const safeMeds = [];
            const allMeds = ['Tylenol', 'Ibuprofen', 'Cough Syrup', 'Antihistamines', 'Thermometer'];
            
            allMeds.forEach(med => {
                const medLower = med.toLowerCase();
                let isSafe = true;
                
                // Check against user allergies
                if (userAllergies && userAllergies.length > 0) {
                    for (const allergy of userAllergies) {
                        if (medLower.includes(allergy.toLowerCase())) {
                            isSafe = false;
                            break;
                        }
                    }
                }
                
                if (isSafe) {
                    safeMeds.push(med);
                }
            });
            
            return safeMeds.slice(0, 3); // Return top 3 safe medications
        }

        // BMI category helper function
        function getBMICategory(bmi) {
            if (bmi < 18.5) return 'Underweight';
            if (bmi < 25) return 'Normal weight';
            if (bmi < 30) return 'Overweight';
            return 'Obese';
        }

        function addMessage(content, sender, options = null) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Check if this exact message was just added to prevent duplicates
            const lastMessage = messagesContainer.lastElementChild;
            if (lastMessage && lastMessage.classList.contains(sender)) {
                const lastContent = lastMessage.querySelector('.message-content');
                if (lastContent && lastContent.textContent.trim() === content.trim()) {
                    return; // Don't add duplicate message
                }
            }
            
            // Check if this is a bot question that was already asked
            if (sender === 'bot' && lastQuestionAsked === content.trim()) {
                return; // Prevent duplicate question display
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            let messageContent = '';
            if (sender === 'bot') {
                messageContent = `
                    <div class="message-header">
                        <span class="bot-label">DiagKnows AI</span>
                        <span class="message-time">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="message-content">
                        ${content.replace(/\n/g, '<br>')}
                    </div>
                `;
            } else {
                messageContent = `
                    <div class="message-header">
                        <span class="user-label">You</span>
                        <span class="message-time">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="message-content">
                        ${content}
                    </div>
                `;
            }
            
            messageDiv.innerHTML = messageContent;
            messagesContainer.appendChild(messageDiv);
            
            // Store the last question asked if it's a bot message
            if (sender === 'bot') {
                lastQuestionAsked = content.trim();
            }
            
            // Add quick options if provided
            if (options && sender === 'bot') {
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'quick-options';
                optionsDiv.innerHTML = options.map(option => 
                    `<button class="quick-option-btn" onclick="handleQuickOption('${option}')">${option}</button>`
                ).join('');
                messageDiv.appendChild(optionsDiv);
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-header">
                    <span class="bot-label">DiagKnows AI</span>
                    <span class="message-time">${new Date().toLocaleTimeString()}</span>
                </div>
                <div class="message-content">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function getQuickOptionsForQuestion(questionIndex) {
            const quickOptionsMap = {
                0: ["Fever", "Cough", "Headache", "Fatigue", "Stomach Pain", "Chest Pain"],
                1: ["Less than 24 hours", "1-3 days", "3-7 days", "More than a week"],
                2: ["None", "Diabetes", "Heart Disease", "Asthma", "Hypertension"],
                3: ["None", "Pain medication", "Blood pressure meds", "Diabetes medication"],
                4: ["None", "Penicillin", "Ibuprofen", "Aspirin", "Sulfa drugs"],
                5: ["Skip", "Enter values"],
                6: ["None", "High blood pressure", "Diabetes", "Heart disease", "Cancer"],
                7: ["No", "Yes, mildly", "Yes, moderately", "Yes, severely"],
                8: ["Up to date", "Need COVID vaccine", "Need flu shot"],
                9: ["Normal", "Poor sleep", "Loss of appetite", "Low energy", "All of the above"]
            };
            return quickOptionsMap[questionIndex] || [];
        }

        function handleQuickOption(option) {
            // Remove typing indicator if present
            removeTypingIndicator();
            
            // Check if this is a restart option
            if (option === "Yes, Start Over" || option === "No, I'm Done") {
                handleRestartOption(option);
                return;
            }
            
            // Block if we're in vital signs step
            if (isVitalSignsStep) {
                return;
            }
            
            // Add user's response to chat
            addMessage(option, 'user');
            
            // Store the response
            userSymptoms[`question${currentQuestion}`] = option;
            
            // Special handling for sleep/appetite/energy question (question 9)
            if (currentQuestion === 9) {
                sleepEnergyQuestionAnswered = true; // Mark as answered
                sleepAppetiteEnergyAnswered = true; // Mark as answered
                sleepAppetiteEnergyAsked = true; // Mark as asked
                sleepAppetiteEnergyQuestionShown = true; // Mark as shown
                sleepAppetiteEnergyAlreadyAsked = true; // Mark as already asked
                
                // Remove the buttons after selection
                const existingOptions = document.querySelectorAll('.quick-options');
                existingOptions.forEach(option => option.remove());
            }
            
            // Process the response
            setTimeout(() => {
                processChatbotResponse(option);
            }, 500);
        }



        function showSevereSymptomsAlert() {
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger';
            alert.innerHTML = `
                <div style="font-weight: bold; font-size: 1.2em; margin-bottom: 0.5rem; text-align: center;">
                    âš ï¸ Your symptoms may require emergency care. Contact a doctor immediately.
                </div>
                <div style="font-size: 0.9em; text-align: center;">
                    â€¢ Call emergency services if experiencing chest pain or difficulty breathing<br>
                    â€¢ Seek immediate medical attention for high fever or confusion<br>
                    â€¢ Do not delay treatment for severe symptoms<br>
                    â€¢ Consider visiting an urgent care facility
                </div>
            `;
            document.getElementById('chatMessages').appendChild(alert);
        }

        // Save chat session to localStorage
        function saveChatSession(symptoms, conditions) {
            const session = {
                timestamp: new Date().toISOString(),
                symptoms: symptoms,
                conditions: conditions,
                userSymptoms: userSymptoms
            };
            
            const sessions = JSON.parse(localStorage.getItem('chatSessions') || '[]');
            sessions.unshift(session);
            localStorage.setItem('chatSessions', JSON.stringify(sessions.slice(0, 10))); // Keep last 10 sessions
        }

        // Daily Check-in Functions
        function loadCheckinHistory() {
            const history = JSON.parse(localStorage.getItem('checkins') || '[]');
            const historyContainer = document.getElementById('checkinHistory');
            
            if (history.length === 0) {
                historyContainer.innerHTML = '<p>No previous check-ins found.</p>';
                return;
            }
            
            historyContainer.innerHTML = history.map(checkin => `
                <div class="check-in-item">
                    <strong>${new Date(checkin.timestamp).toLocaleDateString()}</strong><br>
                    Mood: ${checkin.mood}/10<br>
                    Symptoms: ${checkin.symptoms.join(', ') || 'None'}<br>
                    Notes: ${checkin.notes || 'None'}
                </div>
            `).join('');
        }

        // Dashboard Functions
        function loadDashboard() {
            loadChatHistory();
            loadCheckinLogs();
        }

        function loadChatHistory() {
            const sessions = JSON.parse(localStorage.getItem('chatSessions') || '[]');
            const container = document.getElementById('chatHistoryList');
            
            if (sessions.length === 0) {
                container.innerHTML = '<p>No chat history found.</p>';
                return;
            }
            
            container.innerHTML = sessions.map(session => `
                <div class="check-in-item">
                    <strong>${new Date(session.timestamp).toLocaleDateString()}</strong><br>
                    Conditions: ${session.conditions.join(', ')}<br>
                    <small>Click to view details</small>
                </div>
            `).join('');
        }

        function loadCheckinLogs() {
            const checkins = JSON.parse(localStorage.getItem('checkins') || '[]');
            const container = document.getElementById('checkinLogsList');
            
            if (checkins.length === 0) {
                container.innerHTML = '<p>No check-in logs found.</p>';
                return;
            }
            
            container.innerHTML = checkins.map(checkin => `
                <div class="check-in-item">
                    <strong>${new Date(checkin.timestamp).toLocaleDateString()}</strong><br>
                    Mood: ${checkin.mood}/10<br>
                    Symptoms: ${checkin.symptoms.join(', ') || 'None'}
                </div>
            `).join('');
        }

        // Profile Functions
        function loadProfile() {
            const user = currentUser || JSON.parse(localStorage.getItem('currentUser') || '{}');
            const container = document.getElementById('profileInfo');
            
            // Calculate BMI if height and weight are available
            let bmiInfo = '';
            if (user.height && user.weight) {
                const heightInches = user.height;
                const weightLbs = user.weight;
                const bmi = ((weightLbs * 703) / (heightInches * heightInches)).toFixed(1);
                bmiInfo = `
                    <div class="profile-item">
                        <strong>BMI:</strong> ${bmi} (${getBMICategory(bmi)})
                    </div>
                `;
            }
            
            // Load current location for form
            const currentLocation = localStorage.getItem('userLocation') || user.location || '';
            document.getElementById('updateLocation').value = currentLocation;
            
            // Show premium location fields if user is premium
            const premiumFields = document.getElementById('premiumLocationFields');
            if (isPremium) {
                premiumFields.classList.add('show');
            }
            
            // Display allergies
            const allergiesDisplay = userAllergies.length > 0 ? 
                userAllergies.join(', ') : 'None recorded';
            
            container.innerHTML = `
                <div class="profile-item">
                    <strong>Username:</strong> ${user.username || 'Not set'}
                </div>
                <div class="profile-item">
                    <strong>Name:</strong> ${user.name || 'Not set'}
                </div>
                <div class="profile-item">
                    <strong>Age:</strong> ${user.age || 'Not set'} years
                </div>
                <div class="profile-item">
                    <strong>Height:</strong> ${user.height || 'Not set'} inches
                </div>
                <div class="profile-item">
                    <strong>Weight:</strong> ${user.weight || 'Not set'} lbs
                </div>
                ${bmiInfo}
                <div class="profile-item">
                    <strong>Email:</strong> ${user.email || 'Not set'}
                </div>
                <div class="profile-item">
                    <strong>Location:</strong> ${user.location || 'Not set'}
                </div>
                <div class="profile-item">
                    <strong>Phone:</strong> ${user.phone || 'Not set'}
                </div>
                <div class="profile-item">
                    <strong>Language:</strong> ${user.language || 'English'}
                </div>
                <div class="profile-item">
                    <strong>Premium:</strong> ${isPremium ? 'Yes' : 'No'}
                </div>
                <div class="profile-item">
                    <strong>Allergies:</strong> ${allergiesDisplay}
                </div>
                <div class="profile-item">
                    <strong>Medical History:</strong> ${user.medical || 'None provided'}
                </div>
            `;
        }

        function editProfile() {
            showAlert('Profile editing feature coming soon!', 'warning');
        }

        // Video Functions
        function loadVideos() {
            const container = document.getElementById('videosContent');
            
            if (!isPremium) {
                container.innerHTML = `
                    <div class="text-center">
                        <h3>ðŸ”’ Premium Content</h3>
                        <p>Subscribe to Premium to access exclusive health videos.</p>
                        <div class="btn-group btn-group-center">
                            <button class="btn btn-primary btn-large" onclick="startPremiumTrial()">Start Free Trial</button>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="video-grid">
                        <div class="video-item">
                            <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allowfullscreen></iframe>
                            <div class="video-info">
                                <h4>Health & Wellness Tips</h4>
                                <p>Learn about maintaining good health habits.</p>
                            </div>
                        </div>
                        <div class="video-item">
                            <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allowfullscreen></iframe>
                            <div class="video-info">
                                <h4>Exercise for Beginners</h4>
                                <p>Simple exercises you can do at home.</p>
                            </div>
                        </div>
                        <div class="video-item">
                            <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allowfullscreen></iframe>
                            <div class="video-info">
                                <h4>Nutrition Basics</h4>
                                <p>Understanding healthy eating habits.</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Dark Mode Toggle
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            localStorage.setItem('darkMode', isDarkMode);
        }

        // Language Change
        function changeLanguage(lang) {
            if (!isLoggedIn) {
                showAuthModal();
                return;
            }
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            updateTranslations();
        }

        function updateTranslations() {
            const t = translations[currentLanguage];
            // Update key elements with translations
            document.querySelector('h1').textContent = t.welcome;
            // Add more translation updates as needed
        }

        // Voice Input
        function toggleVoiceInput() {
            if (!isLoggedIn) {
                showAuthModal();
                return;
            }
            
            const voiceBtn = document.getElementById('voiceBtn');
            
            if (!recognition) {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    
                    recognition.onstart = () => {
                        voiceBtn.classList.add('recording');
                        voiceBtn.textContent = 'ðŸ”´';
                    };
                    
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        document.getElementById('chatInput').value = transcript;
                        voiceBtn.classList.remove('recording');
                        voiceBtn.textContent = 'ðŸŽ™ï¸';
                    };
                    
                    recognition.onerror = () => {
                        voiceBtn.classList.remove('recording');
                        voiceBtn.textContent = 'ðŸŽ™ï¸';
                        showAlert('Voice recognition error. Please try again.', 'danger');
                    };
                    
                    recognition.onend = () => {
                        voiceBtn.classList.remove('recording');
                        voiceBtn.textContent = 'ðŸŽ™ï¸';
                    };
                } else {
                    showAlert('Voice recognition not supported in this browser.', 'warning');
                    return;
                }
            }
            
            if (voiceBtn.classList.contains('recording')) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        // Push Notifications
        function startNotifications() {
            if (isLoggedIn && document.getElementById('settingsNotifications') && document.getElementById('settingsNotifications').checked) {
                notificationInterval = setInterval(() => {
                    const messages = [
                        "Time to check your symptoms!",
                        "Remember to take your meds!",
                        "How are you feeling today?",
                        "Don't forget your daily check-in!"
                    ];
                    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                    showNotification(randomMessage);
                }, 120000); // Every 2 minutes
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Premium features
        function startPremiumTrial() {
            isPremium = true;
            showAlert('Premium trial started! Enjoy 7 days of advanced features.', 'success');
            document.getElementById('premiumBanner').style.display = 'none';
        }

        function upgradeToPremium() {
            isPremium = true;
            closeModal();
            showAlert('Welcome to Premium!', 'success');
        }

        function closeModal() {
            document.getElementById('premiumModal').style.display = 'none';
        }

        // Utility functions
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            document.querySelector('.container').insertBefore(alert, document.querySelector('.container').firstChild);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function toggleVoice() {
            showAlert('Voice feature coming soon!', 'warning');
        }

        function translateInput() {
            showAlert('Translation feature coming soon!', 'warning');
        }

        function saveSettings() {
            // Update family plan checkbox
            const familyPlanCheckbox = document.getElementById('settingsFamilyPlan');
            if (familyPlanCheckbox) {
                familyPlanCheckbox.checked = isFamilyPlan;
            }
            
            showAlert('Settings saved!', 'success');
        }

        // File upload handling
        document.getElementById('medicalFile').addEventListener('change', function(e) {
            if (!isLoggedIn) {
                showAuthModal();
                return;
            }
            
            if (!isPremium) {
                document.getElementById('premiumModal').style.display = 'block';
                return;
            }
            
            const file = e.target.files[0];
            if (file) {
                showAlert('Medical image uploaded! AI analysis in progress...', 'success');
                setTimeout(() => {
                    showAlert('Analysis complete: Document appears to be a prescription for common medication.', 'success');
                }, 2000);
            }
        });

        // Camera scan handling


        // Enter key for chat
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Planning form handlers
        document.getElementById('appointmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const doctor = document.getElementById('appointmentDoctor').value.trim();
            const date = document.getElementById('appointmentDate').value;
            const time = document.getElementById('appointmentTime').value;
            const notes = document.getElementById('appointmentNotes').value.trim();
            
            if (!doctor || !date || !time) {
                showAlert('Please fill in all required fields.', 'danger');
                return;
            }
            
            const appointment = {
                doctor: doctor,
                date: date,
                time: time,
                notes: notes
            };
            
            appointments.push(appointment);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            displayAppointments();
            this.reset();
            showAlert('Appointment added successfully!', 'success');
        });

        document.getElementById('medicationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('medicationName').value.trim();
            const dosage = document.getElementById('medicationDosage').value.trim();
            const time = document.getElementById('medicationTime').value;
            const frequency = document.getElementById('medicationFrequency').value;
            
            if (!name || !dosage || !time) {
                showAlert('Please fill in all required fields.', 'danger');
                return;
            }
            
            const medication = {
                name: name,
                dosage: dosage,
                time: time,
                frequency: frequency
            };
            
            medications.push(medication);
            localStorage.setItem('medications', JSON.stringify(medications));
            
            displayMedications();
            this.reset();
            showAlert('Medication reminder added successfully!', 'success');
        });

        document.getElementById('vaccinationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('vaccineName').value.trim();
            const date = document.getElementById('vaccineDate').value;
            const type = document.getElementById('vaccineType').value;
            
            if (!name || !date) {
                showAlert('Please fill in all required fields.', 'danger');
                return;
            }
            
            const vaccination = {
                name: name,
                date: date,
                type: type
            };
            
            vaccinations.push(vaccination);
            localStorage.setItem('vaccinations', JSON.stringify(vaccinations));
            
            displayVaccinations();
            this.reset();
            showAlert('Vaccination record added successfully!', 'success');
        });

        // Vaccination card upload handler
        document.getElementById('vaccinationCard').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.getElementById('vaccinationPreview');
                    const previewImg = document.getElementById('vaccinationPreviewImg');
                    
                    previewImg.src = event.target.result;
                    preview.style.display = 'block';
                    
                    showAlert('Vaccination card uploaded successfully!', 'success');
                };
                reader.readAsDataURL(file);
            }
        });

        // Check-in form handling
        document.getElementById('checkinForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const mood = document.getElementById('moodSlider').value;
            const symptoms = [];
            const checkboxes = document.querySelectorAll('.symptom-item input[type="checkbox"]:checked');
            checkboxes.forEach(cb => symptoms.push(cb.id));
            const notes = document.getElementById('checkinNotes').value;
            
            const checkin = {
                timestamp: new Date().toISOString(),
                mood: parseInt(mood),
                symptoms: symptoms,
                notes: notes
            };
            
            const checkins = JSON.parse(localStorage.getItem('checkins') || '[]');
            checkins.unshift(checkin);
            localStorage.setItem('checkins', JSON.stringify(checkins.slice(0, 30))); // Keep last 30 check-ins
            
            showAlert('Check-in saved successfully!', 'success');
            this.reset();
            document.getElementById('moodValue').textContent = '5 - Neutral';
            loadCheckinHistory();
        });

        // Mood slider update
        document.getElementById('moodSlider').addEventListener('input', function() {
            const value = this.value;
            const labels = ['Very Bad', 'Bad', 'Poor', 'Fair', 'Neutral', 'Good', 'Very Good', 'Great', 'Excellent', 'Perfect'];
            document.getElementById('moodValue').textContent = `${value} - ${labels[value]}`;
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved preferences
            isDarkMode = localStorage.getItem('darkMode') === 'true';
            currentLanguage = localStorage.getItem('language') || 'en';
            
            // Load authentication state
            isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            if (isLoggedIn) {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    isPremium = currentUser.isPremium || false;
                    isFamilyPlan = currentUser.isFamilyPlan || false;
                }
                
                // Load premium status
                const savedPremium = localStorage.getItem('isPremium');
                if (savedPremium === 'true') {
                    isPremium = true;
                }
                
                // Load family plan status
                const savedFamilyPlan = localStorage.getItem('isFamilyPlan');
                if (savedFamilyPlan === 'true') {
                    isFamilyPlan = true;
                }
            }
            
            // Load registered users
            registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            
            // Apply dark mode if saved
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            }
            
            // Set language selector
            document.getElementById('languageSelector').value = currentLanguage;
            
            // Update navigation based on login state
            updateNavigation();
            
            // Update premium features visibility
            updatePremiumFeatures();
            
            // Load family members if on family plan
            if (isFamilyPlan) {
                familyMembers = JSON.parse(localStorage.getItem('familyMembers') || '[]');
            }
            
            // Load planning data
            appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            medications = JSON.parse(localStorage.getItem('medications') || '[]');
                                    vaccinations = JSON.parse(localStorage.getItem('vaccinations') || '[]');
            
            // Load shop data
            cart = JSON.parse(localStorage.getItem('cart') || '[]');
            
            // Load delivery data
            shippingHistory = JSON.parse(localStorage.getItem('shippingHistory') || '[]');
            
            // Load user allergies
            userAllergies = JSON.parse(localStorage.getItem('userAllergies') || '[]');
            
            // Load chat history
            chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            
            // Optimize layout if logged in
            if (isLoggedIn) {
                optimizePostLoginLayout();
            }
            
            // Start notifications only if logged in
            if (isLoggedIn) {
                startNotifications();
            }
            
            // Show appropriate section
            if (isLoggedIn) {
                showSection('chatbot');
            } else {
                showSection('home');
            }
        });
    </script>
</body>
</html> 
